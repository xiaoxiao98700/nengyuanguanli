# 标签切换异常问题修复

## 问题描述
分项能耗统计、分类能耗统计等页面的标签切换不正常，点击一次可能触发多次切换或者没有反应。

## 问题原因
**事件监听器重复绑定**

当页面被多次加载或初始化时，`setupEventListeners()` 函数会被多次调用，导致：
- 同一个按钮被绑定了多个点击事件
- 点击一次会触发多次回调
- 标签切换行为异常

```javascript
// 问题代码示例
function setupEventListeners() {
    document.querySelectorAll('.item-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            // 每次调用都会添加一个新的监听器
            // 第一次：绑定1个监听器
            // 第二次：绑定2个监听器（总共3个）
            // 第三次：绑定3个监听器（总共6个）
            // ...点击一次会触发多次
        });
    });
}
```

## 解决方案
在 `setupEventListeners()` 函数开头添加**防重复绑定检查**：

```javascript
function setupEventListeners() {
    // 防止重复绑定
    if (window.__xxxEventsInitialized) {
        return;  // 如果已经初始化过，直接返回
    }
    window.__xxxEventsInitialized = true;  // 标记为已初始化
    
    // 原有的事件绑定代码...
}
```

## 已修复的文件

### 1. energy-statistics-itemized.html（分项能耗统计）
```javascript
function setupEventListeners() {
    if (window.__itemizedEnergyEventsInitialized) {
        return;
    }
    window.__itemizedEnergyEventsInitialized = true;
    // ...
}
```

### 2. energy-statistics-categorized.html（分类能耗统计）
```javascript
function setupEventListeners() {
    if (window.__categorizedEnergyEventsInitialized) {
        return;
    }
    window.__categorizedEnergyEventsInitialized = true;
    // ...
}
```

### 3. energy-statistics-calendar.html（能耗日历）
```javascript
function setupEventListeners() {
    if (window.__calendarEventsInitialized) {
        return;
    }
    window.__calendarEventsInitialized = true;
    // ...
}
```

## 其他页面的情况
以下页面已经有防重复绑定机制，不需要修改：
- ✅ energy-analysis-equipment-load.html（使用 `dataset.bound` 检查）
- ✅ energy-analysis-energy-loss.html（使用 `dataset.bound` 检查）

## 测试验证

### 测试步骤
1. 刷新浏览器（F5）
2. 进入"能源统计" → "分项能耗统计"
3. 点击顶部的标签页（照明、空调、动力、特殊、水泵、主机）
4. 观察切换是否正常：
   - ✅ 点击一次只触发一次切换
   - ✅ 标签高亮状态正确
   - ✅ 下方数据正确更新

### 预期结果
- ✅ 标签切换响应正常，一次点击一次切换
- ✅ 不会出现点击无反应或多次触发的情况
- ✅ 数据正确刷新

## 技术要点

### 为什么用 window 对象？
- `window` 是全局对象，整个页面共享
- 用它存储标志位可以确保跨函数、跨调用都能访问
- 即使页面被多次初始化，标志位仍然保持

### 为什么不用其他方案？
1. **不用 `removeEventListener`**：需要保存函数引用，代码复杂
2. **不用 `once: true` 选项**：只能执行一次后就失效，不适合需要长期使用的监听器
3. **不用闭包变量**：作用域限制，无法跨多次函数调用共享

---

**修复时间**：2025-11-15
**修复状态**：✅ 已完成
**影响范围**：能源统计模块的3个页面

