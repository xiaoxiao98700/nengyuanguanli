<div class="hierarchy-energy-monitoring-container">
    <style>
        .hierarchy-energy-monitoring-container {
            padding: 24px 28px 48px;
            background-color: #0f1e2d;
            min-height: 100vh;
            color: #e0e6ed;
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Source Han Sans', Arial, sans-serif;
        }

        .page-header {
            margin-bottom: 28px;
        }

        .page-title {
            font-size: 24px;
            color: #00bcd4;
            margin: 0 0 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .page-description {
            color: #a7bed3;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
        }

        .filter-panel {
            background: rgba(16, 33, 54, 0.9);
            border: 1px solid #24415c;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .filter-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 13px;
            color: #8aa0bc;
        }

        .filter-select,
        .filter-input {
            background-color: #152535;
            border: 1px solid #2f4a66;
            border-radius: 10px;
            padding: 10px 12px;
            color: #e6ecf3;
            font-size: 14px;
            transition: border 0.2s ease;
        }

        .filter-select:focus,
        .filter-input:focus {
            outline: none;
            border-color: #00bcd4;
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.2);
        }

        .timeframe-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .timeframe-button {
            border: none;
            background: #1d3247;
            color: #c7d5e5;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .timeframe-button.active {
            background: linear-gradient(120deg, #00bcd4, #5ad8ff);
            color: #052030;
            font-weight: 600;
        }

        .apply-filter-btn {
            margin-left: auto;
            background: linear-gradient(135deg, #00bcd4, #35d8ff);
            border: none;
            color: #052030;
            padding: 10px 24px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .apply-filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0, 188, 212, 0.3);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #8aa0bc;
            margin-bottom: 16px;
        }

        .breadcrumb span {
            color: #e6ecf3;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: #10253a;
            border: 1px solid rgba(0, 188, 212, 0.15);
            border-radius: 16px;
            padding: 18px;
            position: relative;
            overflow: hidden;
        }

        .kpi-card::after {
            content: '';
            position: absolute;
            inset: 1px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            pointer-events: none;
        }

        .kpi-label {
            font-size: 13px;
            color: #8aa0bc;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-value {
            font-size: 28px;
            font-weight: 600;
            color: #ffffff;
        }

        .kpi-unit {
            font-size: 14px;
            color: #8aa0bc;
            margin-left: 4px;
        }

        .kpi-trend {
            margin-top: 8px;
            font-size: 12px;
        }

        .trend-up {
            color: #00e676;
        }

        .trend-down {
            color: #ff6e78;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
        }

        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(13, 31, 47, 0.95);
            border: 1px solid #1f3a52;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .card-title {
            font-size: 16px;
            margin: 0 0 12px;
            color: #dfe9f4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trend-chart {
            width: 100%;
            height: 220px;
        }

        .breakdown-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .breakdown-item {
            background: #132437;
            border: 1px solid #1f3a52;
            border-radius: 12px;
            padding: 12px;
        }

        .breakdown-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .progress-bar {
            height: 8px;
            border-radius: 999px;
            background: #1d3247;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(120deg, #00bcd4, #35d8ff);
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            margin-top: 12px;
        }

        .device-table thead {
            background: #132437;
        }

        .device-table th,
        .device-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #1f3a52;
            text-align: left;
        }

        .pill-group {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .pill-option {
            border: 1px solid #1f3a52;
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 12px;
            cursor: pointer;
            color: #8aa0bc;
            transition: all 0.2s ease;
        }

        .pill-option.active {
            background: linear-gradient(120deg, #00bcd4, #35d8ff);
            color: #052030;
            border-color: transparent;
        }

        .energy-type-pills {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .energy-type-pill {
            border: 1px solid rgba(0, 188, 212, 0.3);
            border-radius: 999px;
            padding: 8px 18px;
            background: rgba(0, 188, 212, 0.05);
            color: #9cd9e7;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .energy-type-pill.active {
            background: linear-gradient(120deg, #00bcd4, #35d8ff);
            color: #052030;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(0, 188, 212, 0.25);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8aa0bc;
        }

        .area-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .area-card {
            background: rgba(11, 28, 44, 0.95);
            border: 1px solid rgba(0, 188, 212, 0.15);
            border-radius: 16px;
            padding: 18px;
            position: relative;
            overflow: hidden;
        }

        .area-card.active {
            border-color: #00bcd4;
            box-shadow: 0 12px 25px rgba(0, 188, 212, 0.18);
        }

        .area-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .area-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #e6f4ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .area-tag {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(0, 188, 212, 0.12);
            color: #8ae8ff;
            border: 1px solid rgba(0, 188, 212, 0.3);
        }

        .area-desc {
            font-size: 13px;
            color: #93a9c5;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .area-device-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .area-device-tag {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 999px;
            background: #142b41;
            border: 1px solid #1f3f5c;
            color: #c3d8ef;
        }
    </style>

    <div class="page-header">
        <h2 class="page-title">
            <i class="fas fa-sitemap"></i> 层级能耗监测
        </h2>
        <p class="page-description">
            支持从厂区、车间到产线/工序多层级查看各类能源（电、水、气、蒸汽等）的用量、成本与趋势，快速定位能耗高点。
        </p>
    </div>

    <div class="filter-panel">
        <div class="energy-type-pills" id="energy-type-pills">
            <!-- JS 渲染能源类型 -->
        </div>

        <div class="filter-grid">
            <div class="filter-field">
                <label class="filter-label">厂区</label>
                <select class="filter-select" id="factory-select"></select>
            </div>
            <div class="filter-field">
                <label class="filter-label">区域</label>
                <select class="filter-select" id="area-select">
                    <option value="">全部区域</option>
                    <option value="office">办公区</option>
                    <option value="production">生产区</option>
                </select>
            </div>
            <div class="filter-field">
                <label class="filter-label">车间</label>
                <select class="filter-select" id="workshop-select">
                    <option value="">全部车间</option>
                </select>
            </div>
            <div class="filter-field">
                <label class="filter-label">产线</label>
                <select class="filter-select" id="production-line-select">
                    <option value="">全部产线</option>
                </select>
            </div>
            <div class="filter-field">
                <label class="filter-label">工序</label>
                <select class="filter-select" id="process-select">
                    <option value="">所有工序</option>
                </select>
            </div>
            <div class="filter-field">
                <label class="filter-label">时间范围</label>
                <input type="date" class="filter-input" id="date-select">
            </div>
        </div>

        <div class="timeframe-group">
            <div>
                <button class="timeframe-button active" data-range="day">日</button>
                <button class="timeframe-button" data-range="week">周</button>
                <button class="timeframe-button" data-range="month">月</button>
                <button class="timeframe-button" data-range="custom">自定义</button>
            </div>
            <button class="apply-filter-btn" id="apply-filter-btn">
                <i class="fas fa-sync-alt"></i> 更新数据
            </button>
        </div>
    </div>

    <div class="area-card-grid" id="area-card-grid">
        <!-- 区域卡片 -->
    </div>

    <div class="breadcrumb" id="breadcrumb">
        <!-- JS 渲染路径 -->
    </div>

    <div class="kpi-grid" id="kpi-grid">
        <!-- JS 渲染KPI -->
    </div>

    <div class="content-grid">
        <div class="card">
            <div class="card-title">
                <i class="fas fa-chart-line"></i> 能耗趋势
            </div>
            <svg class="trend-chart" id="trend-chart" viewBox="0 0 600 220" preserveAspectRatio="none"></svg>
        </div>

        <div class="card">
            <div class="card-title">
                <i class="fas fa-layer-group"></i> 下级贡献
            </div>
            <div id="breakdown-list" class="breakdown-list"></div>
        </div>
    </div>

    <div class="content-grid" style="margin-top: 16px;">
        <div class="card">
            <div class="card-title">
                <i class="fas fa-tachometer-alt"></i> 重点设备/计量点
            </div>
            <div class="pill-group" id="device-filter-pills">
                <!-- JS 渲染 -->
            </div>
            <div style="overflow-x: auto;">
                <table class="device-table" id="device-table">
                    <thead>
                        <tr>
                            <th>设备/仪表</th>
                            <th>所在层级</th>
                            <th>编码</th>
                            <th>当前能耗</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS 渲染 -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <i class="fas fa-info-circle"></i> 分析摘要
            </div>
            <div id="analysis-highlights" style="font-size: 13px; line-height: 1.7; color: #cdd9e8;">
                <!-- JS 渲染 -->
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const energyTypes = [
        { id: 'electricity', name: '用电', icon: 'fa-bolt', unit: 'kWh', costUnit: '元' },
        { id: 'water', name: '用水', icon: 'fa-tint', unit: 'm³', costUnit: '元' },
        { id: 'gas', name: '用气', icon: 'fa-burn', unit: 'Nm³', costUnit: '元' }
    ];

    const deviceTypeLabels = {
        lighting: '照明',
        hvac: '空调',
        power: '动力',
        special: '特殊',
        pump: '水泵',
        main: '主机',
        it: 'IT/电脑',
        meter: '计量仪表',
        other: '其他'
    };

    const deviceFilterOptions = [
        { id: 'all', label: '全部' },
        { id: 'lighting', label: '照明' },
        { id: 'hvac', label: '空调' },
        { id: 'power', label: '动力' },
        { id: 'pump', label: '水泵' },
        { id: 'main', label: '主机' },
        { id: 'special', label: '特殊' }
    ];

    const areaProfiles = {
        office: {
            id: 'office',
            name: '办公区',
            icon: 'fa-building',
            description: '覆盖行政楼、会议室、实验室等场所，主要能耗来自照明、空调、IT 设备以及办公生活配套用水、用电。',
            mainDevices: [
                { type: 'lighting', name: '照明设备（LED顶灯/应急灯）' },
                { type: 'hvac', name: '舒适性空调（多联机/新风机）' },
                { type: 'it', name: '电脑及办公设备' },
                { type: 'meter', name: '办公楼电表/水表' }
            ]
        },
        production: {
            id: 'production',
            name: '生产区',
            icon: 'fa-industry',
            description: '包括注塑、冲压等生产线，能源覆盖动力设备、工艺主机、循环水泵、压缩机以及工艺照明/空调等。',
            mainDevices: [
                { type: 'lighting', name: '工厂照明（高棚灯/区域照明）' },
                { type: 'power', name: '动力设备（压缩机、主传动）' },
                { type: 'pump', name: '水泵/循环泵' },
                { type: 'main', name: '工艺主机（注塑机、冲压机）' }
            ]
        }
    };

    const hierarchy = {
        factories: [
            { id: 'factory-1', name: '制造一厂', workshops: ['workshop-1', 'workshop-2'], eccId: 'ecc-1' }
        ],
        workshops: [
            { id: 'workshop-1', name: '注塑车间', factoryId: 'factory-1', productionLines: ['line-1', 'line-2'], eccId: 'ecc-2' },
            { id: 'workshop-2', name: '冲压车间', factoryId: 'factory-1', productionLines: ['line-3'], eccId: 'ecc-3' }
        ],
        productionLines: [
            { id: 'line-1', name: '注塑产线A', workshopId: 'workshop-1', processes: ['process-1', 'process-2'] },
            { id: 'line-2', name: '注塑产线B', workshopId: 'workshop-1', processes: ['process-3'] },
            { id: 'line-3', name: '冲压产线A', workshopId: 'workshop-2', processes: ['process-4', 'process-5'] }
        ],
        processes: [
            { id: 'process-1', name: '原料干燥', productionLineId: 'line-1' },
            { id: 'process-2', name: '注塑成型', productionLineId: 'line-1' },
            { id: 'process-3', name: '制品冷却', productionLineId: 'line-2' },
            { id: 'process-4', name: '冲压成型', productionLineId: 'line-3' },
            { id: 'process-5', name: '后处理', productionLineId: 'line-3' }
        ]
    };

    const energySnapshots = {
        electricity: {
            'factory-1': {
                total: 12850,
                cost: 74200,
                unit: 'kWh',
                yoy: 3.8,
                dod: -1.4,
                intensity: { output: 51.6, area: 1.82 },
                trend: [480, 520, 560, 590, 610, 640, 680, 700, 720, 690, 650, 610, 580, 560, 570, 610, 640, 660, 690, 710, 730, 700, 660, 620],
                children: [
                    { id: 'area-production', name: '生产区', value: 10490 },
                    { id: 'area-office', name: '办公区', value: 2360 }
                ],
                devices: [
                    { name: '1#主变', location: '厂区总降压站', code: 'EQ-TR-01', value: 3200, unit: 'kWh', status: '平稳', type: 'main' },
                    { name: '注塑机群A', location: '注塑产线A', code: 'EQ-INJ-12', value: 2100, unit: 'kWh', status: '偏高', type: 'main' },
                    { name: '冲压机组', location: '冲压车间', code: 'EQ-PRS-04', value: 1850, unit: 'kWh', status: '平稳', type: 'main' }
                ],
                highlights: [
                    '注塑车间占比 56%，较昨日上升 1.2%。',
                    '冲压车间用电环比下降 2.1%，节电措施效果显现。',
                    '夜班段 02:00-05:00 仍存在 310 kWh 基础负荷，可再评估优化。'
                ]
            },
            'area-production': {
                total: 10490,
                cost: 62500,
                unit: 'kWh',
                yoy: 4.2,
                dod: -0.6,
                intensity: { output: 68.4, area: 2.4 },
                trend: [390,420,450,470,500,530,560,580,600,580,550,520,500,480,490,520,550,570,600,620,610,590,560,540],
                children: [
                    { id: 'workshop-1', name: '注塑车间', value: 7200 },
                    { id: 'workshop-2', name: '冲压车间', value: 3290 }
                ],
                devices: [
                    { name: '注塑机群A', location: '注塑产线A', code: 'EQ-INJ-12', value: 2100, unit: 'kWh', status: '偏高', type: 'main' },
                    { name: '冲压机组', location: '冲压车间', code: 'EQ-PRS-04', value: 1850, unit: 'kWh', status: '平稳', type: 'main' },
                    { name: '空压站', location: '动力中心', code: 'EQ-CMP-01', value: 980, unit: 'kWh', status: '平稳', type: 'power' },
                    { name: '循环水泵组', location: '公用工程', code: 'EQ-PUMP-02', value: 620, unit: 'kWh', status: '平稳', type: 'pump' }
                ],
                highlights: [
                    '生产区仍占厂区总用电 81%。',
                    '动力中心空压站贡献 9.3%，处于正常范围。',
                    '循环水泵组夜间可切换单泵运行，预计可再降 3%。'
                ]
            },
            'area-office': {
                total: 2360,
                cost: 11700,
                unit: 'kWh',
                yoy: 1.8,
                dod: -3.2,
                intensity: { output: 12.4, area: 0.68 },
                trend: [90,100,110,120,130,140,150,160,170,160,150,140,130,125,126,130,135,138,142,145,140,135,128,120],
                children: [
                    { id: 'lighting', name: '照明系统', value: 820 },
                    { id: 'hvac', name: '空调系统', value: 980 },
                    { id: 'it', name: 'IT设备/插座', value: 560 }
                ],
                devices: [
                    { name: '办公楼空调机组', location: '行政楼', code: 'HVAC-OA-01', value: 640, unit: 'kWh', status: '平稳', type: 'hvac' },
                    { name: 'LED照明回路', location: '办公区', code: 'LGT-OA-02', value: 420, unit: 'kWh', status: '平稳', type: 'lighting' },
                    { name: '数据中心供电', location: 'IT机房', code: 'IT-RM-01', value: 310, unit: 'kWh', status: '特殊关注', type: 'special' }
                ],
                highlights: [
                    '办公区照明占比 35%，空调占比 41%。',
                    '数据中心夜间负荷高于周末均值 6%，可评估服务器节能策略。'
                ]
            },
            'workshop-1': {
                total: 7200,
                cost: 40250,
                unit: 'kWh',
                yoy: 5.1,
                dod: 0.8,
                intensity: { output: 58.2, area: 2.1 },
                trend: [220,240,260,280,310,340,360,380,400,390,360,330,310,300,310,330,360,380,410,430,420,400,360,340],
                children: [
                    { id: 'line-1', name: '注塑产线A', value: 4200 },
                    { id: 'line-2', name: '注塑产线B', value: 3000 }
                ],
                devices: [
                    { name: '注塑机1#', location: '产线A', code: 'EQ-INJ-01', value: 980, unit: 'kWh', status: '偏高', type: 'main' },
                    { name: '干燥机', location: '产线A', code: 'EQ-DRY-03', value: 520, unit: 'kWh', status: '平稳', type: 'power' },
                    { name: '冷却塔', location: '产线B', code: 'EQ-CLT-02', value: 450, unit: 'kWh', status: '平稳', type: 'pump' }
                ],
                highlights: [
                    '注塑产线A用电 4.2 MWh，贡献 58%。',
                    '干燥工序夜间低负荷，建议联锁控制。',
                    '冷却系统用电与上周持平，暂无异常波动。'
                ]
            },
            'line-1': {
                total: 4200,
                cost: 23800,
                unit: 'kWh',
                yoy: 4.8,
                dod: 1.5,
                intensity: { output: 62.4, area: 2.6 },
                trend: [140,150,160,170,190,210,220,230,240,230,220,210,200,190,200,210,230,240,250,260,255,240,230,210],
                children: [
                    { id: 'process-1', name: '原料干燥', value: 1300 },
                    { id: 'process-2', name: '注塑成型', value: 2900 }
                ],
                devices: [
                    { name: '干燥机组', location: '原料干燥', code: 'EQ-DRY-01', value: 650, unit: 'kWh', status: '偏高', type: 'power' },
                    { name: '注塑机群', location: '注塑成型', code: 'EQ-INJ-CL', value: 2100, unit: 'kWh', status: '平稳', type: 'main' }
                ],
                highlights: [
                    '注塑成型工序占比 69%，建议继续监控模温机效率。',
                    '原料干燥耗电环比 ↑3%，需检查入料含水率。'
                ]
            },
            'workshop-2': {
                total: 5650,
                cost: 33950,
                unit: 'kWh',
                yoy: 2.1,
                dod: -4.3,
                intensity: { output: 44.5, area: 1.3 },
                trend: [180,190,200,210,230,250,260,280,300,290,270,250,240,230,240,250,270,290,310,320,310,300,280,260],
                children: [
                    { id: 'line-3', name: '冲压产线A', value: 5650 }
                ],
                devices: [
                    { name: '冲压机组', location: '冲压产线A', code: 'EQ-PRS-01', value: 1850, unit: 'kWh', status: '平稳', type: 'main' },
                    { name: '氮气站', location: '冲压产线A', code: 'EQ-N2-01', value: 640, unit: 'kWh', status: '偏高', type: 'special' }
                ],
                highlights: [
                    '冲压产线执行削峰策略，整体环比下降 4.3%。',
                    '氮气站负荷超预期，建议核查泄漏与压力设定。'
                ]
            }
        },
        water: {
            'factory-1': {
                total: 1820,
                cost: 5460,
                unit: 'm³',
                yoy: -1.2,
                dod: 0.5,
                intensity: { output: 7.3, area: 0.22 },
                trend: [55,58,60,62,66,70,74,78,82,80,76,72,70,68,69,72,75,78,80,82,81,78,74,70],
                children: [
                    { id: 'area-production', name: '生产区', value: 1420 },
                    { id: 'area-office', name: '办公区', value: 400 }
                ],
                devices: [
                    { name: '冷却塔补水', location: '注塑车间', code: 'WT-CLT-01', value: 420, unit: 'm³', status: '平稳', type: 'pump' },
                    { name: '冲压液压站', location: '冲压车间', code: 'WT-HYD-01', value: 180, unit: 'm³', status: '偏高', type: 'power' }
                ],
                highlights: [
                    '冷却塔补水占注塑车间用水 38%。',
                    '冲压液压站用水偏高，建议检查密封及回水。'
                ]
            },
            'area-production': {
                total: 1420,
                cost: 4260,
                unit: 'm³',
                yoy: -0.8,
                dod: 0.9,
                intensity: { output: 8.6, area: 0.28 },
                trend: [45,48,50,52,56,60,62,64,66,65,62,60,58,57,58,60,62,64,66,68,67,65,62,60],
                children: [
                    { id: 'workshop-1', name: '注塑车间', value: 1120 },
                    { id: 'workshop-2', name: '冲压车间', value: 300 }
                ],
                devices: [
                    { name: '循环冷却水', location: '注塑产线', code: 'WT-CHL-01', value: 180, unit: 'm³', status: '平稳', type: 'pump' },
                    { name: '模温机补水', location: '原料干燥', code: 'WT-MTC-01', value: 210, unit: 'm³', status: '偏高', type: 'special' }
                ],
                highlights: [
                    '生产区用水 78% 来自循环冷却系统。',
                    '模温机补水较上周多 6%，需要校核工艺参数。'
                ]
            },
            'area-office': {
                total: 400,
                cost: 1200,
                unit: 'm³',
                yoy: -2.4,
                dod: -1.0,
                intensity: { output: 1.8, area: 0.08 },
                trend: [10,10,11,12,13,14,15,16,17,16,15,14,13,12,12,13,13,14,14,15,14,13,12,11],
                children: [
                    { id: 'lighting', name: '生活/卫生用水', value: 210 },
                    { id: 'hvac', name: '空调补水', value: 140 },
                    { id: 'other', name: '绿化补水', value: 50 }
                ],
                devices: [
                    { name: '办公楼水表', location: '行政楼', code: 'WT-OA-01', value: 150, unit: 'm³', status: '平稳', type: 'meter' },
                    { name: '冷却塔补水(办公)', location: '屋顶', code: 'WT-OA-CLT', value: 120, unit: 'm³', status: '平稳', type: 'pump' }
                ],
                highlights: [
                    '办公区生活用水 210 m³，周环比下降 1%。',
                    '空调冷却塔补水增长 4%，气温升高所致。'
                ]
            },
            'workshop-1': {
                total: 1120,
                cost: 3360,
                unit: 'm³',
                yoy: -0.6,
                dod: 1.1,
                intensity: { output: 9.2, area: 0.31 },
                trend: [35,38,40,42,46,50,52,54,56,55,52,50,48,47,48,50,52,54,56,58,57,55,52,50],
                children: [
                    { id: 'line-1', name: '注塑产线A', value: 660 },
                    { id: 'line-2', name: '注塑产线B', value: 460 }
                ],
                devices: [
                    { name: '模温机补水', location: '产线A', code: 'WT-MTC-01', value: 210, unit: 'm³', status: '偏高', type: 'special' },
                    { name: '冷却水循环', location: '产线B', code: 'WT-CHL-01', value: 180, unit: 'm³', status: '平稳', type: 'pump' }
                ],
                highlights: [
                    '模温机补水增加 6%，需确认回水温度设定。',
                    '循环水站运行平稳，水质在线指标达标。'
                ]
            }
        },
        gas: {
            'factory-1': {
                total: 960,
                cost: 13400,
                unit: 'Nm³',
                yoy: 1.5,
                dod: -2.8,
                intensity: { output: 3.8, area: 0.12 },
                trend: [28,30,32,34,38,40,42,44,48,46,42,40,38,37,38,40,42,44,46,48,47,45,42,40],
                children: [
                    { id: 'area-production', name: '生产区', value: 820 },
                    { id: 'area-office', name: '办公区', value: 140 }
                ],
                devices: [
                    { name: '氮气站', location: '冲压车间', code: 'GAS-N2-01', value: 320, unit: 'Nm³', status: '平稳', type: 'power' },
                    { name: '辅助燃气炉', location: '注塑车间', code: 'GAS-AUX-01', value: 160, unit: 'Nm³', status: '偏高', type: 'special' }
                ],
                highlights: [
                    '冲压车间氮气占比 56%，环比下降 3%。',
                    '注塑辅助燃气炉因升温需求增加需量，建议优化预热策略。'
                ]
            },
            'area-production': {
                total: 820,
                cost: 11800,
                unit: 'Nm³',
                yoy: 1.9,
                dod: -3.5,
                intensity: { output: 4.5, area: 0.15 },
                trend: [24,26,28,30,34,36,38,40,44,42,38,36,34,33,34,36,38,40,42,44,43,41,38,36],
                children: [
                    { id: 'workshop-1', name: '注塑车间', value: 420 },
                    { id: 'workshop-2', name: '冲压车间', value: 400 }
                ],
                devices: [
                    { name: '氮气站', location: '冲压车间', code: 'GAS-N2-01', value: 320, unit: 'Nm³', status: '平稳', type: 'power' },
                    { name: '辅助燃气炉', location: '注塑车间', code: 'GAS-AUX-01', value: 160, unit: 'Nm³', status: '偏高', type: 'special' }
                ],
                highlights: [
                    '生产区压缩氮气消耗 320 Nm³，处于正常区间。',
                    '辅助燃气炉因升温需求短期增加，需结合计划产量评估。'
                ]
            },
            'area-office': {
                total: 140,
                cost: 1600,
                unit: 'Nm³',
                yoy: 0.4,
                dod: -1.2,
                intensity: { output: 0.6, area: 0.03 },
                trend: [4,4,4,4,5,5,6,6,7,7,6,6,5,5,5,5,6,6,6,6,6,5,5,5],
                children: [
                    { id: 'hvac', name: '燃气空调/锅炉', value: 110 },
                    { id: 'other', name: '餐饮/实验', value: 30 }
                ],
                devices: [
                    { name: '办公区燃气空调', location: '办公楼屋顶', code: 'GAS-HVAC-01', value: 90, unit: 'Nm³', status: '平稳', type: 'hvac' }
                ],
                highlights: [
                    '办公区燃气空调按设定运行，负荷随温度波动。',
                    '实验/餐饮用气 30 Nm³，可通过预约降低峰值。'
                ]
            },
            'workshop-2': {
                total: 540,
                cost: 7560,
                unit: 'Nm³',
                yoy: 2.3,
                dod: -4.9,
                intensity: { output: 4.1, area: 0.13 },
                trend: [16,17,18,19,22,24,26,28,30,29,27,25,24,23,24,25,27,28,30,31,30,29,27,25],
                children: [
                    { id: 'line-3', name: '冲压产线A', value: 540 }
                ],
                devices: [
                    { name: '氮气站', location: '冲压车间', code: 'GAS-N2-01', value: 320, unit: 'Nm³', status: '平稳', type: 'power' }
                ],
                highlights: [
                    '氮气站压缩机变频策略生效，峰值下降 5%。'
                ]
            }
        }
    };

    let currentEnergyType = 'electricity';
    let currentTimeframe = 'day';

    const factorySelect = document.getElementById('factory-select');
    const areaSelect = document.getElementById('area-select');
    const workshopSelect = document.getElementById('workshop-select');
    const productionLineSelect = document.getElementById('production-line-select');
    const processSelect = document.getElementById('process-select');
    const dateSelect = document.getElementById('date-select');
    const energyTypeContainer = document.getElementById('energy-type-pills');
    const kpiGrid = document.getElementById('kpi-grid');
    const trendChart = document.getElementById('trend-chart');
    const breakdownList = document.getElementById('breakdown-list');
    const deviceTableBody = document.querySelector('#device-table tbody');
    const analysisHighlights = document.getElementById('analysis-highlights');
    const breadcrumbEl = document.getElementById('breadcrumb');
    const timeframeButtons = document.querySelectorAll('.timeframe-button');
    const areaCardGrid = document.getElementById('area-card-grid');
    const deviceFilterPills = document.getElementById('device-filter-pills');

    let currentDeviceFilter = 'all';

    function initSelectors() {
        factorySelect.innerHTML = hierarchy.factories.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        factorySelect.value = hierarchy.factories[0].id;
        areaSelect.value = '';
        updateWorkshopOptions('workshop-select', factorySelect.value);
        updateProductionLineOptions('production-line-select', workshopSelect.value || null);
        updateProcessOptions('process-select', productionLineSelect.value || null);
        dateSelect.value = new Date().toISOString().split('T')[0];
    }

    factorySelect.addEventListener('change', () => {
        updateWorkshopOptions('workshop-select', factorySelect.value);
        workshopSelect.value = '';
        updateProductionLineOptions('production-line-select', null);
        productionLineSelect.value = '';
        updateProcessOptions('process-select', null);
        processSelect.value = '';
        areaSelect.value = '';
    });

    workshopSelect.addEventListener('change', () => {
        updateProductionLineOptions('production-line-select', workshopSelect.value || null);
        productionLineSelect.value = '';
        updateProcessOptions('process-select', null);
        processSelect.value = '';
        areaSelect.value = '';
    });

    productionLineSelect.addEventListener('change', () => {
        updateProcessOptions('process-select', productionLineSelect.value || null);
        processSelect.value = '';
        areaSelect.value = '';
    });

    areaSelect.addEventListener('change', () => {
        if (areaSelect.value) {
            workshopSelect.value = '';
            productionLineSelect.value = '';
            processSelect.value = '';
        }
        updateDashboard();
    });

    timeframeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            timeframeButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentTimeframe = btn.dataset.range;
        });
    });

    document.getElementById('apply-filter-btn').addEventListener('click', updateDashboard);

    function initEnergyTypePills() {
        energyTypeContainer.innerHTML = energyTypes.map((type, index) => `
            <button class="energy-type-pill ${index === 0 ? 'active' : ''}" data-energy="${type.id}">
                <i class="fas ${type.icon}"></i>${type.name}
            </button>
        `).join('');

        energyTypeContainer.querySelectorAll('.energy-type-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                energyTypeContainer.querySelectorAll('.energy-type-pill').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                currentEnergyType = pill.dataset.energy;
                updateDashboard();
            });
        });
    }

    function getCurrentNode() {
        if (processSelect.value) {
            return { level: 'process', id: processSelect.value };
        }
        if (productionLineSelect.value) {
            return { level: 'line', id: productionLineSelect.value };
        }
        if (workshopSelect.value) {
            return { level: 'workshop', id: workshopSelect.value };
        }
        if (areaSelect.value) {
            return { level: 'area', id: `area-${areaSelect.value}` };
        }
        return { level: 'factory', id: factorySelect.value || hierarchy.factories[0].id };
    }

    function renderBreadcrumb(node) {
        const crumbs = [];
        if (node.level === 'process') {
            const process = hierarchy.processes.find(p => p.id === node.id);
            const line = hierarchy.productionLines.find(l => l.id === process.productionLineId);
            const workshop = hierarchy.workshops.find(w => w.id === line.workshopId);
            const factory = hierarchy.factories.find(f => f.id === workshop.factoryId);
            crumbs.push(factory.name, workshop.name, line.name, process.name);
        } else if (node.level === 'line') {
            const line = hierarchy.productionLines.find(l => l.id === node.id);
            const workshop = hierarchy.workshops.find(w => w.id === line.workshopId);
            const factory = hierarchy.factories.find(f => f.id === workshop.factoryId);
            crumbs.push(factory.name, workshop.name, line.name);
        } else if (node.level === 'workshop') {
            const workshop = hierarchy.workshops.find(w => w.id === node.id);
            const factory = hierarchy.factories.find(f => f.id === workshop.factoryId);
            crumbs.push(factory.name, workshop.name);
        } else if (node.level === 'area') {
            const areaKey = node.id.replace('area-', '');
            const profile = areaProfiles[areaKey];
            const factory = hierarchy.factories.find(f => f.id === (factorySelect.value || hierarchy.factories[0].id));
            if (factory) {
                crumbs.push(factory.name);
            }
            crumbs.push(profile ? profile.name : '区域');
        } else {
            const factory = hierarchy.factories.find(f => f.id === node.id);
            crumbs.push(factory.name);
        }

        breadcrumbEl.innerHTML = `
            <i class="fas fa-route"></i>
            ${crumbs.map((c, idx) => idx === crumbs.length - 1 ? `<span>${c}</span>` : `${c} <i class="fas fa-angle-right"></i>`).join(' ')}
        `;
    }

    function getSnapshot(energyType, nodeId) {
        const snapshots = energySnapshots[energyType] || {};
        return snapshots[nodeId] || null;
    }

    function renderAreaCards() {
        const cards = Object.values(areaProfiles).map(profile => {
            const snapshot = getSnapshot(currentEnergyType, `area-${profile.id}`);
            const totalText = snapshot ? `${snapshot.total.toLocaleString()} ${snapshot.unit}` : '暂无数据';
            const deviceTags = profile.mainDevices.map(dev => `<span class="area-device-tag">${dev.name}</span>`).join('');
            return `
                <div class="area-card ${areaSelect.value === profile.id ? 'active' : ''}" data-area="${profile.id}">
                    <div class="area-card-header">
                        <div class="area-card-title">
                            <i class="fas ${profile.icon}"></i>${profile.name}
                        </div>
                        <div class="area-tag">${totalText}</div>
                    </div>
                    <p class="area-desc">${profile.description}</p>
                    <div class="area-device-tags">
                        ${deviceTags}
                    </div>
                </div>
            `;
        }).join('');
        areaCardGrid.innerHTML = cards;
        areaCardGrid.querySelectorAll('.area-card').forEach(card => {
            card.addEventListener('click', () => {
                const area = card.getAttribute('data-area');
                if (areaSelect.value === area) {
                    areaSelect.value = '';
                } else {
                    areaSelect.value = area;
                    workshopSelect.value = '';
                    productionLineSelect.value = '';
                    processSelect.value = '';
                }
                updateDashboard();
            });
        });
    }

    function updateECCOptions(selectId, level = null) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">请选择ECC（可选）</option>';
        let filtered = eccList;
        if (level) {
            filtered = eccList.filter(ecc => ecc.level === level);
        }
        filtered.forEach(ecc => {
            const option = document.createElement('option');
            option.value = ecc.id;
            option.textContent = `${ecc.code} - ${ecc.name}`;
            select.appendChild(option);
        });
    }

    function updateFactoryOptions(selectId) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">请选择厂区</option>';
        hierarchy.factories.forEach(factory => {
            const option = document.createElement('option');
            option.value = factory.id;
            option.textContent = factory.name;
            select.appendChild(option);
        });
    }

    function updateWorkshopOptions(selectId, factoryId = null) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">全部车间</option>';
        let filtered = hierarchy.workshops;
        if (factoryId) {
            filtered = filtered.filter(w => w.factoryId === factoryId);
        }
        filtered.forEach(workshop => {
            const option = document.createElement('option');
            option.value = workshop.id;
            option.textContent = workshop.name;
            select.appendChild(option);
        });
    }

    function updateProductionLineOptions(selectId, workshopId = null) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">全部产线</option>';
        let filtered = hierarchy.productionLines;
        if (workshopId) {
            filtered = filtered.filter(line => line.workshopId === workshopId);
        }
        filtered.forEach(line => {
            const option = document.createElement('option');
            option.value = line.id;
            option.textContent = line.name;
            select.appendChild(option);
        });
    }

    function updateProcessOptions(selectId, productionLineId = null) {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">所有工序</option>';
        let filtered = hierarchy.processes;
        if (productionLineId) {
            filtered = filtered.filter(process => process.productionLineId === productionLineId);
        }
        filtered.forEach(process => {
            const option = document.createElement('option');
            option.value = process.id;
            option.textContent = process.name;
            select.appendChild(option);
        });
    }

    function renderKPIs(snapshot, typeConfig) {
        if (!snapshot) {
            kpiGrid.innerHTML = `<div class="empty-state"><i class="fas fa-info-circle"></i><p>暂无该层级的${typeConfig.name}数据</p></div>`;
            return;
        }

        const yoyClass = snapshot.yoy >= 0 ? 'trend-up' : 'trend-down';
        const dodClass = snapshot.dod >= 0 ? 'trend-up' : 'trend-down';

        kpiGrid.innerHTML = `
            <div class="kpi-card">
                <div class="kpi-label"><i class="fas fa-lightbulb"></i> 总${typeConfig.name}</div>
                <div class="kpi-value">${snapshot.total.toLocaleString()} <span class="kpi-unit">${snapshot.unit}</span></div>
                <div class="kpi-trend ${dodClass}">环比 ${snapshot.dod >= 0 ? '+' : ''}${snapshot.dod}%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label"><i class="fas fa-yen-sign"></i> 能源成本</div>
                <div class="kpi-value">${snapshot.cost.toLocaleString()} <span class="kpi-unit">${typeConfig.costUnit}</span></div>
                <div class="kpi-trend ${yoyClass}">同比 ${snapshot.yoy >= 0 ? '+' : ''}${snapshot.yoy}%</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label"><i class="fas fa-industry"></i> 单位产量能耗</div>
                <div class="kpi-value">${snapshot.intensity?.output ?? '--'} <span class="kpi-unit">${snapshot.unit}/100件</span></div>
                <div class="kpi-trend">实时指标</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label"><i class="fas fa-border-all"></i> 单位面积能耗</div>
                <div class="kpi-value">${snapshot.intensity?.area ?? '--'} <span class="kpi-unit">${snapshot.unit}/m²</span></div>
                <div class="kpi-trend">实时指标</div>
            </div>
        `;
    }

    function renderTrend(snapshot) {
        if (!snapshot || !snapshot.trend) {
            trendChart.innerHTML = '';
            return;
        }
        const values = snapshot.trend;
        const max = Math.max(...values);
        const points = values.map((val, idx) => {
            const x = (idx / (values.length - 1)) * 600;
            const y = 220 - (val / max) * 200 - 10;
            return `${x},${y}`;
        }).join(' ');

        trendChart.innerHTML = `
            <polyline points="${points}" fill="none" stroke="url(#trendGradient)" stroke-width="3" stroke-linecap="round" />
            <defs>
                <linearGradient id="trendGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#00bcd4" />
                    <stop offset="100%" stop-color="#35d8ff" />
                </linearGradient>
            </defs>
            ${values.map((val, idx) => {
                const x = (idx / (values.length - 1)) * 600;
                const y = 220 - (val / max) * 200 - 10;
                return `<circle cx="${x}" cy="${y}" r="3" fill="#35d8ff" />`;
            }).join('')}
        `;
    }

    function renderBreakdown(snapshot, typeConfig) {
        if (!snapshot || !snapshot.children || !snapshot.children.length) {
            breakdownList.innerHTML = `<div class="empty-state"><i class="fas fa-info-circle"></i><p>暂无下级贡献数据</p></div>`;
            return;
        }
        const total = snapshot.total || 1;
        breakdownList.innerHTML = snapshot.children.map(child => {
            const percentage = ((child.value / total) * 100).toFixed(1);
            return `
                <div class="breakdown-item">
                    <div class="breakdown-top">
                        <strong>${child.name}</strong>
                        <span>${child.value.toLocaleString()} ${typeConfig.unit}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div style="margin-top: 4px; font-size: 12px; color: #8aa0bc;">贡献 ${percentage}%</div>
                </div>
            `;
        }).join('');
    }

    function initDeviceFilterPills() {
        if (!deviceFilterPills) return;
        deviceFilterPills.innerHTML = deviceFilterOptions.map(opt => `
            <span class="pill-option ${opt.id === 'all' ? 'active' : ''}" data-type="${opt.id}">${opt.label}</span>
        `).join('');

        deviceFilterPills.querySelectorAll('.pill-option').forEach(pill => {
            pill.addEventListener('click', () => {
                deviceFilterPills.querySelectorAll('.pill-option').forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                currentDeviceFilter = pill.dataset.type;
                updateDashboard();
            });
        });
    }

    function renderDevices(snapshot, typeConfig) {
        let devices = snapshot?.devices || [];
        if (currentDeviceFilter !== 'all') {
            devices = devices.filter(device => device.type === currentDeviceFilter);
        }
        if (!devices.length) {
            deviceTableBody.innerHTML = `<tr><td colspan="5" class="empty-state">暂无重点设备数据</td></tr>`;
            return;
        }
        deviceTableBody.innerHTML = devices.map(device => `
            <tr>
                <td>
                    ${device.name}
                    <div style="font-size:11px;color:#8aa0bc;margin-top:2px;">
                        ${deviceTypeLabels[device.type] || '其他'}
                    </div>
                </td>
                <td>${device.location}</td>
                <td>${device.code}</td>
                <td>${device.value.toLocaleString()} ${device.unit || typeConfig.unit}</td>
                <td>${device.status}</td>
            </tr>
        `).join('');
    }

    function renderHighlights(snapshot) {
        if (!snapshot || !snapshot.highlights) {
            analysisHighlights.innerHTML = '<p>暂无分析摘要。</p>';
            return;
        }
        analysisHighlights.innerHTML = snapshot.highlights.map(item => `
            <p><i class="fas fa-circle" style="font-size:6px; margin-right:6px;"></i>${item}</p>
        `).join('');
    }

    function updateDashboard() {
        const node = getCurrentNode();
        renderBreadcrumb(node);
        renderAreaCards();
        const snapshot = getSnapshot(currentEnergyType, node.id);
        const typeConfig = energyTypes.find(t => t.id === currentEnergyType);
        renderKPIs(snapshot, typeConfig);
        renderTrend(snapshot);
        renderBreakdown(snapshot, typeConfig);
        renderDevices(snapshot, typeConfig);
        renderHighlights(snapshot);
    }

    initSelectors();
    initEnergyTypePills();
    initDeviceFilterPills();
    updateDashboard();
})();
</script>

