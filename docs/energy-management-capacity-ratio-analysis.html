<div class="sub-menu-content-container">
    <style>
        /* 统一滚动条样式 */
        * {
            scrollbar-width: thin;
            scrollbar-color: #3c5472 #1a2a3a;
        }
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1a2a3a;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3c5472;
            border-radius: 5px;
            border: 2px solid #1a2a3a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a6a8a;
        }
        ::-webkit-scrollbar-thumb:active {
            background: #00bcd4;
        }
        ::-webkit-scrollbar-corner {
            background: #1a2a3a;
        }
        
        .capacity-ratio-container {
            padding: 20px;
            background-color: #0f1e2d;
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Source Han Sans', Arial, sans-serif;
        }

        .page-header {
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 24px;
            color: #00bcd4;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .page-description {
            color: #a7bed3;
            margin-top: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        /* 筛选区域 */
        .filter-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-item label {
            color: #a7bed3;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-select, .filter-input {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            color: #e0e6ed;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .filter-input {
            cursor: text;
        }

        .filter-select:hover, .filter-input:focus {
            border-color: #00bcd4;
            outline: none;
        }

        .action-button {
            background-color: #00bcd4;
            border: none;
            color: #1a2a3a;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            background-color: #00acc1;
            transform: translateY(-1px);
        }

        .action-button.secondary {
            background-color: #3c5472;
            color: #e0e6ed;
        }

        .action-button.secondary:hover {
            background-color: #4a6a8a;
        }

        /* KPI卡片区域 */
        .kpi-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .kpi-label {
            color: #a7bed3;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-value {
            color: #e0e6ed;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .kpi-unit {
            font-size: 16px;
            color: #a7bed3;
            font-weight: normal;
        }

        .kpi-trend {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .kpi-trend.up {
            color: #f44336;
        }

        .kpi-trend.down {
            color: #4caf50;
        }

        /* 图表区域 */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-panel {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            font-size: 16px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
            overflow: hidden;
        }

        /* 数据表格 */
        .data-table-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .section-title {
            font-size: 18px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th {
            background-color: #1a2a3a;
            color: #e0e6ed;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #3c5472;
            white-space: nowrap;
        }

        .data-table td {
            padding: 12px;
            color: #a7bed3;
            border-bottom: 1px solid #3c5472;
        }

        .data-table tbody tr:hover {
            background-color: #1e2d3f;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .value-highlight {
            color: #00bcd4;
            font-weight: bold;
        }

        .comparison-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .comparison-badge.best {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .comparison-badge.worst {
            background-color: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
    </style>

    <div class="capacity-ratio-container">
        <div class="page-header">
            <h2 class="page-title">
                <i class="fas fa-chart-bar"></i> 产能比分析
            </h2>
            <p class="page-description">
                对已配置产品的产品单位产量能耗和产品万元产值能耗进行分析，支持多能源单元的产量能耗和万元产值能耗对比分析，为产能优化提供数据支撑。
            </p>
        </div>

        <!-- 筛选区域 -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-item">
                    <label>时间范围：</label>
                    <select class="filter-select" id="time-range">
                        <option value="month">近一月</option>
                        <option value="quarter">近一季度</option>
                        <option value="year" selected>近一年</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
                <div class="filter-item" id="custom-date-range" style="display: none;">
                    <label>开始日期：</label>
                    <input type="date" class="filter-input" id="start-date">
                    <label>结束日期：</label>
                    <input type="date" class="filter-input" id="end-date">
                </div>
                <div class="filter-item">
                    <label>产品：</label>
                    <select class="filter-select" id="filter-product">
                        <option value="all">全部产品</option>
                        <option value="product-a">产品A</option>
                        <option value="product-b">产品B</option>
                        <option value="product-c">产品C</option>
                        <option value="product-d">产品D</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>ECC：</label>
                    <select class="filter-select" id="filter-ecc">
                        <option value="all">全部ECC</option>
                        <option value="ecc-1">生产车间1</option>
                        <option value="ecc-2">生产车间2</option>
                        <option value="ecc-3">生产车间3</option>
                    </select>
                </div>
                <button class="action-button" onclick="queryData()">
                    <i class="fas fa-search"></i> 查询
                </button>
                <button class="action-button secondary" onclick="resetFilter()">
                    <i class="fas fa-redo"></i> 重置
                </button>
            </div>
        </div>

        <!-- KPI卡片区域 -->
        <div class="kpi-section" id="kpi-section">
            <!-- KPI卡片将通过JavaScript动态生成 -->
        </div>

        <!-- 图表区域 -->
        <div class="charts-section">
            <div class="chart-panel">
                <h3 class="chart-title">
                    <i class="fas fa-chart-line"></i> 单位产量能耗对比
                </h3>
                <div class="chart-container" id="unit-consumption-chart">
                    <!-- 图表将通过JavaScript动态生成 -->
                </div>
            </div>
            <div class="chart-panel">
                <h3 class="chart-title">
                    <i class="fas fa-chart-bar"></i> 万元产值能耗对比
                </h3>
                <div class="chart-container" id="output-value-chart">
                    <!-- 图表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 数据表格 -->
        <div class="data-table-section">
            <div class="section-title">
                <i class="fas fa-table"></i> 产能比分析明细
            </div>
            <table class="data-table" id="data-table">
                <thead>
                    <tr>
                        <th>ECC</th>
                        <th>产品</th>
                        <th>产量</th>
                        <th>产值（万元）</th>
                        <th>能耗（kWh）</th>
                        <th>单位产量能耗（kWh/件）</th>
                        <th>万元产值能耗（kWh/万元）</th>
                        <th>对比排名</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    <!-- 表格数据将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
(function() {
    // 产能比分析数据（示例数据）
    const capacityRatioData = [
        // 生产车间1数据
        { ecc: 'ecc-1', eccName: '生产车间1', product: 'product-a', productName: '产品A', quantity: 1250.5, outputValue: 125.05, energyConsumption: 12500, unitConsumption: 9.99, valueConsumption: 99.96 },
        { ecc: 'ecc-1', eccName: '生产车间1', product: 'product-b', productName: '产品B', quantity: 980.3, outputValue: 147.05, energyConsumption: 11760, unitConsumption: 12.00, valueConsumption: 80.00 },
        { ecc: 'ecc-1', eccName: '生产车间1', product: 'product-c', productName: '产品C', quantity: 750.8, outputValue: 112.62, energyConsumption: 9000, unitConsumption: 11.99, valueConsumption: 79.88 },
        // 生产车间2数据
        { ecc: 'ecc-2', eccName: '生产车间2', product: 'product-a', productName: '产品A', quantity: 1180.2, outputValue: 118.02, energyConsumption: 11800, unitConsumption: 10.00, valueConsumption: 100.00 },
        { ecc: 'ecc-2', eccName: '生产车间2', product: 'product-c', productName: '产品C', quantity: 680.3, outputValue: 102.05, energyConsumption: 8500, unitConsumption: 12.50, valueConsumption: 83.33 },
        { ecc: 'ecc-2', eccName: '生产车间2', product: 'product-d', productName: '产品D', quantity: 320.5, outputValue: 96.15, energyConsumption: 4800, unitConsumption: 14.98, valueConsumption: 49.92 },
        // 生产车间3数据
        { ecc: 'ecc-3', eccName: '生产车间3', product: 'product-b', productName: '产品B', quantity: 950.6, outputValue: 142.59, energyConsumption: 11400, unitConsumption: 11.99, valueConsumption: 79.92 },
        { ecc: 'ecc-3', eccName: '生产车间3', product: 'product-d', productName: '产品D', quantity: 450.2, outputValue: 135.06, energyConsumption: 6300, unitConsumption: 13.98, valueConsumption: 46.66 },
        { ecc: 'ecc-3', eccName: '生产车间3', product: 'product-a', productName: '产品A', quantity: 1150.8, outputValue: 115.08, energyConsumption: 11500, unitConsumption: 9.99, valueConsumption: 99.92 },
        // 更多数据
        { ecc: 'ecc-1', eccName: '生产车间1', product: 'product-d', productName: '产品D', quantity: 380.5, outputValue: 114.15, energyConsumption: 5320, unitConsumption: 13.99, valueConsumption: 46.61 },
        { ecc: 'ecc-2', eccName: '生产车间2', product: 'product-b', productName: '产品B', quantity: 965.5, outputValue: 144.83, energyConsumption: 11580, unitConsumption: 11.99, valueConsumption: 79.92 },
        { ecc: 'ecc-3', eccName: '生产车间3', product: 'product-c', productName: '产品C', quantity: 720.8, outputValue: 108.12, energyConsumption: 9000, unitConsumption: 12.48, valueConsumption: 83.25 }
    ];

    // 筛选数据
    function getFilteredData() {
        const timeRange = document.getElementById('time-range').value;
        const filterProduct = document.getElementById('filter-product').value;
        const filterEcc = document.getElementById('filter-ecc').value;

        let filtered = [...capacityRatioData];

        if (filterProduct !== 'all') {
            filtered = filtered.filter(item => item.product === filterProduct);
        }

        if (filterEcc !== 'all') {
            filtered = filtered.filter(item => item.ecc === filterEcc);
        }

        return filtered;
    }

    // 计算KPI指标
    function calculateKPI(data) {
        if (data.length === 0) {
            return {
                avgUnitConsumption: 0,
                avgValueConsumption: 0,
                totalEnergy: 0,
                totalOutput: 0,
                totalValue: 0
            };
        }

        const totalEnergy = data.reduce((sum, item) => sum + item.energyConsumption, 0);
        const totalOutput = data.reduce((sum, item) => sum + item.quantity, 0);
        const totalValue = data.reduce((sum, item) => sum + item.outputValue, 0);
        const avgUnitConsumption = totalOutput > 0 ? totalEnergy / totalOutput : 0;
        const avgValueConsumption = totalValue > 0 ? totalEnergy / totalValue : 0;

        return {
            avgUnitConsumption: avgUnitConsumption.toFixed(2),
            avgValueConsumption: avgValueConsumption.toFixed(2),
            totalEnergy: totalEnergy.toLocaleString(),
            totalOutput: totalOutput.toLocaleString('zh-CN', { maximumFractionDigits: 1 }),
            totalValue: totalValue.toLocaleString('zh-CN', { maximumFractionDigits: 2 })
        };
    }

    // 渲染KPI卡片
    function renderKPI(data) {
        const kpi = calculateKPI(data);
        const kpiSection = document.getElementById('kpi-section');
        
        kpiSection.innerHTML = `
            <div class="kpi-card">
                <div class="kpi-label">
                    <i class="fas fa-bolt"></i> 平均单位产量能耗
                </div>
                <div class="kpi-value">
                    ${kpi.avgUnitConsumption}
                    <span class="kpi-unit">kWh/件</span>
                </div>
                <div class="kpi-trend down">
                    <i class="fas fa-arrow-down"></i> 较上月下降 2.5%
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">
                    <i class="fas fa-dollar-sign"></i> 平均万元产值能耗
                </div>
                <div class="kpi-value">
                    ${kpi.avgValueConsumption}
                    <span class="kpi-unit">kWh/万元</span>
                </div>
                <div class="kpi-trend down">
                    <i class="fas fa-arrow-down"></i> 较上月下降 1.8%
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">
                    <i class="fas fa-chart-line"></i> 总产量
                </div>
                <div class="kpi-value">
                    ${kpi.totalOutput}
                    <span class="kpi-unit">件</span>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">
                    <i class="fas fa-coins"></i> 总产值
                </div>
                <div class="kpi-value">
                    ${kpi.totalValue}
                    <span class="kpi-unit">万元</span>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">
                    <i class="fas fa-plug"></i> 总能耗
                </div>
                <div class="kpi-value">
                    ${kpi.totalEnergy}
                    <span class="kpi-unit">kWh</span>
                </div>
            </div>
        `;
    }

    // 渲染单位产量能耗对比图表
    function renderUnitConsumptionChart(data) {
        const chartContainer = document.getElementById('unit-consumption-chart');
        
        // 按ECC分组
        const eccGroups = {};
        data.forEach(item => {
            if (!eccGroups[item.eccName]) {
                eccGroups[item.eccName] = [];
            }
            eccGroups[item.eccName].push(item);
        });

        const eccNames = Object.keys(eccGroups);
        const maxValue = Math.max(...data.map(item => item.unitConsumption)) * 1.2;

        // 创建SVG图表
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', '100%');
        svg.setAttribute('viewBox', '0 0 800 400');
        svg.style.overflow = 'visible';

        const padding = { top: 40, right: 40, bottom: 60, left: 80 };
        const chartWidth = 800 - padding.left - padding.right;
        const chartHeight = 400 - padding.top - padding.bottom;

        // 绘制坐标轴
        const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        xAxis.setAttribute('x1', padding.left);
        xAxis.setAttribute('y1', padding.top + chartHeight);
        xAxis.setAttribute('x2', padding.left + chartWidth);
        xAxis.setAttribute('y2', padding.top + chartHeight);
        xAxis.setAttribute('stroke', '#3c5472');
        xAxis.setAttribute('stroke-width', '2');
        svg.appendChild(xAxis);

        const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        yAxis.setAttribute('x1', padding.left);
        yAxis.setAttribute('y1', padding.top);
        yAxis.setAttribute('x2', padding.left);
        yAxis.setAttribute('y2', padding.top + chartHeight);
        yAxis.setAttribute('stroke', '#3c5472');
        yAxis.setAttribute('stroke-width', '2');
        svg.appendChild(yAxis);

        // 绘制Y轴刻度
        for (let i = 0; i <= 5; i++) {
            const value = (maxValue / 5) * i;
            const y = padding.top + chartHeight - (i / 5) * chartHeight;
            
            const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            tick.setAttribute('x1', padding.left - 5);
            tick.setAttribute('y1', y);
            tick.setAttribute('x2', padding.left);
            tick.setAttribute('y2', y);
            tick.setAttribute('stroke', '#3c5472');
            tick.setAttribute('stroke-width', '1');
            svg.appendChild(tick);

            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', padding.left - 10);
            label.setAttribute('y', y + 4);
            label.setAttribute('text-anchor', 'end');
            label.setAttribute('fill', '#a7bed3');
            label.setAttribute('font-size', '12');
            label.textContent = value.toFixed(1);
            svg.appendChild(label);
        }

        // 绘制柱状图
        const barWidth = Math.min(60, chartWidth / (data.length + 1));
        const colors = ['#00bcd4', '#4caf50', '#ff9800', '#f44336', '#9c27b0', '#00acc1'];
        const spacing = (chartWidth - (barWidth * data.length)) / (data.length + 1);
        let xOffset = padding.left + spacing;

        data.forEach((item, index) => {
            const barHeight = (item.unitConsumption / maxValue) * chartHeight;
            const x = xOffset;
            const y = padding.top + chartHeight - barHeight;

            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', barWidth);
            rect.setAttribute('height', barHeight);
            rect.setAttribute('fill', colors[index % colors.length]);
            rect.setAttribute('rx', '2');
            svg.appendChild(rect);

            // 标签
            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', x + barWidth / 2);
            label.setAttribute('y', y - 5);
            label.setAttribute('text-anchor', 'middle');
            label.setAttribute('fill', '#e0e6ed');
            label.setAttribute('font-size', '11');
            label.textContent = item.unitConsumption.toFixed(2);
            svg.appendChild(label);

            // X轴标签（ECC + 产品）
            const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            xLabel.setAttribute('x', x + barWidth / 2);
            xLabel.setAttribute('y', padding.top + chartHeight + 15);
            xLabel.setAttribute('text-anchor', 'middle');
            xLabel.setAttribute('fill', '#a7bed3');
            xLabel.setAttribute('font-size', '10');
            xLabel.textContent = item.eccName.substring(0, 3);
            svg.appendChild(xLabel);

            const productLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            productLabel.setAttribute('x', x + barWidth / 2);
            productLabel.setAttribute('y', padding.top + chartHeight + 30);
            productLabel.setAttribute('text-anchor', 'middle');
            productLabel.setAttribute('fill', '#a7bed3');
            productLabel.setAttribute('font-size', '10');
            productLabel.textContent = item.productName;
            svg.appendChild(productLabel);

            xOffset += barWidth + spacing;
        });

        chartContainer.innerHTML = '';
        chartContainer.appendChild(svg);
    }

    // 渲染万元产值能耗对比图表
    function renderValueConsumptionChart(data) {
        const chartContainer = document.getElementById('output-value-chart');
        
        const maxValue = Math.max(...data.map(item => item.valueConsumption)) * 1.2;

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', '100%');
        svg.setAttribute('viewBox', '0 0 800 400');
        svg.style.overflow = 'visible';

        const padding = { top: 40, right: 40, bottom: 60, left: 80 };
        const chartWidth = 800 - padding.left - padding.right;
        const chartHeight = 400 - padding.top - padding.bottom;

        // 绘制坐标轴
        const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        xAxis.setAttribute('x1', padding.left);
        xAxis.setAttribute('y1', padding.top + chartHeight);
        xAxis.setAttribute('x2', padding.left + chartWidth);
        xAxis.setAttribute('y2', padding.top + chartHeight);
        xAxis.setAttribute('stroke', '#3c5472');
        xAxis.setAttribute('stroke-width', '2');
        svg.appendChild(xAxis);

        const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        yAxis.setAttribute('x1', padding.left);
        yAxis.setAttribute('y1', padding.top);
        yAxis.setAttribute('x2', padding.left);
        yAxis.setAttribute('y2', padding.top + chartHeight);
        yAxis.setAttribute('stroke', '#3c5472');
        yAxis.setAttribute('stroke-width', '2');
        svg.appendChild(yAxis);

        // 绘制Y轴刻度
        for (let i = 0; i <= 5; i++) {
            const value = (maxValue / 5) * i;
            const y = padding.top + chartHeight - (i / 5) * chartHeight;
            
            const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            tick.setAttribute('x1', padding.left - 5);
            tick.setAttribute('y1', y);
            tick.setAttribute('x2', padding.left);
            tick.setAttribute('y2', y);
            tick.setAttribute('stroke', '#3c5472');
            tick.setAttribute('stroke-width', '1');
            svg.appendChild(tick);

            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', padding.left - 10);
            label.setAttribute('y', y + 4);
            label.setAttribute('text-anchor', 'end');
            label.setAttribute('fill', '#a7bed3');
            label.setAttribute('font-size', '12');
            label.textContent = value.toFixed(0);
            svg.appendChild(label);
        }

        // 绘制柱状图
        const barWidth = Math.min(60, chartWidth / (data.length + 1));
        const colors = ['#00bcd4', '#4caf50', '#ff9800', '#f44336', '#9c27b0', '#00acc1'];
        const spacing = (chartWidth - (barWidth * data.length)) / (data.length + 1);
        let xOffset = padding.left + spacing;

        data.forEach((item, index) => {
            const barHeight = (item.valueConsumption / maxValue) * chartHeight;
            const x = xOffset;
            const y = padding.top + chartHeight - barHeight;

            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', barWidth);
            rect.setAttribute('height', barHeight);
            rect.setAttribute('fill', colors[index % colors.length]);
            rect.setAttribute('rx', '2');
            svg.appendChild(rect);

            // 标签
            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', x + barWidth / 2);
            label.setAttribute('y', y - 5);
            label.setAttribute('text-anchor', 'middle');
            label.setAttribute('fill', '#e0e6ed');
            label.setAttribute('font-size', '11');
            label.textContent = item.valueConsumption.toFixed(2);
            svg.appendChild(label);

            // X轴标签（ECC + 产品）
            const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            xLabel.setAttribute('x', x + barWidth / 2);
            xLabel.setAttribute('y', padding.top + chartHeight + 15);
            xLabel.setAttribute('text-anchor', 'middle');
            xLabel.setAttribute('fill', '#a7bed3');
            xLabel.setAttribute('font-size', '10');
            xLabel.textContent = item.eccName.substring(0, 3);
            svg.appendChild(xLabel);

            const productLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            productLabel.setAttribute('x', x + barWidth / 2);
            productLabel.setAttribute('y', padding.top + chartHeight + 30);
            productLabel.setAttribute('text-anchor', 'middle');
            productLabel.setAttribute('fill', '#a7bed3');
            productLabel.setAttribute('font-size', '10');
            productLabel.textContent = item.productName;
            svg.appendChild(productLabel);

            xOffset += barWidth + spacing;
        });

        chartContainer.innerHTML = '';
        chartContainer.appendChild(svg);
    }

    // 渲染数据表格
    function renderTable(data) {
        const tbody = document.getElementById('data-table-body');
        
        // 按单位产量能耗排序
        const sortedData = [...data].sort((a, b) => a.unitConsumption - b.unitConsumption);
        
        // 找出最佳和最差
        const bestUnit = sortedData[0];
        const worstUnit = sortedData[sortedData.length - 1];

        tbody.innerHTML = sortedData.map((item, index) => {
            const isBest = item === bestUnit;
            const isWorst = item === worstUnit && item !== bestUnit;
            
            return `
                <tr>
                    <td>${item.eccName}</td>
                    <td>${item.productName}</td>
                    <td>${item.quantity.toLocaleString('zh-CN', { maximumFractionDigits: 1 })}</td>
                    <td>${item.outputValue.toLocaleString('zh-CN', { maximumFractionDigits: 2 })}</td>
                    <td>${item.energyConsumption.toLocaleString()}</td>
                    <td class="value-highlight">${item.unitConsumption.toFixed(2)}</td>
                    <td class="value-highlight">${item.valueConsumption.toFixed(2)}</td>
                    <td>
                        ${isBest ? '<span class="comparison-badge best">最优</span>' : ''}
                        ${isWorst ? '<span class="comparison-badge worst">待优化</span>' : ''}
                        ${!isBest && !isWorst ? `<span>第${index + 1}名</span>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }

    // 查询数据
    window.queryData = function() {
        const data = getFilteredData();
        renderKPI(data);
        renderUnitConsumptionChart(data);
        renderValueConsumptionChart(data);
        renderTable(data);
    };

    // 重置筛选
    window.resetFilter = function() {
        document.getElementById('time-range').value = 'year';
        document.getElementById('filter-product').value = 'all';
        document.getElementById('filter-ecc').value = 'all';
        document.getElementById('custom-date-range').style.display = 'none';
        queryData();
    };

    // 时间范围切换
    document.getElementById('time-range').addEventListener('change', function() {
        const customRange = document.getElementById('custom-date-range');
        if (this.value === 'custom') {
            customRange.style.display = 'flex';
        } else {
            customRange.style.display = 'none';
        }
    });

    // 初始化
    function init() {
        queryData();
    }

    // 页面加载时初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
