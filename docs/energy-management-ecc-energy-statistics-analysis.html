<div class="ecc-energy-statistics-container">
    <style>
        /* 统一滚动条样式 */
        * {
            scrollbar-width: thin;
            scrollbar-color: #3c5472 #1a2a3a;
        }
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1a2a3a;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3c5472;
            border-radius: 5px;
            border: 2px solid #1a2a3a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a6a8a;
        }
        ::-webkit-scrollbar-thumb:active {
            background: #00bcd4;
        }
        ::-webkit-scrollbar-corner {
            background: #1a2a3a;
        }
        
        .ecc-energy-statistics-container {
            padding: 20px;
            background-color: #0f1e2d;
        }

        .page-header {
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 24px;
            color: #00bcd4;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .page-description {
            color: #a7bed3;
            font-size: 14px;
            margin-top: 8px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* 筛选区域 */
        .filter-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-item label {
            color: #a7bed3;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-select, .filter-input {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            color: #e0e6ed;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .filter-select:hover, .filter-input:hover {
            border-color: #00bcd4;
        }

        .filter-input[type="datetime-local"] {
            min-width: 200px;
        }

        .query-button, .export-button {
            background-color: #00bcd4;
            border: none;
            color: #1a2a3a;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .query-button:hover, .export-button:hover {
            background-color: #00acc1;
            transform: translateY(-1px);
        }

        .export-button {
            background-color: #3c5472;
            color: #e0e6ed;
        }

        .export-button:hover {
            background-color: #4a6a8a;
        }

        /* 统计概览卡片 */
        .overview-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .overview-card {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .overview-card-label {
            font-size: 13px;
            color: #a7bed3;
            margin-bottom: 10px;
        }

        .overview-card-value {
            font-size: 28px;
            font-weight: bold;
            color: #00bcd4;
            margin-bottom: 5px;
        }

        .overview-card-unit {
            font-size: 12px;
            color: #5d7d9a;
        }

        .overview-card-trend {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .overview-card-trend.positive {
            color: #4caf50;
        }

        .overview-card-trend.negative {
            color: #f44336;
        }

        /* ECC排名区域 */
        .ranking-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ranking-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #3c5472;
        }

        .ranking-tab {
            background: none;
            border: none;
            padding: 10px 20px;
            color: #a7bed3;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .ranking-tab.active {
            color: #00bcd4;
            border-bottom-color: #00bcd4;
            font-weight: bold;
        }

        .ranking-tab:hover {
            color: #00bcd4;
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            border-color: #00bcd4;
            background-color: #1e2d3f;
        }

        .ranking-number {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            margin-right: 15px;
        }

        .ranking-number.top1 {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a2a3a;
        }

        .ranking-number.top2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            color: #1a2a3a;
        }

        .ranking-number.top3 {
            background: linear-gradient(135deg, #cd7f32 0%, #e6a85c 100%);
            color: #1a2a3a;
        }

        .ranking-number.other {
            background-color: #3c5472;
            color: #a7bed3;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-size: 15px;
            font-weight: bold;
            color: #e0e6ed;
            margin-bottom: 4px;
        }

        .ranking-code {
            font-size: 12px;
            color: #a7bed3;
        }

        .ranking-value {
            text-align: right;
        }

        .ranking-value-main {
            font-size: 18px;
            font-weight: bold;
            color: #00bcd4;
            margin-bottom: 2px;
        }

        .ranking-value-label {
            font-size: 11px;
            color: #5d7d9a;
        }

        /* 图表区域 */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-panel {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            font-size: 16px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            padding: 10px;
        }

        .chart-container svg {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: block;
            box-sizing: border-box;
        }

        /* 详细数据表格 */
        .data-table-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: #1a2a3a;
            color: #a7bed3;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: normal;
            border-bottom: 2px solid #3c5472;
        }

        .data-table td {
            padding: 12px;
            color: #e0e6ed;
            font-size: 13px;
            border-bottom: 1px solid #3c5472;
        }

        .data-table tr:hover {
            background-color: #1e2d3f;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5d7d9a;
        }
    </style>

    <div class="page-header">
        <h2 class="page-title">
            <i class="fas fa-chart-bar"></i>
            ECC能源统计分析
        </h2>
    </div>

    <!-- 筛选区域 -->
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-item">
                <label>统计周期:</label>
                <select class="filter-select" id="time-granularity">
                    <option value="hour">按小时</option>
                    <option value="day" selected>按天</option>
                    <option value="week">按周</option>
                    <option value="month">按月</option>
                </select>
            </div>
            <div class="filter-item">
                <label>开始时间:</label>
                <input type="datetime-local" class="filter-input" id="start-time">
            </div>
            <div class="filter-item">
                <label>结束时间:</label>
                <input type="datetime-local" class="filter-input" id="end-time">
            </div>
            <div class="filter-item">
                <label>ECC级别:</label>
                <select class="filter-select" id="ecc-level-filter">
                    <option value="all">全部级别</option>
                    <option value="company">公司工厂级</option>
                    <option value="workshop">车间级</option>
                    <option value="production-line">产线级</option>
                    <option value="process">工序级</option>
                    <option value="equipment">设备级</option>
                    <option value="team">班组级</option>
                </select>
            </div>
            <div class="filter-item">
                <label>ECC选择:</label>
                <select class="filter-select" id="ecc-select">
                    <option value="all">全部ECC</option>
                </select>
            </div>
            <button class="query-button" onclick="queryData()">
                <i class="fas fa-search"></i> 查询
            </button>
            <button class="export-button" onclick="exportData()">
                <i class="fas fa-download"></i> 导出
            </button>
        </div>
    </div>

    <!-- 统计概览 -->
    <div class="overview-cards" id="overview-cards">
        <!-- 将通过JavaScript动态生成 -->
    </div>

    <!-- ECC排名区域 -->
    <div class="ranking-section">
        <div class="section-title">
            <i class="fas fa-trophy"></i>
            ECC排名对比
        </div>
        <div class="ranking-tabs">
            <button class="ranking-tab active" onclick="switchRankingTab('energy', this)">用能量排名</button>
            <button class="ranking-tab" onclick="switchRankingTab('cost', this)">成本排名</button>
            <button class="ranking-tab" onclick="switchRankingTab('coal', this)">标煤排名</button>
            <button class="ranking-tab" onclick="switchRankingTab('area', this)">单位面积排名</button>
            <button class="ranking-tab" onclick="switchRankingTab('person', this)">人均能耗排名</button>
            <button class="ranking-tab" onclick="switchRankingTab('carbon', this)">碳排放排名</button>
        </div>
        <div class="ranking-list" id="ranking-list">
            <!-- 排名列表将通过JavaScript动态生成 -->
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="charts-section">
        <div class="chart-panel">
            <div class="chart-title">
                <i class="fas fa-chart-line"></i>
                ECC能耗趋势对比
            </div>
            <div class="chart-container" id="trend-chart">
                <!-- 图表将通过JavaScript动态生成 -->
            </div>
        </div>
        <div class="chart-panel">
            <div class="chart-title">
                <i class="fas fa-chart-bar"></i>
                ECC能耗对比
            </div>
            <div class="chart-container" id="comparison-chart">
                <!-- 图表将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 详细数据表格 -->
    <div class="data-table-section">
        <div class="section-title">
            <i class="fas fa-table"></i>
            详细数据
        </div>
        <table class="data-table" id="detail-table">
            <thead>
                <tr>
                    <th>ECC名称</th>
                    <th>ECC编码</th>
                    <th>ECC级别</th>
                    <th>用能量 (kWh)</th>
                    <th>成本 (元)</th>
                    <th>标煤 (kg)</th>
                    <th>单位面积 (kWh/m²)</th>
                    <th>人均能耗 (kWh/人)</th>
                    <th>碳排放 (kg CO₂)</th>
                </tr>
            </thead>
            <tbody id="detail-table-body">
                <!-- 将通过JavaScript动态生成 -->
            </tbody>
        </table>
    </div>

    <script>
        let currentData = null;
        let currentRankingType = 'energy';
        let eccList = [];

        // 初始化
        function initECCEnergyStatistics() {
            loadECCList();
            initDateTimeInputs();
            queryData();
        }

        // 加载ECC列表
        function loadECCList() {
            const stored = localStorage.getItem('ecc-list');
            if (stored) {
                eccList = JSON.parse(stored);
            } else {
                eccList = [];
            }
            
            const select = document.getElementById('ecc-select');
            select.innerHTML = '<option value="all">全部ECC</option>';
            eccList.forEach(ecc => {
                const option = document.createElement('option');
                option.value = ecc.id;
                option.textContent = `${ecc.name} (${ecc.code})`;
                select.appendChild(option);
            });
        }

        // 初始化日期时间输入
        function initDateTimeInputs() {
            const now = new Date();
            const startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); // 7天前
            
            document.getElementById('start-time').value = formatDateTimeLocal(startTime);
            document.getElementById('end-time').value = formatDateTimeLocal(now);
        }

        // 格式化日期时间为本地格式
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // 查询数据
        function queryData() {
            const timeGranularity = document.getElementById('time-granularity').value;
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const eccLevel = document.getElementById('ecc-level-filter').value;
            const eccId = document.getElementById('ecc-select').value;
            
            // 生成模拟数据
            const data = generateMockData(timeGranularity, startTime, endTime, eccLevel, eccId);
            currentData = data;
            
            updateOverview(data);
            updateRanking(data, currentRankingType);
            renderTrendChart(data);
            renderComparisonChart(data);
            updateDetailTable(data);
        }

        // 生成模拟数据
        function generateMockData(granularity, startTime, endTime, eccLevel, eccId) {
            const start = new Date(startTime);
            const end = new Date(endTime);
            
            // 过滤ECC
            let filteredECC = eccList;
            if (eccLevel !== 'all') {
                filteredECC = filteredECC.filter(ecc => ecc.level === eccLevel);
            }
            if (eccId !== 'all') {
                filteredECC = filteredECC.filter(ecc => ecc.id === eccId);
            }
            
            if (filteredECC.length === 0) {
                filteredECC = [
                    { id: 'ecc-1', name: 'XX制造有限公司', code: 'ECC001', level: 'company' },
                    { id: 'ecc-2', name: '生产车间A', code: 'ECC002', level: 'workshop' },
                    { id: 'ecc-3', name: '注塑产线1', code: 'ECC005', level: 'production-line' },
                    { id: 'ecc-4', name: '辅助设施中心', code: 'ECC010', level: 'workshop' },
                    { id: 'ecc-5', name: '仓储物流中心', code: 'ECC011', level: 'workshop' }
                ];
            }
            
            const data = {
                eccList: filteredECC,
                timeData: [],
                summary: {
                    totalEnergy: 0,
                    totalCost: 0,
                    totalCoal: 0,
                    totalArea: 0,
                    totalPerson: 0,
                    totalCarbon: 0
                }
            };
            
            // 根据粒度生成时间点
            let currentTime = new Date(start);
            const timePoints = [];
            
            while (currentTime <= end) {
                timePoints.push(new Date(currentTime));
                
                if (granularity === 'hour') {
                    currentTime.setHours(currentTime.getHours() + 1);
                } else if (granularity === 'day') {
                    currentTime.setDate(currentTime.getDate() + 1);
                } else if (granularity === 'week') {
                    currentTime.setDate(currentTime.getDate() + 7);
                } else if (granularity === 'month') {
                    currentTime.setMonth(currentTime.getMonth() + 1);
                }
            }
            
            // 为每个ECC生成数据
            filteredECC.forEach(ecc => {
                const baseEnergy = 100 + Math.random() * 200; // 基础能耗
                const area = 500 + Math.random() * 500; // 面积 m²
                const personCount = 10 + Math.floor(Math.random() * 20); // 人数
                
                timePoints.forEach((timePoint, index) => {
                    // 模拟能耗波动
                    const energy = baseEnergy * (0.8 + Math.random() * 0.4) * (granularity === 'hour' ? 1 : (granularity === 'day' ? 24 : (granularity === 'week' ? 168 : 720)));
                    const cost = energy * (0.6 + Math.random() * 0.1); // 电价约0.65元/kWh
                    const coal = energy * 0.1229; // 标煤转换系数
                    const areaEnergy = energy / area;
                    const personEnergy = energy / personCount;
                    const carbon = energy * 0.581; // 碳排放系数 kg CO₂/kWh
                    
                    data.timeData.push({
                        time: timePoint.toISOString(),
                        eccId: ecc.id,
                        energy: Math.round(energy * 10) / 10,
                        cost: Math.round(cost * 10) / 10,
                        coal: Math.round(coal * 10) / 10,
                        areaEnergy: Math.round(areaEnergy * 100) / 100,
                        personEnergy: Math.round(personEnergy * 10) / 10,
                        carbon: Math.round(carbon * 10) / 10,
                        area: area,
                        personCount: personCount
                    });
                    
                    data.summary.totalEnergy += energy;
                    data.summary.totalCost += cost;
                    data.summary.totalCoal += coal;
                    data.summary.totalArea += area;
                    data.summary.totalPerson += personCount;
                    data.summary.totalCarbon += carbon;
                });
            });
            
            return data;
        }

        // 更新概览卡片
        function updateOverview(data) {
            const container = document.getElementById('overview-cards');
            const summary = data.summary;
            const eccCount = data.eccList.length;
            
            container.innerHTML = `
                <div class="overview-card">
                    <div class="overview-card-label">统计ECC数量</div>
                    <div class="overview-card-value">${eccCount}</div>
                    <div class="overview-card-unit">个</div>
                </div>
                <div class="overview-card">
                    <div class="overview-card-label">总用能量</div>
                    <div class="overview-card-value">${summary.totalEnergy.toFixed(1)}</div>
                    <div class="overview-card-unit">kWh</div>
                </div>
                <div class="overview-card">
                    <div class="overview-card-label">总成本</div>
                    <div class="overview-card-value">¥${summary.totalCost.toFixed(2)}</div>
                    <div class="overview-card-unit">元</div>
                </div>
                <div class="overview-card">
                    <div class="overview-card-label">总标煤</div>
                    <div class="overview-card-value">${summary.totalCoal.toFixed(1)}</div>
                    <div class="overview-card-unit">kg</div>
                </div>
                <div class="overview-card">
                    <div class="overview-card-label">平均单位面积</div>
                    <div class="overview-card-value">${(summary.totalEnergy / summary.totalArea).toFixed(2)}</div>
                    <div class="overview-card-unit">kWh/m²</div>
                </div>
                <div class="overview-card">
                    <div class="overview-card-label">平均人均能耗</div>
                    <div class="overview-card-value">${(summary.totalEnergy / summary.totalPerson).toFixed(1)}</div>
                    <div class="overview-card-unit">kWh/人</div>
                </div>
                <div class="overview-card">
                    <div class="overview-card-label">总碳排放</div>
                    <div class="overview-card-value">${summary.totalCarbon.toFixed(1)}</div>
                    <div class="overview-card-unit">kg CO₂</div>
                </div>
            `;
        }

        // 切换排名标签
        function switchRankingTab(type, element) {
            currentRankingType = type;
            document.querySelectorAll('.ranking-tab').forEach(tab => tab.classList.remove('active'));
            element.classList.add('active');
            if (currentData) {
                updateRanking(currentData, type);
            }
        }

        // 更新排名
        function updateRanking(data, type) {
            const container = document.getElementById('ranking-list');
            
            // 计算每个ECC的汇总数据
            const eccSummary = {};
            data.eccList.forEach(ecc => {
                const eccData = data.timeData.filter(d => d.eccId === ecc.id);
                eccSummary[ecc.id] = {
                    ecc: ecc,
                    energy: eccData.reduce((sum, d) => sum + d.energy, 0),
                    cost: eccData.reduce((sum, d) => sum + d.cost, 0),
                    coal: eccData.reduce((sum, d) => sum + d.coal, 0),
                    areaEnergy: eccData.length > 0 ? eccData[0].areaEnergy : 0,
                    personEnergy: eccData.reduce((sum, d) => sum + d.personEnergy, 0) / eccData.length || 0,
                    carbon: eccData.reduce((sum, d) => sum + d.carbon, 0)
                };
            });
            
            // 根据类型排序
            const rankingConfig = {
                energy: { key: 'energy', label: '用能量', unit: 'kWh' },
                cost: { key: 'cost', label: '成本', unit: '元' },
                coal: { key: 'coal', label: '标煤', unit: 'kg' },
                area: { key: 'areaEnergy', label: '单位面积', unit: 'kWh/m²' },
                person: { key: 'personEnergy', label: '人均能耗', unit: 'kWh/人' },
                carbon: { key: 'carbon', label: '碳排放', unit: 'kg CO₂' }
            };
            
            const config = rankingConfig[type];
            const sorted = Object.values(eccSummary).sort((a, b) => b[config.key] - a[config.key]);
            
            container.innerHTML = sorted.map((item, index) => {
                const rankClass = index === 0 ? 'top1' : index === 1 ? 'top2' : index === 2 ? 'top3' : 'other';
                const levelNames = {
                    company: '公司工厂级',
                    workshop: '车间级',
                    'production-line': '产线级',
                    process: '工序级',
                    equipment: '设备级',
                    team: '班组级'
                };
                
                return `
                    <div class="ranking-item">
                        <div class="ranking-number ${rankClass}">${index + 1}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${item.ecc.name}</div>
                            <div class="ranking-code">${item.ecc.code} | ${levelNames[item.ecc.level] || item.ecc.level}</div>
                        </div>
                        <div class="ranking-value">
                            <div class="ranking-value-main">${item[config.key].toFixed(2)}</div>
                            <div class="ranking-value-label">${config.label} (${config.unit})</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 渲染趋势图
        function renderTrendChart(data) {
            const container = document.getElementById('trend-chart');
            const containerWidth = container.offsetWidth || container.clientWidth || 800;
            const containerHeight = 400;
            const padding = 70;
            const width = Math.max(containerWidth - 20, 600);
            const height = containerHeight - 20;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2 - 30;
            
            // 按时间汇总数据
            const timeMap = {};
            data.timeData.forEach(d => {
                const timeKey = new Date(d.time).toISOString().split('T')[0];
                if (!timeMap[timeKey]) {
                    timeMap[timeKey] = {};
                }
                if (!timeMap[timeKey][d.eccId]) {
                    timeMap[timeKey][d.eccId] = 0;
                }
                timeMap[timeKey][d.eccId] += d.energy;
            });
            
            const timeKeys = Object.keys(timeMap).sort();
            const maxEnergy = Math.max(...Object.values(timeMap).flatMap(day => Object.values(day))) * 1.1;
            const svgWidth = width;
            const svgHeight = height;
            
            const colors = ['#00bcd4', '#4caf50', '#ff9800', '#9c27b0', '#f44336', '#2196f3'];
            
            let svg = `
                <svg width="100%" height="100%" viewBox="0 0 ${svgWidth} ${svgHeight}" preserveAspectRatio="xMidYMid meet" style="max-width: 100%;">
                    <!-- 网格线 -->
                    ${Array.from({length: 5}, (_, i) => {
                        const y = padding + (chartHeight / 4) * i;
                        return `<line x1="${padding}" y1="${y}" x2="${svgWidth - padding}" y2="${y}" stroke="#3c5472" stroke-width="0.5" opacity="0.5"/>`;
                    }).join('')}
                    
                    <!-- Y轴标签 -->
                    ${Array.from({length: 5}, (_, i) => {
                        const y = padding + (chartHeight / 4) * i;
                        const value = maxEnergy - (maxEnergy / 4) * i;
                        return `<text x="${padding - 15}" y="${y + 5}" fill="#a7bed3" font-size="11" text-anchor="end">${Math.round(value)}</text>`;
                    }).join('')}
                    
                    <!-- 多条趋势线 -->
                    ${data.eccList.slice(0, 6).map((ecc, eccIndex) => {
                        const points = timeKeys.map((timeKey, i) => {
                            const x = padding + (chartWidth / (timeKeys.length - 1 || 1)) * i;
                            const energy = timeMap[timeKey][ecc.id] || 0;
                            const y = padding + chartHeight - (energy / maxEnergy) * chartHeight;
                            return `${x},${y}`;
                        }).join(' ');
                        
                        return `
                            <polyline points="${points}" 
                                fill="none" stroke="${colors[eccIndex % colors.length]}" stroke-width="2" opacity="0.8">
                                <title>${ecc.name}</title>
                            </polyline>
                        `;
                    }).join('')}
                    
                    <!-- X轴标签 -->
                    ${timeKeys.filter((_, i) => i % Math.max(1, Math.floor(timeKeys.length / 5)) === 0 || i === timeKeys.length - 1).map((timeKey, i) => {
                        const index = timeKeys.findIndex(t => t === timeKey);
                        const x = padding + (chartWidth / (timeKeys.length - 1 || 1)) * index;
                        const date = new Date(timeKey);
                        return `<text x="${x}" y="${padding + chartHeight + 25}" fill="#a7bed3" font-size="11" text-anchor="middle">${(date.getMonth() + 1)}/${date.getDate()}</text>`;
                    }).join('')}
                    
                    <!-- 图例 -->
                    <g transform="translate(${svgWidth - 200}, 20)">
                        ${data.eccList.slice(0, 6).map((ecc, i) => `
                            <line x1="0" y1="${i * 20 + 10}" x2="30" y2="${i * 20 + 10}" stroke="${colors[i % colors.length]}" stroke-width="2"/>
                            <text x="35" y="${i * 20 + 13}" fill="#a7bed3" font-size="11">${ecc.name}</text>
                        `).join('')}
                    </g>
                </svg>
            `;
            
            container.innerHTML = svg;
        }

        // 渲染对比图
        function renderComparisonChart(data) {
            const container = document.getElementById('comparison-chart');
            const containerWidth = container.offsetWidth || container.clientWidth || 800;
            const containerHeight = 400;
            const padding = 70;
            const width = Math.max(containerWidth - 20, 600);
            const height = containerHeight - 20;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2 - 30;
            
            // 计算每个ECC的总能耗
            const eccSummary = {};
            data.eccList.forEach(ecc => {
                const eccData = data.timeData.filter(d => d.eccId === ecc.id);
                eccSummary[ecc.id] = {
                    ecc: ecc,
                    energy: eccData.reduce((sum, d) => sum + d.energy, 0)
                };
            });
            
            const sorted = Object.values(eccSummary).sort((a, b) => b.energy - a.energy).slice(0, 10);
            const maxEnergy = Math.max(...sorted.map(s => s.energy)) * 1.1;
            const svgWidth = width;
            const svgHeight = height;
            const barWidth = chartWidth / (sorted.length * 1.5);
            const colors = ['#00bcd4', '#4caf50', '#ff9800', '#9c27b0', '#f44336', '#2196f3', '#795548', '#607d8b', '#e91e63', '#009688'];
            
            let svg = `
                <svg width="100%" height="100%" viewBox="0 0 ${svgWidth} ${svgHeight}" preserveAspectRatio="xMidYMid meet" style="max-width: 100%;">
                    <!-- 网格线 -->
                    ${Array.from({length: 5}, (_, i) => {
                        const y = padding + (chartHeight / 4) * i;
                        return `<line x1="${padding}" y1="${y}" x2="${svgWidth - padding}" y2="${y}" stroke="#3c5472" stroke-width="0.5" opacity="0.5"/>`;
                    }).join('')}
                    
                    <!-- Y轴标签 -->
                    ${Array.from({length: 5}, (_, i) => {
                        const y = padding + (chartHeight / 4) * i;
                        const value = maxEnergy - (maxEnergy / 4) * i;
                        return `<text x="${padding - 15}" y="${y + 5}" fill="#a7bed3" font-size="11" text-anchor="end">${Math.round(value)}</text>`;
                    }).join('')}
                    
                    <!-- 柱状图 -->
                    ${sorted.map((item, i) => {
                        const x = padding + (chartWidth / sorted.length) * i + (chartWidth / sorted.length) * 0.25;
                        const barHeight = (item.energy / maxEnergy) * chartHeight;
                        const y = padding + chartHeight - barHeight;
                        
                        return `
                            <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${colors[i % colors.length]}" opacity="0.8">
                                <title>${item.ecc.name}: ${item.energy.toFixed(1)} kWh</title>
                            </rect>
                            <text x="${x + barWidth / 2}" y="${y - 5}" fill="#a7bed3" font-size="10" text-anchor="middle">${item.energy.toFixed(0)}</text>
                        `;
                    }).join('')}
                    
                    <!-- X轴标签 -->
                    ${sorted.map((item, i) => {
                        const x = padding + (chartWidth / sorted.length) * i + (chartWidth / sorted.length) * 0.5;
                        return `<text x="${x}" y="${padding + chartHeight + 25}" fill="#a7bed3" font-size="11" text-anchor="middle" transform="rotate(-45 ${x} ${padding + chartHeight + 25})">${item.ecc.name}</text>`;
                    }).join('')}
                </svg>
            `;
            
            container.innerHTML = svg;
        }

        // 更新详细数据表格
        function updateDetailTable(data) {
            const tbody = document.getElementById('detail-table-body');
            
            // 计算每个ECC的汇总数据
            const eccSummary = {};
            data.eccList.forEach(ecc => {
                const eccData = data.timeData.filter(d => d.eccId === ecc.id);
                eccSummary[ecc.id] = {
                    ecc: ecc,
                    energy: eccData.reduce((sum, d) => sum + d.energy, 0),
                    cost: eccData.reduce((sum, d) => sum + d.cost, 0),
                    coal: eccData.reduce((sum, d) => sum + d.coal, 0),
                    areaEnergy: eccData.length > 0 ? eccData[0].areaEnergy : 0,
                    personEnergy: eccData.reduce((sum, d) => sum + d.personEnergy, 0) / eccData.length || 0,
                    carbon: eccData.reduce((sum, d) => sum + d.carbon, 0)
                };
            });
            
            const levelNames = {
                company: '公司工厂级',
                workshop: '车间级',
                'production-line': '产线级',
                process: '工序级',
                equipment: '设备级',
                team: '班组级'
            };
            
            const rows = Object.values(eccSummary).map(item => `
                <tr>
                    <td>${item.ecc.name}</td>
                    <td>${item.ecc.code}</td>
                    <td>${levelNames[item.ecc.level] || item.ecc.level}</td>
                    <td>${item.energy.toFixed(1)}</td>
                    <td>${item.cost.toFixed(2)}</td>
                    <td>${item.coal.toFixed(1)}</td>
                    <td>${item.areaEnergy.toFixed(2)}</td>
                    <td>${item.personEnergy.toFixed(1)}</td>
                    <td>${item.carbon.toFixed(1)}</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = rows || '<tr><td colspan="9" class="empty-state">暂无数据</td></tr>';
        }

        // 导出数据
        function exportData() {
            alert('导出功能开发中...');
        }

        // 页面加载时自动初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initECCEnergyStatistics);
        } else {
            initECCEnergyStatistics();
        }
    </script>
</div>
