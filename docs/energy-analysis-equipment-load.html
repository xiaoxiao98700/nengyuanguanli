<div class="equipment-load-container">
    <style>
        /* 统一滚动条样式 */
        * {
            scrollbar-width: thin;
            scrollbar-color: #3c5472 #1a2a3a;
        }
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1a2a3a;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3c5472;
            border-radius: 5px;
            border: 2px solid #1a2a3a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a6a8a;
        }
        ::-webkit-scrollbar-thumb:active {
            background: #00bcd4;
        }
        ::-webkit-scrollbar-corner {
            background: #1a2a3a;
        }
        
        .equipment-load-container {
            padding: 20px;
            background-color: #0f1e2d;
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 24px;
            color: #00bcd4;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .page-description {
            color: #a7bed3;
            font-size: 14px;
            margin-top: 8px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* 筛选区域 */
        .filter-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-item label {
            color: #a7bed3;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-select {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            color: #e0e6ed;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .filter-select:hover {
            border-color: #00bcd4;
        }

        .query-button, .export-button {
            background-color: #00bcd4;
            border: none;
            color: #1a2a3a;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .query-button:hover, .export-button:hover {
            background-color: #00acc1;
            transform: translateY(-1px);
        }

        .export-button {
            background-color: #3c5472;
            color: #e0e6ed;
        }

        .export-button:hover {
            background-color: #4a6a8a;
        }

        /* 设备列表 */
        .equipment-list-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .section-title {
            font-size: 18px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .equipment-list-wrapper {
            position: relative;
            overflow: hidden;
        }

        .equipment-grid {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            padding: 10px 0;
        }

        /* 横向滚动条使用较小高度 */
        .equipment-grid::-webkit-scrollbar {
            height: 10px;
        }

        .equipment-card {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 0 0 200px; /* 固定宽度，不缩放 */
            min-width: 200px;
        }

        /* 左右箭头按钮 */
        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            color: #00bcd4;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .scroll-arrow:hover {
            background-color: #00bcd4;
            color: #1a2a3a;
            border-color: #00bcd4;
            transform: translateY(-50%) scale(1.1);
        }

        .scroll-arrow.left {
            left: 10px;
        }

        .scroll-arrow.right {
            right: 10px;
        }

        .scroll-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .scroll-arrow:disabled:hover {
            background-color: #2a3d54;
            color: #00bcd4;
            transform: translateY(-50%);
        }

        .equipment-card:hover {
            border-color: #00bcd4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 188, 212, 0.2);
        }

        .equipment-card.active {
            border-color: #00bcd4;
            background-color: #1e2d3f;
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.3);
        }

        .equipment-name {
            font-size: 14px;
            color: #e0e6ed;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .equipment-info {
            font-size: 12px;
            color: #a7bed3;
            margin-bottom: 4px;
        }

        .equipment-load-rate {
            font-size: 16px;
            color: #00bcd4;
            font-weight: bold;
            margin-top: 8px;
        }

        /* 图表区域 */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-panel {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            font-size: 16px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            padding: 10px;
        }

        .chart-container svg {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: block;
            box-sizing: border-box;
        }

        /* 数据表格 */
        .data-table-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: #1a2a3a;
            color: #a7bed3;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: normal;
            border-bottom: 2px solid #3c5472;
        }

        .data-table td {
            padding: 12px;
            color: #e0e6ed;
            font-size: 13px;
            border-bottom: 1px solid #3c5472;
        }

        .data-table tr:hover {
            background-color: #1e2d3f;
        }

        .load-rate-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .load-rate-badge.low {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .load-rate-badge.medium {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .load-rate-badge.high {
            background-color: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5d7d9a;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>

    <div class="page-header">
        <h2 class="page-title"><i class="fas fa-chart-area"></i> 设备负荷分析</h2>
    </div>

    <!-- 筛选区域 -->
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-item">
                <label>时间范围:</label>
                <select id="time-range" class="filter-select">
                    <option value="today" selected>今日</option>
                    <option value="yesterday">昨日</option>
                    <option value="week">本周</option>
                    <option value="month">本月</option>
                    <option value="custom">自定义</option>
                </select>
            </div>
            <div class="filter-item" id="custom-date-range" style="display: none;">
                <label>开始日期:</label>
                <input type="date" id="start-date" class="filter-select">
                <label>结束日期:</label>
                <input type="date" id="end-date" class="filter-select">
            </div>
            <div class="filter-item">
                <label>站点:</label>
                <select id="site-select" class="filter-select">
                    <option value="all">全部站点</option>
                    <option value="site1">生产车间1</option>
                    <option value="site2">生产车间2</option>
                    <option value="site3">生产车间3</option>
                    <option value="site4">办公楼</option>
                    <option value="site5">辅助设施</option>
                    <option value="site6">仓储物流</option>
                    <option value="site7">研发中心</option>
                    <option value="site8">生活配套区</option>
                </select>
            </div>
            <div class="filter-item">
                <label>设备类型:</label>
                <select id="equipment-type" class="filter-select">
                    <option value="all">全部设备</option>
                    <option value="motor">电机</option>
                    <option value="compressor">压缩机</option>
                    <option value="pump">水泵</option>
                    <option value="fan">风机</option>
                    <option value="lighting">照明</option>
                    <option value="other">其他</option>
                </select>
            </div>
            <div class="filter-item">
                <button class="query-button" id="query-btn">
                    <i class="fas fa-search"></i> 查询
                </button>
                <button class="export-button" id="export-btn">
                    <i class="fas fa-download"></i> 导出
                </button>
            </div>
        </div>
    </div>

    <!-- 设备列表 -->
    <div class="equipment-list-section">
        <h3 class="section-title">
            <i class="fas fa-server"></i> 设备列表
        </h3>
        <div class="equipment-list-wrapper">
            <button class="scroll-arrow left" id="scroll-left" onclick="scrollEquipmentList('left')" aria-label="向左滚动">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="equipment-grid" id="equipment-grid">
                <!-- 设备卡片将通过JavaScript动态生成 -->
            </div>
            <button class="scroll-arrow right" id="scroll-right" onclick="scrollEquipmentList('right')" aria-label="向右滚动">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="charts-section">
        <!-- 日负荷率图表 -->
        <div class="chart-panel">
            <h3 class="chart-title">
                <i class="fas fa-chart-line"></i> 设备日负荷率
            </h3>
            <div class="chart-container" id="load-rate-chart">
                <div class="empty-state">
                    <i class="fas fa-chart-line"></i>
                    <p>请选择设备查看日负荷率</p>
                </div>
            </div>
        </div>

        <!-- 日负荷持续时间图 -->
        <div class="chart-panel">
            <h3 class="chart-title">
                <i class="fas fa-chart-bar"></i> 设备日负荷持续时间
            </h3>
            <div class="chart-container" id="duration-chart">
                <div class="empty-state">
                    <i class="fas fa-chart-bar"></i>
                    <p>请选择设备查看负荷持续时间</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据表格 -->
    <div class="data-table-section">
        <div class="table-header">
            <h3 class="section-title">
                <i class="fas fa-table"></i> 设备负荷明细
            </h3>
        </div>
        <table class="data-table" id="load-table">
            <thead>
                <tr>
                    <th>设备名称</th>
                    <th>站点</th>
                    <th>设备类型</th>
                    <th>额定功率(kW)</th>
                    <th>当前负荷(kW)</th>
                    <th>负荷率(%)</th>
                    <th>运行时长(h)</th>
                    <th>平均负荷率(%)</th>
                    <th>最大负荷(kW)</th>
                    <th>最小负荷(kW)</th>
                </tr>
            </thead>
            <tbody id="load-table-body">
                <!-- 表格数据将通过JavaScript动态生成 -->
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
// 每次页面加载时都重新初始化，确保数据不会被其他页面影响
// 清除可能存在的旧数据
if (window.__equipmentLoadModuleLoaded) {
    // 如果已加载，清除旧状态并重新初始化
    window.__equipmentLoadModuleLoaded = false;
    if (window.selectedLoadEquipment !== undefined) {
        window.selectedLoadEquipment = null;
    }
    if (window.equipmentLoadCurrentData !== undefined) {
        window.equipmentLoadCurrentData = null;
    }
}
window.__equipmentLoadModuleLoaded = true;

// 每次页面加载时都重新初始化数据，确保数据不会被其他页面影响
const equipmentLoadProfiles = {
    1: [52, 50, 48, 45, 43, 42, 48, 60, 72, 80, 85, 88, 90, 87, 82, 80, 78, 75, 70, 68, 65, 60, 58, 55],
    2: [60, 58, 55, 52, 50, 48, 55, 65, 78, 84, 88, 92, 93, 90, 86, 82, 78, 75, 72, 68, 65, 62, 60, 58],
    3: [40, 38, 36, 35, 34, 33, 35, 40, 50, 58, 62, 65, 68, 66, 62, 58, 55, 52, 48, 45, 42, 40, 38, 36],
    4: [45, 44, 43, 42, 41, 40, 45, 55, 65, 72, 78, 82, 84, 80, 76, 72, 68, 64, 60, 58, 55, 52, 50, 48],
    5: [35, 34, 33, 32, 31, 30, 34, 40, 50, 60, 65, 68, 70, 68, 64, 60, 58, 55, 52, 50, 48, 46, 44, 42],
    6: [48, 46, 44, 42, 40, 39, 45, 55, 68, 74, 78, 80, 82, 80, 76, 72, 68, 64, 60, 58, 55, 52, 50, 48],
    7: [55, 53, 50, 48, 46, 44, 50, 62, 75, 82, 86, 89, 91, 88, 84, 81, 79, 76, 72, 70, 67, 63, 61, 58],
    8: [65, 63, 60, 58, 56, 54, 60, 70, 82, 88, 92, 94, 95, 92, 88, 85, 82, 79, 75, 73, 70, 67, 65, 62],
    9: [38, 36, 34, 33, 32, 31, 33, 38, 48, 56, 60, 63, 65, 63, 59, 55, 52, 49, 45, 42, 39, 37, 35, 33],
    10: [42, 40, 38, 37, 36, 35, 38, 45, 55, 63, 67, 70, 72, 70, 66, 62, 59, 56, 52, 49, 46, 43, 41, 39],
    11: [30, 28, 26, 25, 24, 23, 25, 30, 40, 50, 55, 58, 60, 58, 54, 50, 47, 44, 40, 37, 34, 32, 30, 28],
    12: [50, 48, 46, 44, 42, 41, 47, 57, 70, 77, 81, 84, 86, 83, 79, 75, 72, 69, 65, 62, 59, 56, 54, 51],
    13: [70, 68, 65, 63, 61, 59, 65, 75, 85, 90, 93, 95, 96, 94, 90, 87, 84, 81, 77, 75, 72, 69, 67, 64],
    14: [33, 31, 29, 28, 27, 26, 28, 33, 43, 51, 55, 58, 60, 58, 54, 50, 47, 44, 40, 37, 34, 32, 30, 28],
    15: [58, 56, 54, 52, 50, 49, 55, 65, 78, 85, 89, 92, 94, 91, 87, 83, 80, 77, 73, 70, 67, 64, 62, 59],
    16: [47, 45, 43, 41, 39, 38, 44, 54, 67, 74, 78, 81, 83, 80, 76, 72, 69, 66, 62, 59, 56, 53, 51, 48],
    17: [62, 60, 58, 56, 54, 53, 59, 69, 81, 88, 92, 95, 97, 94, 90, 86, 83, 80, 76, 73, 70, 67, 65, 62],
    18: [36, 34, 32, 31, 30, 29, 31, 36, 46, 54, 58, 61, 63, 61, 57, 53, 50, 47, 43, 40, 37, 35, 33, 31]
};

// 设备数据（示例）
let equipmentLoadData = [
    { id: 1, name: '主电机', site: '生产车间1', type: 'motor', ratedPower: 100, currentLoad: 75, loadRate: 75, runtime: 8.5, avgLoadRate: 72, maxLoad: 95, minLoad: 45, hourlyLoadRates: equipmentLoadProfiles[1] },
    { id: 2, name: '压缩机', site: '生产车间2', type: 'compressor', ratedPower: 150, currentLoad: 120, loadRate: 80, runtime: 7.2, avgLoadRate: 78, maxLoad: 145, minLoad: 60, hourlyLoadRates: equipmentLoadProfiles[2] },
    { id: 3, name: '水泵', site: '办公楼', type: 'pump', ratedPower: 30, currentLoad: 18, loadRate: 60, runtime: 6.0, avgLoadRate: 58, maxLoad: 28, minLoad: 10, hourlyLoadRates: equipmentLoadProfiles[3] },
    { id: 4, name: '风机', site: '辅助设施', type: 'fan', ratedPower: 50, currentLoad: 35, loadRate: 70, runtime: 9.0, avgLoadRate: 68, maxLoad: 48, minLoad: 20, hourlyLoadRates: equipmentLoadProfiles[4] },
    { id: 5, name: '照明系统', site: '生产车间1', type: 'lighting', ratedPower: 20, currentLoad: 15, loadRate: 75, runtime: 10.0, avgLoadRate: 73, maxLoad: 18, minLoad: 12, hourlyLoadRates: equipmentLoadProfiles[5] },
    { id: 6, name: '辅助电机', site: '生产车间2', type: 'motor', ratedPower: 80, currentLoad: 55, loadRate: 68.75, runtime: 8.0, avgLoadRate: 65, maxLoad: 75, minLoad: 35, hourlyLoadRates: equipmentLoadProfiles[6] },
    { id: 7, name: '主电机', site: '生产车间3', type: 'motor', ratedPower: 120, currentLoad: 88, loadRate: 73.33, runtime: 8.8, avgLoadRate: 71, maxLoad: 110, minLoad: 50, hourlyLoadRates: equipmentLoadProfiles[7] },
    { id: 8, name: '主压缩机', site: '辅助设施', type: 'compressor', ratedPower: 200, currentLoad: 160, loadRate: 80, runtime: 7.5, avgLoadRate: 78, maxLoad: 190, minLoad: 70, hourlyLoadRates: equipmentLoadProfiles[8] },
    { id: 9, name: '循环水泵', site: '辅助设施', type: 'pump', ratedPower: 45, currentLoad: 27, loadRate: 60, runtime: 6.5, avgLoadRate: 58, maxLoad: 42, minLoad: 15, hourlyLoadRates: equipmentLoadProfiles[9] },
    { id: 10, name: '排风机', site: '辅助设施', type: 'fan', ratedPower: 75, currentLoad: 52, loadRate: 69.33, runtime: 9.2, avgLoadRate: 67, maxLoad: 68, minLoad: 28, hourlyLoadRates: equipmentLoadProfiles[10] },
    { id: 11, name: '照明系统', site: '仓储物流', type: 'lighting', ratedPower: 25, currentLoad: 18, loadRate: 72, runtime: 10.5, avgLoadRate: 70, maxLoad: 22, minLoad: 14, hourlyLoadRates: equipmentLoadProfiles[11] },
    { id: 12, name: '驱动电机', site: '生产车间3', type: 'motor', ratedPower: 90, currentLoad: 68, loadRate: 75.56, runtime: 8.3, avgLoadRate: 73, maxLoad: 85, minLoad: 40, hourlyLoadRates: equipmentLoadProfiles[12] },
    { id: 13, name: '给水泵', site: '辅助设施', type: 'pump', ratedPower: 55, currentLoad: 45, loadRate: 81.82, runtime: 7.8, avgLoadRate: 79, maxLoad: 52, minLoad: 25, hourlyLoadRates: equipmentLoadProfiles[13] },
    { id: 14, name: '新风风机', site: '办公楼', type: 'fan', ratedPower: 35, currentLoad: 21, loadRate: 60, runtime: 6.2, avgLoadRate: 58, maxLoad: 32, minLoad: 12, hourlyLoadRates: equipmentLoadProfiles[14] },
    { id: 15, name: '输送电机', site: '生产车间2', type: 'motor', ratedPower: 70, currentLoad: 52, loadRate: 74.29, runtime: 8.6, avgLoadRate: 72, maxLoad: 66, minLoad: 30, hourlyLoadRates: equipmentLoadProfiles[15] },
    { id: 16, name: '冷却泵', site: '辅助设施', type: 'pump', ratedPower: 60, currentLoad: 42, loadRate: 70, runtime: 7.0, avgLoadRate: 68, maxLoad: 57, minLoad: 22, hourlyLoadRates: equipmentLoadProfiles[16] },
    { id: 17, name: '空压机', site: '生产车间1', type: 'compressor', ratedPower: 180, currentLoad: 144, loadRate: 80, runtime: 7.3, avgLoadRate: 78, maxLoad: 172, minLoad: 65, hourlyLoadRates: equipmentLoadProfiles[17] },
    { id: 18, name: '照明设备', site: '生产车间2', type: 'lighting', ratedPower: 15, currentLoad: 11, loadRate: 73.33, runtime: 9.8, avgLoadRate: 71, maxLoad: 14, minLoad: 8, hourlyLoadRates: equipmentLoadProfiles[18] },
    { id: 19, name: '注塑机电机', site: '生产车间3', type: 'motor', ratedPower: 110, currentLoad: 82, loadRate: 74.55, runtime: 8.4, avgLoadRate: 72, maxLoad: 105, minLoad: 48, hourlyLoadRates: equipmentLoadProfiles[1] },
    { id: 20, name: '备用压缩机', site: '辅助设施', type: 'compressor', ratedPower: 160, currentLoad: 128, loadRate: 80, runtime: 7.1, avgLoadRate: 78, maxLoad: 155, minLoad: 62, hourlyLoadRates: equipmentLoadProfiles[2] },
    { id: 21, name: '消防水泵', site: '辅助设施', type: 'pump', ratedPower: 40, currentLoad: 24, loadRate: 60, runtime: 6.3, avgLoadRate: 58, maxLoad: 38, minLoad: 14, hourlyLoadRates: equipmentLoadProfiles[3] },
    { id: 22, name: '送风机', site: '生产车间1', type: 'fan', ratedPower: 65, currentLoad: 46, loadRate: 70.77, runtime: 9.1, avgLoadRate: 69, maxLoad: 60, minLoad: 26, hourlyLoadRates: equipmentLoadProfiles[4] },
    { id: 23, name: '应急照明', site: '办公楼', type: 'lighting', ratedPower: 12, currentLoad: 9, loadRate: 75, runtime: 10.2, avgLoadRate: 73, maxLoad: 11, minLoad: 7, hourlyLoadRates: equipmentLoadProfiles[5] },
    { id: 24, name: '切割机电机', site: '生产车间2', type: 'motor', ratedPower: 95, currentLoad: 71, loadRate: 74.74, runtime: 8.7, avgLoadRate: 73, maxLoad: 90, minLoad: 38, hourlyLoadRates: equipmentLoadProfiles[6] },
    { id: 25, name: '堆垛机电机', site: '仓储物流', type: 'motor', ratedPower: 85, currentLoad: 62, loadRate: 72.94, runtime: 8.9, avgLoadRate: 71, maxLoad: 80, minLoad: 36, hourlyLoadRates: equipmentLoadProfiles[7] },
    { id: 26, name: '实验设备', site: '研发中心', type: 'other', ratedPower: 50, currentLoad: 30, loadRate: 60, runtime: 6.8, avgLoadRate: 58, maxLoad: 47, minLoad: 18, hourlyLoadRates: equipmentLoadProfiles[8] },
    { id: 27, name: '精密空调', site: '研发中心', type: 'other', ratedPower: 35, currentLoad: 21, loadRate: 60, runtime: 6.5, avgLoadRate: 58, maxLoad: 33, minLoad: 15, hourlyLoadRates: equipmentLoadProfiles[9] },
    { id: 28, name: '食堂设备', site: '生活配套区', type: 'other', ratedPower: 28, currentLoad: 20, loadRate: 71.43, runtime: 7.5, avgLoadRate: 69, maxLoad: 26, minLoad: 14, hourlyLoadRates: equipmentLoadProfiles[10] }
];

let selectedLoadEquipment = null;
let equipmentLoadCurrentData = null;

// 初始化
function initEquipmentLoad() {
    // 重置状态
    selectedLoadEquipment = null;
    equipmentLoadCurrentData = null;
    
    // 重新绑定事件和渲染
    bindEquipmentLoadEvents();
    renderEquipmentList();
    updateDataTable();
    
    // 确保滚动监听已设置（renderEquipmentList 中会处理，这里作为备用）
    setTimeout(() => {
        updateScrollArrows();
    }, 300);
    
    if (equipmentLoadData.length > 0) {
        selectEquipment(equipmentLoadData[0].id);
    }
}

function bindEquipmentLoadEvents() {
    const queryBtn = document.getElementById('query-btn');
    if (queryBtn && !queryBtn.dataset.bound) {
        queryBtn.dataset.bound = 'true';
        queryBtn.addEventListener('click', () => {
            renderEquipmentList();
            updateDataTable();
            if (selectedLoadEquipment) {
                const equipment = equipmentLoadData.find(eq => eq.id === selectedLoadEquipment);
                if (equipment) {
                    generateChartData(equipment);
                }
            }
        });
    }

    const timeRangeSelect = document.getElementById('time-range');
    if (timeRangeSelect && !timeRangeSelect.dataset.bound) {
        timeRangeSelect.dataset.bound = 'true';
        timeRangeSelect.addEventListener('change', function() {
            const customRange = document.getElementById('custom-date-range');
            if (customRange) {
                customRange.style.display = this.value === 'custom' ? 'flex' : 'none';
            }
        });
    }

    const equipmentTypeSelect = document.getElementById('equipment-type');
    if (equipmentTypeSelect && !equipmentTypeSelect.dataset.bound) {
        equipmentTypeSelect.dataset.bound = 'true';
        equipmentTypeSelect.addEventListener('change', () => {
            renderEquipmentList();
            updateDataTable();
        });
    }

    const siteSelect = document.getElementById('site-select');
    if (siteSelect && !siteSelect.dataset.bound) {
        siteSelect.dataset.bound = 'true';
        siteSelect.addEventListener('change', () => {
            renderEquipmentList();
            updateDataTable();
        });
    }

    const exportBtn = document.getElementById('export-btn');
    if (exportBtn && !exportBtn.dataset.bound) {
        exportBtn.dataset.bound = 'true';
        exportBtn.addEventListener('click', () => {
            alert('导出功能待实现');
        });
    }
}

// 滚动设备列表
function scrollEquipmentList(direction) {
    const grid = document.getElementById('equipment-grid');
    if (!grid) return;
    
    const scrollAmount = 220; // 每次滚动一个卡片宽度 + 间距
    const currentScroll = grid.scrollLeft;
    
    if (direction === 'left') {
        grid.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
    } else if (direction === 'right') {
        grid.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    }
    
    // 延迟更新箭头状态，等待滚动完成
    setTimeout(updateScrollArrows, 100);
}

// 更新滚动箭头状态
function updateScrollArrows() {
    const grid = document.getElementById('equipment-grid');
    const leftArrow = document.getElementById('scroll-left');
    const rightArrow = document.getElementById('scroll-right');
    
    if (!grid || !leftArrow || !rightArrow) return;
    
    const scrollLeft = grid.scrollLeft;
    const scrollWidth = grid.scrollWidth;
    const clientWidth = grid.clientWidth;
    
    // 更新左箭头状态
    if (scrollLeft <= 0) {
        leftArrow.disabled = true;
    } else {
        leftArrow.disabled = false;
    }
    
    // 更新右箭头状态
    if (scrollLeft >= scrollWidth - clientWidth - 5) { // 5px 容差
        rightArrow.disabled = true;
    } else {
        rightArrow.disabled = false;
    }
}

// 渲染设备列表
function renderEquipmentList() {
    const grid = document.getElementById('equipment-grid');
    const timeRange = document.getElementById('time-range').value;
    const equipmentType = document.getElementById('equipment-type').value;
    const siteSelect = document.getElementById('site-select');
    const siteFilter = siteSelect ? siteSelect.value : 'all';
    
    // 筛选设备
    let filteredData = equipmentLoadData;
    if (equipmentType !== 'all') {
        filteredData = filteredData.filter(eq => eq.type === equipmentType);
    }
    if (siteFilter !== 'all') {
        const siteMap = {
            'site1': '生产车间1',
            'site2': '生产车间2',
            'site3': '生产车间3',
            'site4': '办公楼',
            'site5': '辅助设施',
            'site6': '仓储物流',
            'site7': '研发中心',
            'site8': '生活配套区'
        };
        const targetSite = siteMap[siteFilter];
        if (targetSite) {
            filteredData = filteredData.filter(eq => eq.site === targetSite);
        }
    }
    
    if (filteredData.length === 0) {
        grid.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>暂无设备数据</p></div>';
        // 隐藏箭头
        const leftArrow = document.getElementById('scroll-left');
        const rightArrow = document.getElementById('scroll-right');
        if (leftArrow) leftArrow.style.display = 'none';
        if (rightArrow) rightArrow.style.display = 'none';
        return;
    }
    
    // 显示箭头
    const leftArrow = document.getElementById('scroll-left');
    const rightArrow = document.getElementById('scroll-right');
    if (leftArrow) leftArrow.style.display = 'flex';
    if (rightArrow) rightArrow.style.display = 'flex';
    
    grid.innerHTML = filteredData.map(eq => `
        <div class="equipment-card ${selectedLoadEquipment === eq.id ? 'active' : ''}" 
             onclick="selectEquipment(${eq.id})">
            <div class="equipment-name">${eq.name}</div>
            <div class="equipment-info">站点: ${eq.site || '未分配'}</div>
            <div class="equipment-info">类型: ${getEquipmentTypeName(eq.type)}</div>
            <div class="equipment-info">额定功率: ${eq.ratedPower} kW</div>
            <div class="equipment-load-rate">负荷率: ${eq.loadRate.toFixed(1)}%</div>
        </div>
    `).join('');
    
    // 重置滚动位置
    grid.scrollLeft = 0;
    
    // 延迟更新箭头状态，等待DOM渲染完成
    setTimeout(() => {
        updateScrollArrows();
        // 每次渲染后重新添加滚动监听（因为innerHTML会清除事件监听器）
        const updatedGrid = document.getElementById('equipment-grid');
        if (updatedGrid) {
            // 移除旧的监听器（如果存在），然后添加新的
            updatedGrid.removeEventListener('scroll', updateScrollArrows);
            updatedGrid.addEventListener('scroll', updateScrollArrows);
        }
    }, 100);
}

// 获取设备类型名称
function getEquipmentTypeName(type) {
    const typeMap = {
        'motor': '电机',
        'compressor': '压缩机',
        'pump': '水泵',
        'fan': '风机',
        'lighting': '照明',
        'other': '其他'
    };
    return typeMap[type] || '其他';
}

// 选择设备
function selectEquipment(equipmentId) {
    selectedLoadEquipment = equipmentId;
    const equipment = equipmentLoadData.find(eq => eq.id === equipmentId);
    if (!equipment) return;
    
    // 更新设备列表显示
    renderEquipmentList();
    
    // 生成并显示图表数据
    generateChartData(equipment);
}

// 生成图表数据
function generateChartData(equipment) {
    let hourlyLoadRate;
    if (equipment.hourlyLoadRates && equipment.hourlyLoadRates.length === 24) {
        hourlyLoadRate = equipment.hourlyLoadRates.map((value, hour) => ({
            hour,
            loadRate: value,
            load: (value / 100) * equipment.ratedPower
        }));
    } else {
        hourlyLoadRate = Array.from({length: 24}, (_, hour) => {
            const baseLoad = equipment.avgLoadRate;
            const variation = Math.sin((hour - 6) * Math.PI / 12) * 20;
            const loadRate = Math.max(0, Math.min(100, baseLoad + variation));
            return {
                hour,
                loadRate,
                load: (loadRate / 100) * equipment.ratedPower
            };
        });
    }
    
    // 生成负荷持续时间数据
    const durationData = generateDurationData(hourlyLoadRate);
    
    equipmentLoadCurrentData = {
        equipment: equipment,
        hourlyLoadRate: hourlyLoadRate,
        durationData: durationData
    };
    
    // 渲染图表
    renderLoadRateChart(hourlyLoadRate, equipment);
    renderDurationChart(durationData, equipment);
}

// 生成负荷持续时间数据
function generateDurationData(hourlyData) {
    // 将负荷率分成10个区间
    const intervals = Array.from({length: 10}, (_, i) => ({
        min: i * 10,
        max: (i + 1) * 10,
        duration: 0
    }));
    
    hourlyData.forEach(data => {
        const intervalIndex = Math.floor(data.loadRate / 10);
        const index = Math.min(intervalIndex, 9);
        intervals[index].duration += 1;
    });
    
    return intervals;
}

// 渲染日负荷率图表
function renderLoadRateChart(data, equipment) {
    const container = document.getElementById('load-rate-chart');
    const containerWidth = container.offsetWidth || container.clientWidth || 800;
    const containerHeight = 400;
    const padding = 70;
    const width = Math.max(containerWidth - 20, 600);
    const height = containerHeight - 20;
    const chartWidth = width - padding * 2;
    const chartHeight = height - padding * 2 - 30; // 为X轴标签留出空间
    
    const maxLoadRate = 100;
    const svgWidth = width;
    const svgHeight = height;
    
    let svg = `
        <svg width="100%" height="100%" viewBox="0 0 ${svgWidth} ${svgHeight}" preserveAspectRatio="xMidYMid meet" style="max-width: 100%;">
            <defs>
                <linearGradient id="loadRateGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#00bcd4;stop-opacity:0.8" />
                    <stop offset="100%" style="stop-color:#00bcd4;stop-opacity:0.1" />
                </linearGradient>
            </defs>
            
            <!-- 网格线 -->
            ${Array.from({length: 5}, (_, i) => {
                const y = padding + (chartHeight / 4) * i;
                return `<line x1="${padding}" y1="${y}" x2="${svgWidth - padding}" y2="${y}" stroke="#3c5472" stroke-width="0.5" opacity="0.5"/>`;
            }).join('')}
            
            <!-- Y轴标签 -->
            ${Array.from({length: 5}, (_, i) => {
                const y = padding + (chartHeight / 4) * i;
                const value = maxLoadRate - (maxLoadRate / 4) * i;
                return `<text x="${padding - 15}" y="${y + 5}" fill="#a7bed3" font-size="11" text-anchor="end">${value}%</text>`;
            }).join('')}
            
            <!-- 数据区域填充 -->
            <polygon points="${data.map((d, i) => {
                const x = padding + (chartWidth / (data.length - 1 || 1)) * i;
                const y = padding + chartHeight - (d.loadRate / maxLoadRate) * chartHeight;
                return `${x},${y}`;
            }).join(' ')} ${svgWidth - padding},${padding + chartHeight} ${padding},${padding + chartHeight}" 
                fill="url(#loadRateGradient)"/>
            
            <!-- 趋势线 -->
            <polyline points="${data.map((d, i) => {
                const x = padding + (chartWidth / (data.length - 1 || 1)) * i;
                const y = padding + chartHeight - (d.loadRate / maxLoadRate) * chartHeight;
                return `${x},${y}`;
            }).join(' ')}" 
                fill="none" stroke="#00bcd4" stroke-width="3"/>
            
            <!-- 数据点 -->
            ${data.map((d, i) => {
                const x = padding + (chartWidth / (data.length - 1 || 1)) * i;
                const y = padding + chartHeight - (d.loadRate / maxLoadRate) * chartHeight;
                return `<circle cx="${x}" cy="${y}" r="4" fill="#00bcd4" stroke="#1a2a3a" stroke-width="2">
                    <title>${String(i).padStart(2, '0')}:00 - 负荷率: ${d.loadRate.toFixed(1)}%</title>
                </circle>`;
            }).join('')}
            
            <!-- X轴标签 -->
            ${data.filter((d, i) => i % 3 === 0 || i === data.length - 1).map((d, i) => {
                const index = data.findIndex(item => item === d);
                const x = padding + (chartWidth / (data.length - 1 || 1)) * index;
                return `<text x="${x}" y="${padding + chartHeight + 25}" fill="#a7bed3" font-size="11" text-anchor="middle">${String(d.hour).padStart(2, '0')}:00</text>`;
            }).join('')}
            
            <!-- 标题 -->
            <text x="${svgWidth / 2}" y="25" fill="#e0e6ed" font-size="14" font-weight="bold" text-anchor="middle">${equipment.site || ''} - ${equipment.name}</text>
        </svg>
    `;
    
    container.innerHTML = svg;
}

// 渲染日负荷持续时间图
function renderDurationChart(data, equipment) {
    const container = document.getElementById('duration-chart');
    const containerWidth = container.offsetWidth || container.clientWidth || 800;
    const containerHeight = 400;
    const padding = 70;
    const width = Math.max(containerWidth - 20, 600);
    const height = containerHeight - 20;
    const chartWidth = width - padding * 2;
    const chartHeight = height - padding * 2 - 30; // 为X轴标签留出空间
    
    const maxDuration = Math.max(...data.map(d => d.duration), 1);
    const svgWidth = width;
    const svgHeight = height;
    
    let svg = `
        <svg width="100%" height="100%" viewBox="0 0 ${svgWidth} ${svgHeight}" preserveAspectRatio="xMidYMid meet" style="max-width: 100%;">
            <!-- 网格线 -->
            ${Array.from({length: 5}, (_, i) => {
                const y = padding + (chartHeight / 4) * i;
                return `<line x1="${padding}" y1="${y}" x2="${svgWidth - padding}" y2="${y}" stroke="#3c5472" stroke-width="0.5" opacity="0.5"/>`;
            }).join('')}
            
            <!-- Y轴标签 -->
            ${Array.from({length: 5}, (_, i) => {
                const y = padding + (chartHeight / 4) * i;
                const value = maxDuration - (maxDuration / 4) * i;
                return `<text x="${padding - 15}" y="${y + 5}" fill="#a7bed3" font-size="11" text-anchor="end">${value.toFixed(0)}h</text>`;
            }).join('')}
            
            <!-- 柱状图 -->
            ${data.map((d, i) => {
                const barWidth = chartWidth / data.length * 0.8;
                const x = padding + (chartWidth / data.length) * i + (chartWidth / data.length) * 0.1;
                const barHeight = (d.duration / maxDuration) * chartHeight;
                const y = padding + chartHeight - barHeight;
                
                // 根据负荷率区间设置颜色
                let color = '#00bcd4';
                if (d.max <= 30) color = '#4caf50'; // 低负荷 - 绿色
                else if (d.max <= 70) color = '#ff9800'; // 中负荷 - 橙色
                else color = '#f44336'; // 高负荷 - 红色
                
                return `
                    <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                        fill="${color}" opacity="0.8">
                        <title>负荷率 ${d.min}-${d.max}%: ${d.duration}小时</title>
                    </rect>
                `;
            }).join('')}
            
            <!-- X轴标签 -->
            ${data.map((d, i) => {
                const x = padding + (chartWidth / data.length) * i + (chartWidth / data.length) / 2;
                return `<text x="${x}" y="${padding + chartHeight + 25}" fill="#a7bed3" font-size="10" text-anchor="middle">${d.min}-${d.max}%</text>`;
            }).join('')}
            
            <!-- 标题 -->
            <text x="${svgWidth / 2}" y="25" fill="#e0e6ed" font-size="14" font-weight="bold" text-anchor="middle">${equipment.site || ''} - ${equipment.name}</text>
        </svg>
    `;
    
    container.innerHTML = svg;
}

// 更新数据表格
function updateDataTable() {
    const tbody = document.getElementById('load-table-body');
    const equipmentType = document.getElementById('equipment-type').value;
    const siteSelect = document.getElementById('site-select');
    const siteFilter = siteSelect ? siteSelect.value : 'all';
    
    let filteredData = equipmentLoadData;
    if (equipmentType !== 'all') {
        filteredData = filteredData.filter(eq => eq.type === equipmentType);
    }
    if (siteFilter !== 'all') {
        const siteMap = {
            'site1': '生产车间1',
            'site2': '生产车间2',
            'site3': '生产车间3',
            'site4': '办公楼',
            'site5': '辅助设施',
            'site6': '仓储物流',
            'site7': '研发中心',
            'site8': '生活配套区'
        };
        const targetSite = siteMap[siteFilter];
        if (targetSite) {
            filteredData = filteredData.filter(eq => eq.site === targetSite);
        }
    }
    
    if (filteredData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="10" style="text-align: center; color: #a7bed3; padding: 40px;">
                    暂无数据
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filteredData.map(eq => {
        const loadRateClass = eq.loadRate < 50 ? 'low' : eq.loadRate < 80 ? 'medium' : 'high';
        return `
            <tr onclick="selectEquipment(${eq.id})" style="cursor: pointer;">
                <td>${eq.name}</td>
                <td>${eq.site || '未分配'}</td>
                <td>${getEquipmentTypeName(eq.type)}</td>
                <td>${eq.ratedPower}</td>
                <td>${eq.currentLoad.toFixed(2)}</td>
                <td><span class="load-rate-badge ${loadRateClass}">${eq.loadRate.toFixed(1)}%</span></td>
                <td>${eq.runtime.toFixed(1)}</td>
                <td>${eq.avgLoadRate.toFixed(1)}%</td>
                <td>${eq.maxLoad.toFixed(2)}</td>
                <td>${eq.minLoad.toFixed(2)}</td>
            </tr>
        `;
    }).join('');
}

// 确保在动态加载时也能初始化
function ensureEquipmentInit() {
    if (document.getElementById('equipment-grid')) {
        initEquipmentLoad();
        bindEquipmentLoadEvents();
    } else {
        // 如果DOM还没准备好，延迟重试
        setTimeout(ensureEquipmentInit, 50);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureEquipmentInit);
} else {
    ensureEquipmentInit();
}

window.initEquipmentLoad = initEquipmentLoad;
window.selectEquipment = selectEquipment;
window.scrollEquipmentList = scrollEquipmentList;
})();
</script>
