<div class="production-equipment-time-container">
    <style>
        /* 统一滚动条样式 */
        * {
            scrollbar-width: thin;
            scrollbar-color: #3c5472 #1a2a3a;
        }
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1a2a3a;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3c5472;
            border-radius: 5px;
            border: 2px solid #1a2a3a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a6a8a;
        }
        ::-webkit-scrollbar-thumb:active {
            background: #00bcd4;
        }
        ::-webkit-scrollbar-corner {
            background: #1a2a3a;
        }
        
        .production-equipment-time-container {
            padding: 20px;
            background-color: #0f1e2d;
        }

        .page-header {
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 24px;
            color: #00bcd4;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .page-description {
            color: #a7bed3;
            font-size: 14px;
            margin-top: 8px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* 筛选区域 */
        .filter-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-item label {
            color: #a7bed3;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-select {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            color: #e0e6ed;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .filter-select:hover {
            border-color: #00bcd4;
        }

        .query-button, .export-button {
            background-color: #00bcd4;
            border: none;
            color: #1a2a3a;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .query-button:hover, .export-button:hover {
            background-color: #00acc1;
            transform: translateY(-1px);
        }

        .export-button {
            background-color: #3c5472;
            color: #e0e6ed;
        }

        .export-button:hover {
            background-color: #4a6a8a;
        }

        /* 统计概览卡片 */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-color, #00bcd4);
        }

        .stat-label {
            font-size: 13px;
            color: #a7bed3;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #e0e6ed;
            margin-bottom: 4px;
        }

        .stat-unit {
            font-size: 12px;
            color: #5d7d9a;
        }

        .stat-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 32px;
            opacity: 0.2;
            color: var(--accent-color, #00bcd4);
        }

        /* 设备列表 */
        .equipment-list-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .equipment-card {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .equipment-card:hover {
            border-color: #00bcd4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 188, 212, 0.2);
        }

        .equipment-card.active {
            border-color: #00bcd4;
            background-color: #1e2d3f;
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.3);
        }

        .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .equipment-name {
            font-size: 14px;
            color: #e0e6ed;
            font-weight: bold;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-badge.running {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .status-badge.standby {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .status-badge.stopped {
            background-color: rgba(158, 158, 158, 0.2);
            color: #9e9e9e;
        }

        .equipment-info {
            font-size: 12px;
            color: #a7bed3;
            margin-bottom: 4px;
        }

        .current-indicator {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #3c5472;
        }

        .current-value {
            font-size: 16px;
            font-weight: bold;
            color: #00bcd4;
        }

        /* 图表区域 */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-panel {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            font-size: 16px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            width: 100%;
            height: 500px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            padding: 10px;
        }

        .chart-container svg {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: block;
            box-sizing: border-box;
        }

        /* 时间轴图表 */
        .timeline-chart {
            width: 100%;
            height: 100%;
        }

        .timeline-bar {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .timeline-bar:hover {
            opacity: 0.8;
        }

        /* 数据表格 */
        .data-table-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: #1a2a3a;
            color: #a7bed3;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: normal;
            border-bottom: 2px solid #3c5472;
        }

        .data-table td {
            padding: 12px;
            color: #e0e6ed;
            font-size: 13px;
            border-bottom: 1px solid #3c5472;
        }

        .data-table tr:hover {
            background-color: #1e2d3f;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5d7d9a;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* 生产时段标识 */
        .production-period {
            background-color: rgba(0, 188, 212, 0.1);
            border-left: 3px solid #00bcd4;
            padding: 8px 12px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .production-period-label {
            font-size: 12px;
            color: #00bcd4;
            font-weight: bold;
        }
    </style>

    <div class="page-header">
        <h2 class="page-title"><i class="fas fa-clock"></i> 生产设备作业时间分析</h2>
    </div>

    <!-- 筛选区域 -->
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-item">
                <label>时间范围:</label>
                <select id="time-range" class="filter-select">
                    <option value="today" selected>今日</option>
                    <option value="yesterday">昨日</option>
                    <option value="week">本周</option>
                    <option value="month">本月</option>
                    <option value="custom">自定义</option>
                </select>
            </div>
            <div class="filter-item" id="custom-date-range" style="display: none;">
                <label>开始日期:</label>
                <input type="date" id="start-date" class="filter-select">
                <label>结束日期:</label>
                <input type="date" id="end-date" class="filter-select">
            </div>
            <div class="filter-item">
                <label>设备类型:</label>
                <select id="equipment-type" class="filter-select">
                    <option value="all">全部设备</option>
                    <option value="production">生产设备</option>
                    <option value="auxiliary">辅助设备</option>
                    <option value="other">其他设备</option>
                </select>
            </div>
            <div class="filter-item">
                <label>生产时段:</label>
                <select id="production-period" class="filter-select">
                    <option value="all">全部时段</option>
                    <option value="morning">早班 (08:00-16:00)</option>
                    <option value="afternoon">中班 (16:00-00:00)</option>
                    <option value="night">晚班 (00:00-08:00)</option>
                </select>
            </div>
            <div class="filter-item">
                <button class="query-button" id="query-btn">
                    <i class="fas fa-search"></i> 查询
                </button>
                <button class="export-button" id="export-btn">
                    <i class="fas fa-download"></i> 导出
                </button>
            </div>
        </div>
    </div>

    <!-- 统计概览 -->
    <div class="stats-overview" id="stats-overview">
        <!-- 统计数据将通过JavaScript动态生成 -->
    </div>

    <!-- 设备列表 -->
    <div class="equipment-list-section">
        <h3 class="section-title">
            <i class="fas fa-server"></i> 生产设备列表
        </h3>
        <div class="equipment-grid" id="equipment-grid">
            <!-- 设备卡片将通过JavaScript动态生成 -->
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="charts-section">
        <!-- 设备作业时间轴 -->
        <div class="chart-panel">
            <h3 class="chart-title">
                <i class="fas fa-chart-bar"></i> 设备作业时间轴
            </h3>
            <div class="production-period">
                <div class="production-period-label">
                    <i class="fas fa-info-circle"></i> 生产时段: 08:00-16:00 (早班) | 16:00-00:00 (中班) | 00:00-08:00 (晚班)
                </div>
            </div>
            <div class="chart-container" id="timeline-chart">
                <div class="empty-state">
                    <i class="fas fa-chart-bar"></i>
                    <p>请选择设备查看作业时间轴</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据表格 -->
    <div class="data-table-section">
        <h3 class="section-title">
            <i class="fas fa-table"></i> 设备作业时间明细
        </h3>
        <table class="data-table" id="time-table">
            <thead>
                <tr>
                    <th>设备名称</th>
                    <th>设备类型</th>
                    <th>运行时间(h)</th>
                    <th>待机时间(h)</th>
                    <th>停机时间(h)</th>
                    <th>启动次数</th>
                    <th>停机次数</th>
                    <th>平均运行时长(h)</th>
                    <th>最大运行时长(h)</th>
                    <th>最小运行时长(h)</th>
                    <th>运行率(%)</th>
                </tr>
            </thead>
            <tbody id="time-table-body">
                <!-- 表格数据将通过JavaScript动态生成 -->
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
// 防止重复加载检查
if (window.__productionEquipmentTimeModuleLoaded) {
    // 如果已加载，直接调用初始化函数重新渲染
    if (typeof window.initProductionEquipmentTime === 'function') {
        window.initProductionEquipmentTime();
    }
    return;
}
window.__productionEquipmentTimeModuleLoaded = true;

// 设备数据（示例）
let productionTimeEquipmentData = [
    {
        id: 1,
        name: '生产线1-主设备',
        type: 'production',
        ratedCurrent: 100,
        currentThreshold: { running: 80, standby: 20, stopped: 0 },
        status: 'running',
        currentCurrent: 85,
        hourlyCurrents: [10, 8, 6, 5, 5, 5, 22, 48, 80, 88, 92, 95, 93, 90, 85, 80, 70, 55, 40, 25, 18, 12, 10, 9]
    },
    {
        id: 2,
        name: '生产线2-主设备',
        type: 'production',
        ratedCurrent: 120,
        currentThreshold: { running: 96, standby: 24, stopped: 0 },
        status: 'standby',
        currentCurrent: 45,
        hourlyCurrents: [12, 10, 8, 7, 7, 7, 20, 38, 65, 82, 95, 102, 104, 100, 96, 88, 82, 60, 42, 30, 22, 18, 14, 12]
    },
    {
        id: 3,
        name: '包装设备',
        type: 'production',
        ratedCurrent: 60,
        currentThreshold: { running: 48, standby: 12, stopped: 0 },
        status: 'stopped',
        currentCurrent: 5,
        hourlyCurrents: [5, 5, 5, 5, 5, 5, 10, 18, 32, 48, 55, 58, 60, 58, 35, 20, 12, 8, 6, 5, 5, 5, 5, 5]
    },
    {
        id: 4,
        name: '辅助设备1',
        type: 'auxiliary',
        ratedCurrent: 40,
        currentThreshold: { running: 32, standby: 8, stopped: 0 },
        status: 'running',
        currentCurrent: 35,
        hourlyCurrents: [30, 32, 34, 36, 38, 40, 38, 36, 34, 32, 30, 32, 34, 36, 38, 40, 38, 36, 34, 32, 30, 28, 26, 24]
    },
    {
        id: 5,
        name: '辅助设备2',
        type: 'auxiliary',
        ratedCurrent: 50,
        currentThreshold: { running: 40, standby: 10, stopped: 0 },
        status: 'standby',
        currentCurrent: 15,
        hourlyCurrents: [12, 12, 12, 12, 12, 12, 18, 25, 35, 40, 45, 48, 48, 46, 40, 35, 30, 25, 20, 18, 16, 14, 12, 12]
    },
    {
        id: 6,
        name: '包装机器人线',
        type: 'production',
        ratedCurrent: 80,
        currentThreshold: { running: 64, standby: 20, stopped: 0 },
        status: 'running',
        currentCurrent: 70,
        hourlyCurrents: [18, 16, 15, 14, 14, 16, 28, 48, 62, 74, 78, 82, 84, 82, 78, 72, 66, 58, 46, 32, 25, 22, 20, 18]
    },
    {
        id: 7,
        name: '冷却塔组',
        type: 'auxiliary',
        ratedCurrent: 45,
        currentThreshold: { running: 34, standby: 10, stopped: 0 },
        status: 'running',
        currentCurrent: 36,
        hourlyCurrents: [30, 32, 33, 34, 35, 36, 37, 38, 40, 41, 42, 40, 39, 38, 38, 37, 36, 35, 34, 33, 32, 31, 30, 30]
    }
];

let selectedProductionEquipment = null;
let productionTimeCurrentData = null;

// 生产时段定义
const productionPeriods = [
    { name: '早班', start: 8, end: 16 },
    { name: '中班', start: 16, end: 24 },
    { name: '晚班', start: 0, end: 8 }
];

// 初始化
function initProductionEquipmentTime() {
    renderStatsOverview();
    renderEquipmentList();
    updateTimeTable();
    
    // 默认选择第一个设备
    if (productionTimeEquipmentData.length > 0) {
        selectEquipment(productionTimeEquipmentData[0].id);
    }
}

// 根据电流判断设备状态
function getEquipmentStatus(current, threshold) {
    if (current >= threshold.running) {
        return 'running';
    } else if (current >= threshold.standby) {
        return 'standby';
    } else {
        return 'stopped';
    }
}

// 获取状态文本
function getStatusText(status) {
    const statusMap = {
        'running': '运行',
        'standby': '待机',
        'stopped': '停机'
    };
    return statusMap[status] || '未知';
}

// 渲染统计概览
function renderStatsOverview() {
    const container = document.getElementById('stats-overview');
    
    // 计算统计数据
    const totalRunningTime = productionTimeEquipmentData.reduce((sum, eq) => {
        const stats = calculateEquipmentStats(eq);
        return sum + stats.runningTime;
    }, 0);
    
    const totalStartCount = productionTimeEquipmentData.reduce((sum, eq) => {
        const stats = calculateEquipmentStats(eq);
        return sum + stats.startCount;
    }, 0);
    
    const avgRunningRate = productionTimeEquipmentData.reduce((sum, eq) => {
        const stats = calculateEquipmentStats(eq);
        return sum + stats.runningRate;
    }, 0) / productionTimeEquipmentData.length;
    
    const runningEquipment = productionTimeEquipmentData.filter(eq => eq.status === 'running').length;
    
    container.innerHTML = `
        <div class="stat-card" style="--accent-color: #00bcd4;">
            <i class="fas fa-clock stat-icon"></i>
            <div class="stat-label">总运行时间</div>
            <div class="stat-value">${totalRunningTime.toFixed(1)}</div>
            <div class="stat-unit">小时</div>
        </div>
        <div class="stat-card" style="--accent-color: #4caf50;">
            <i class="fas fa-power-off stat-icon"></i>
            <div class="stat-label">总启动次数</div>
            <div class="stat-value">${totalStartCount}</div>
            <div class="stat-unit">次</div>
        </div>
        <div class="stat-card" style="--accent-color: #ff9800;">
            <i class="fas fa-chart-line stat-icon"></i>
            <div class="stat-label">平均运行率</div>
            <div class="stat-value">${avgRunningRate.toFixed(1)}</div>
            <div class="stat-unit">%</div>
        </div>
        <div class="stat-card" style="--accent-color: #2196f3;">
            <i class="fas fa-check-circle stat-icon"></i>
            <div class="stat-label">运行中设备</div>
            <div class="stat-value">${runningEquipment}</div>
            <div class="stat-unit">台</div>
        </div>
    `;
}

// 计算设备统计数据
function calculateEquipmentStats(equipment) {
    // 生成24小时电流数据
    const hourlyData = generateHourlyCurrentData(equipment);
    
    // 计算状态持续时间
    let runningTime = 0;
    let standbyTime = 0;
    let stoppedTime = 0;
    let startCount = 0;
    let stopCount = 0;
    let runDurations = [];
    let currentRunDuration = 0;
    
    let previousStatus = null;
    
    hourlyData.forEach((data, index) => {
        const status = getEquipmentStatus(data.current, equipment.currentThreshold);
        
        if (status === 'running') {
            runningTime += 1;
            currentRunDuration += 1;
            if (previousStatus !== 'running') {
                startCount++;
            }
        } else if (status === 'standby') {
            standbyTime += 1;
            if (currentRunDuration > 0) {
                runDurations.push(currentRunDuration);
                currentRunDuration = 0;
            }
        } else {
            stoppedTime += 1;
            if (previousStatus === 'running' || previousStatus === 'standby') {
                stopCount++;
            }
            if (currentRunDuration > 0) {
                runDurations.push(currentRunDuration);
                currentRunDuration = 0;
            }
        }
        
        previousStatus = status;
    });
    
    if (currentRunDuration > 0) {
        runDurations.push(currentRunDuration);
    }
    
    const totalTime = runningTime + standbyTime + stoppedTime;
    const runningRate = totalTime > 0 ? (runningTime / totalTime) * 100 : 0;
    const avgRunDuration = runDurations.length > 0 ? runDurations.reduce((a, b) => a + b, 0) / runDurations.length : 0;
    const maxRunDuration = runDurations.length > 0 ? Math.max(...runDurations) : 0;
    const minRunDuration = runDurations.length > 0 ? Math.min(...runDurations) : 0;
    
    return {
        runningTime,
        standbyTime,
        stoppedTime,
        startCount,
        stopCount,
        runningRate,
        avgRunDuration,
        maxRunDuration,
        minRunDuration,
        hourlyData
    };
}

// 生成24小时电流数据
function generateHourlyCurrentData(equipment) {
    if (equipment.hourlyCurrents && equipment.hourlyCurrents.length === 24) {
        return equipment.hourlyCurrents.map((current, hour) => ({ hour, current }));
    }
    
    return Array.from({length: 24}, (_, hour) => {
        const productionFactor = productionPeriods.some(period => {
            if (period.start < period.end) {
                return hour >= period.start && hour < period.end;
            }
            return hour >= period.start || hour < period.end;
        }) ? 1 : 0.35;
        
        const sinus = Math.sin((hour - 6) * Math.PI / 12);
        const baseCurrent = equipment.ratedCurrent * (0.1 + productionFactor * (0.4 + 0.3 * Math.max(0, sinus)));
        
        return {
            hour,
            current: Math.max(0, Math.min(equipment.ratedCurrent * 1.05, baseCurrent))
        };
    });
}

// 渲染设备列表
function renderEquipmentList() {
    const grid = document.getElementById('equipment-grid');
    const equipmentType = document.getElementById('equipment-type').value;
    
    let filteredData = productionTimeEquipmentData;
    if (equipmentType !== 'all') {
        filteredData = productionTimeEquipmentData.filter(eq => eq.type === equipmentType);
    }
    
    if (filteredData.length === 0) {
        grid.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>暂无设备数据</p></div>';
        return;
    }
    
    grid.innerHTML = filteredData.map(eq => {
        const status = getEquipmentStatus(eq.currentCurrent, eq.currentThreshold);
        const statusText = getStatusText(status);
        const statusClass = status;
        
        return `
            <div class="equipment-card ${selectedProductionEquipment === eq.id ? 'active' : ''}" 
                 onclick="selectEquipment(${eq.id})">
                <div class="equipment-header">
                    <div class="equipment-name">${eq.name}</div>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="equipment-info">类型: ${eq.type === 'production' ? '生产设备' : eq.type === 'auxiliary' ? '辅助设备' : '其他设备'}</div>
                <div class="equipment-info">额定电流: ${eq.ratedCurrent} A</div>
                <div class="current-indicator">
                    <div class="equipment-info">当前电流:</div>
                    <div class="current-value">${eq.currentCurrent.toFixed(1)} A</div>
                </div>
            </div>
        `;
    }).join('');
}

// 选择设备
function selectEquipment(equipmentId) {
    selectedProductionEquipment = equipmentId;
    const equipment = productionTimeEquipmentData.find(eq => eq.id === equipmentId);
    if (!equipment) return;
    
    // 更新设备列表显示
    renderEquipmentList();
    
    // 生成并显示图表数据
    generateChartData(equipment);
}

// 生成图表数据
function generateChartData(equipment) {
    const stats = calculateEquipmentStats(equipment);
    productionTimeCurrentData = {
        equipment: equipment,
        stats: stats
    };
    
    // 渲染时间轴图表
    renderTimelineChart(stats.hourlyData, equipment);
}

// 渲染时间轴图表
function renderTimelineChart(hourlyData, equipment) {
    const container = document.getElementById('timeline-chart');
    const containerWidth = container.offsetWidth || container.clientWidth || 1200;
    const containerHeight = 500;
    const padding = { top: 60, right: 40, bottom: 80, left: 100 };
    const width = Math.max(containerWidth - 20, 1000);
    const height = containerHeight - 20;
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;
    
    const svgWidth = width;
    const svgHeight = height;
    const barHeight = chartHeight / 3; // 三个状态区域
    
    // 状态颜色
    const statusColors = {
        'running': '#4caf50',
        'standby': '#ff9800',
        'stopped': '#9e9e9e'
    };
    
    // 计算每个小时的状态
    const statusData = hourlyData.map(data => {
        const status = getEquipmentStatus(data.current, equipment.currentThreshold);
        return {
            hour: data.hour,
            current: data.current,
            status: status
        };
    });
    
    let svg = `
        <svg width="100%" height="100%" viewBox="0 0 ${svgWidth} ${svgHeight}" preserveAspectRatio="xMidYMid meet" style="max-width: 100%;">
            <defs>
                <!-- 生产时段背景 -->
                ${productionPeriods.map((period, idx) => {
                    const startX = padding.left + (chartWidth / 24) * period.start;
                    const endX = period.end === 24 ? padding.left + chartWidth : padding.left + (chartWidth / 24) * period.end;
                    const width = endX - startX;
                    return `
                        <rect x="${startX}" y="${padding.top}" width="${width}" height="${chartHeight}" 
                            fill="rgba(0, 188, 212, 0.05)" opacity="0.3"/>
                    `;
                }).join('')}
            </defs>
            
            <!-- 标题 -->
            <text x="${svgWidth / 2}" y="30" fill="#e0e6ed" font-size="16" font-weight="bold" text-anchor="middle">${equipment.name}</text>
            
            <!-- Y轴标签 -->
            <text x="${padding.left - 20}" y="${padding.top + barHeight / 2}" fill="#a7bed3" font-size="12" text-anchor="middle">运行</text>
            <text x="${padding.left - 20}" y="${padding.top + barHeight + barHeight / 2}" fill="#a7bed3" font-size="12" text-anchor="middle">待机</text>
            <text x="${padding.left - 20}" y="${padding.top + barHeight * 2 + barHeight / 2}" fill="#a7bed3" font-size="12" text-anchor="middle">停机</text>
            
            <!-- 时间轴 -->
            ${statusData.map((data, i) => {
                const x = padding.left + (chartWidth / 24) * i;
                const width = chartWidth / 24;
                const y = padding.top + (data.status === 'running' ? 0 : data.status === 'standby' ? barHeight : barHeight * 2);
                const height = barHeight;
                
                return `
                    <rect x="${x}" y="${y}" width="${width}" height="${height}" 
                        fill="${statusColors[data.status]}" opacity="0.8" class="timeline-bar">
                        <title>${String(data.hour).padStart(2, '0')}:00 - ${getStatusText(data.status)} - 电流: ${data.current.toFixed(1)}A</title>
                    </rect>
                `;
            }).join('')}
            
            <!-- X轴标签 -->
            ${Array.from({length: 24}, (_, i) => {
                if (i % 3 === 0 || i === 23) {
                    const x = padding.left + (chartWidth / 24) * i + (chartWidth / 24) / 2;
                    return `<text x="${x}" y="${padding.top + chartHeight + 25}" fill="#a7bed3" font-size="11" text-anchor="middle">${String(i).padStart(2, '0')}:00</text>`;
                }
                return '';
            }).join('')}
            
            <!-- 图例 - 横向排列 -->
            <g transform="translate(${svgWidth - 280}, 20)">
                <g transform="translate(0, 0)">
                    <rect width="15" height="15" fill="#4caf50" opacity="0.8"/>
                    <text x="20" y="12" fill="#a7bed3" font-size="11">运行</text>
                </g>
                <g transform="translate(80, 0)">
                    <rect width="15" height="15" fill="#ff9800" opacity="0.8"/>
                    <text x="20" y="12" fill="#a7bed3" font-size="11">待机</text>
                </g>
                <g transform="translate(160, 0)">
                    <rect width="15" height="15" fill="#9e9e9e" opacity="0.8"/>
                    <text x="20" y="12" fill="#a7bed3" font-size="11">停机</text>
                </g>
            </g>
        </svg>
    `;
    
    container.innerHTML = svg;
}

// 更新时间表格
function updateTimeTable() {
    const tbody = document.getElementById('time-table-body');
    const equipmentType = document.getElementById('equipment-type').value;
    
    let filteredData = productionTimeEquipmentData;
    if (equipmentType !== 'all') {
        filteredData = productionTimeEquipmentData.filter(eq => eq.type === equipmentType);
    }
    
    if (filteredData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="11" style="text-align: center; color: #a7bed3; padding: 40px;">
                    暂无数据
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = filteredData.map(eq => {
        const stats = calculateEquipmentStats(eq);
        return `
            <tr onclick="selectEquipment(${eq.id})" style="cursor: pointer;">
                <td>${eq.name}</td>
                <td>${eq.type === 'production' ? '生产设备' : eq.type === 'auxiliary' ? '辅助设备' : '其他设备'}</td>
                <td>${stats.runningTime.toFixed(1)}</td>
                <td>${stats.standbyTime.toFixed(1)}</td>
                <td>${stats.stoppedTime.toFixed(1)}</td>
                <td>${stats.startCount}</td>
                <td>${stats.stopCount}</td>
                <td>${stats.avgRunDuration.toFixed(1)}</td>
                <td>${stats.maxRunDuration.toFixed(1)}</td>
                <td>${stats.minRunDuration.toFixed(1)}</td>
                <td>${stats.runningRate.toFixed(1)}%</td>
            </tr>
        `;
    }).join('');
}

// 事件监听
document.addEventListener('DOMContentLoaded', function() {
    // 初始化
    initProductionEquipmentTime();
    
    // 查询按钮
    document.getElementById('query-btn').addEventListener('click', function() {
        renderStatsOverview();
        renderEquipmentList();
        updateTimeTable();
        if (selectedProductionEquipment) {
            const equipment = productionTimeEquipmentData.find(eq => eq.id === selectedProductionEquipment);
            if (equipment) {
                generateChartData(equipment);
            }
        }
    });
    
    // 时间范围选择
    document.getElementById('time-range').addEventListener('change', function() {
        const customRange = document.getElementById('custom-date-range');
        if (this.value === 'custom') {
            customRange.style.display = 'flex';
        } else {
            customRange.style.display = 'none';
        }
    });
    
    // 设备类型筛选
    document.getElementById('equipment-type').addEventListener('change', function() {
        renderEquipmentList();
        updateTimeTable();
    });
    
    // 导出按钮
    document.getElementById('export-btn').addEventListener('click', function() {
        alert('导出功能待实现');
    });
});

// 确保在动态加载时也能初始化
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProductionEquipmentTime);
} else {
    setTimeout(initProductionEquipmentTime, 100);
}
window.initProductionEquipmentTime = initProductionEquipmentTime;
window.selectEquipment = selectEquipment;
})();
</script>
