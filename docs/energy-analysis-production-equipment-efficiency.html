<div class="production-equipment-efficiency-container">
    <style>
        /* 统一滚动条样式 */
        * {
            scrollbar-width: thin;
            scrollbar-color: #3c5472 #1a2a3a;
        }
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1a2a3a;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3c5472;
            border-radius: 5px;
            border: 2px solid #1a2a3a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a6a8a;
        }
        ::-webkit-scrollbar-thumb:active {
            background: #00bcd4;
        }
        ::-webkit-scrollbar-corner {
            background: #1a2a3a;
        }
        
        .production-equipment-efficiency-container {
            padding: 20px;
            background-color: #0f1e2d;
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 24px;
            color: #00bcd4;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .page-description {
            color: #a7bed3;
            font-size: 14px;
            margin-top: 8px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* 筛选区域 */
        .filter-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-item label {
            color: #a7bed3;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-select {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            color: #e0e6ed;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .filter-select:hover {
            border-color: #00bcd4;
        }

        .query-button, .export-button {
            background-color: #00bcd4;
            border: none;
            color: #1a2a3a;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .query-button:hover, .export-button:hover {
            background-color: #00acc1;
            transform: translateY(-1px);
        }

        .export-button {
            background-color: #3c5472;
            color: #e0e6ed;
        }

        .export-button:hover {
            background-color: #4a6a8a;
        }

        /* 统计概览卡片 */
        .overview-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .overview-card {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .overview-card-label {
            font-size: 13px;
            color: #a7bed3;
            margin-bottom: 10px;
        }

        .overview-card-value {
            font-size: 28px;
            font-weight: bold;
            color: #00bcd4;
            margin-bottom: 5px;
        }

        .overview-card-unit {
            font-size: 12px;
            color: #5d7d9a;
        }

        .overview-card-trend {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .overview-card-trend.positive {
            color: #4caf50;
        }

        .overview-card-trend.negative {
            color: #f44336;
        }

        /* 设备列表 */
        .equipment-list-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .equipment-card {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            border-radius: 6px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .equipment-card.selected {
            border-color: #00bcd4;
            box-shadow: 0 0 0 1px rgba(0, 188, 212, 0.4);
        }

        .equipment-card:hover {
            border-color: #00bcd4;
            box-shadow: 0 4px 12px rgba(0, 188, 212, 0.2);
        }

        .equipment-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .equipment-name {
            font-size: 16px;
            font-weight: bold;
            color: #e0e6ed;
        }

        .equipment-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .equipment-status.running {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .equipment-status.standby {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .equipment-status.stopped {
            background-color: rgba(158, 158, 158, 0.2);
            color: #9e9e9e;
        }

        .equipment-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 12px;
        }

        .equipment-info-item {
            display: flex;
            flex-direction: column;
        }

        .equipment-info-label {
            font-size: 12px;
            color: #a7bed3;
            margin-bottom: 4px;
        }

        .equipment-info-value {
            font-size: 14px;
            color: #e0e6ed;
            font-weight: 500;
        }

        .equipment-efficiency {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #3c5472;
        }

        .efficiency-label {
            font-size: 12px;
            color: #a7bed3;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .efficiency-bar {
            height: 8px;
            background-color: #1a2a3a;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .efficiency-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
            transition: width 0.3s ease;
        }

        .efficiency-fill.warning {
            background: linear-gradient(90deg, #ff9800 0%, #ffb74d 100%);
        }

        .efficiency-fill.danger {
            background: linear-gradient(90deg, #f44336 0%, #e57373 100%);
        }

        .efficiency-value {
            font-size: 12px;
            color: #5d7d9a;
            text-align: right;
        }

        /* 图表区域 */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-panel {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            font-size: 16px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            padding: 10px;
        }

        .chart-container svg {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: block;
            box-sizing: border-box;
        }

        /* 详细数据表格 */
        .data-table-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: #1a2a3a;
            color: #a7bed3;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: normal;
            border-bottom: 2px solid #3c5472;
        }

        .data-table td {
            padding: 12px;
            color: #e0e6ed;
            font-size: 13px;
            border-bottom: 1px solid #3c5472;
        }

        .data-table tr:hover {
            background-color: #1e2d3f;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5d7d9a;
        }
    </style>

    <div class="page-header">
        <h2 class="page-title">
            <i class="fas fa-industry"></i>
            产能设备能效分析
        </h2>
    </div>

    <!-- 筛选区域 -->
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-item">
                <label>时间范围:</label>
                <select class="filter-select" id="time-range">
                    <option value="today">今日</option>
                    <option value="week">本周</option>
                    <option value="month" selected>本月</option>
                    <option value="quarter">本季度</option>
                    <option value="year">本年</option>
                </select>
            </div>
            <div class="filter-item">
                <label>设备类型:</label>
                <select class="filter-select" id="equipment-type">
                    <option value="all">全部设备</option>
                    <option value="production">生产设备</option>
                    <option value="processing">加工设备</option>
                    <option value="packaging">包装设备</option>
                </select>
            </div>
            <div class="filter-item">
                <label>能效等级:</label>
                <select class="filter-select" id="efficiency-level">
                    <option value="all">全部</option>
                    <option value="excellent">优秀</option>
                    <option value="good">良好</option>
                    <option value="normal">一般</option>
                    <option value="poor">较差</option>
                </select>
            </div>
            <button class="query-button" id="efficiency-query-btn">
                <i class="fas fa-search"></i> 查询
            </button>
            <button class="export-button" id="efficiency-export-btn">
                <i class="fas fa-download"></i> 导出
            </button>
        </div>
    </div>

    <!-- 统计概览 -->
    <div class="overview-cards" id="overview-cards">
        <!-- 将通过JavaScript动态生成 -->
    </div>

    <!-- 设备列表 -->
    <div class="equipment-list-section">
        <div class="section-title">
            <i class="fas fa-list"></i>
            产能设备列表
        </div>
        <div class="equipment-grid" id="equipment-grid">
            <!-- 将通过JavaScript动态生成 -->
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="charts-section">
        <div class="chart-panel">
            <div class="chart-title">
                <i class="fas fa-chart-line"></i>
                能效趋势图
            </div>
            <div class="chart-container" id="efficiency-trend-chart">
                <!-- 图表将通过JavaScript动态生成 -->
            </div>
        </div>
        <div class="chart-panel">
            <div class="chart-title">
                <i class="fas fa-chart-bar"></i>
                能效对比图
            </div>
            <div class="chart-container" id="efficiency-comparison-chart">
                <!-- 图表将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <!-- 详细数据表格 -->
    <div class="data-table-section">
        <div class="section-title">
            <i class="fas fa-table"></i>
            详细数据
        </div>
        <table class="data-table" id="detail-table">
            <thead>
                <tr>
                    <th>设备名称</th>
                    <th>设备类型</th>
                    <th>产量</th>
                    <th>能耗 (kWh)</th>
                    <th>单位产品能耗 (kWh/单位)</th>
                    <th>能效比</th>
                    <th>能效等级</th>
                    <th>状态</th>
                </tr>
            </thead>
            <tbody id="detail-table-body">
                <!-- 将通过JavaScript动态生成 -->
            </tbody>
        </table>
    </div>

    <script>
        (function() {
        // 防止重复加载检查
        if (window.__productionEquipmentEfficiencyModuleLoaded) {
            // 如果已加载，直接调用初始化函数重新渲染
            if (typeof window.initProductionEquipmentEfficiency === 'function') {
                window.initProductionEquipmentEfficiency();
            }
            return;
        }
        window.__productionEquipmentEfficiencyModuleLoaded = true;

        let currentData = null;
        let selectedEquipment = null;

        const baseEquipmentList = [
            { id: 'eq1', name: '注塑机-01', type: 'production', ratedPower: 48, ratedOutput: 2000 },
            { id: 'eq2', name: '注塑机-02', type: 'production', ratedPower: 48, ratedOutput: 1950 },
            { id: 'eq3', name: '冲压机-01', type: 'processing', ratedPower: 82, ratedOutput: 1600 },
            { id: 'eq4', name: '包装机-01', type: 'packaging', ratedPower: 32, ratedOutput: 2600 },
            { id: 'eq5', name: '装配线-01', type: 'production', ratedPower: 60, ratedOutput: 2100 },
            { id: 'eq6', name: '冲压机-02', type: 'processing', ratedPower: 85, ratedOutput: 1600 },
            { id: 'eq7', name: '注塑机-03', type: 'production', ratedPower: 50, ratedOutput: 2050 },
            { id: 'eq8', name: '切割机-01', type: 'processing', ratedPower: 45, ratedOutput: 1800 },
            { id: 'eq9', name: '包装机-02', type: 'packaging', ratedPower: 35, ratedOutput: 2700 },
            { id: 'eq10', name: '装配线-02', type: 'production', ratedPower: 65, ratedOutput: 2200 },
            { id: 'eq11', name: '焊接机-01', type: 'processing', ratedPower: 55, ratedOutput: 1500 },
            { id: 'eq12', name: '注塑机-04', type: 'production', ratedPower: 52, ratedOutput: 2080 }
        ];

        // 生成30天的样例数据
        function generateDailyMetrics() {
            const metrics = [];
            // 从30天前开始生成数据，确保覆盖"本月"查询
            const now = new Date();
            const startDate = new Date(now.getTime() - 29 * 24 * 60 * 60 * 1000);
            
            // 设备基准配置（每个设备的基准产量、能耗、能效比）
            const equipmentBase = {
                eq1: { baseOutput: 1850, baseEnergy: 2200, baseEfficiency: 93.0, outputVar: 0.08, energyVar: 0.06 },
                eq2: { baseOutput: 1750, baseEnergy: 2130, baseEfficiency: 87.5, outputVar: 0.08, energyVar: 0.06 },
                eq3: { baseOutput: 1500, baseEnergy: 2350, baseEfficiency: 73.5, outputVar: 0.08, energyVar: 0.05 },
                eq4: { baseOutput: 2500, baseEnergy: 2015, baseEfficiency: 96.2, outputVar: 0.06, energyVar: 0.04 },
                eq5: { baseOutput: 2000, baseEnergy: 2445, baseEfficiency: 85.0, outputVar: 0.08, energyVar: 0.05 },
                eq6: { baseOutput: 1420, baseEnergy: 2300, baseEfficiency: 73.0, outputVar: 0.08, energyVar: 0.05 },
                eq7: { baseOutput: 1900, baseEnergy: 2250, baseEfficiency: 91.5, outputVar: 0.08, energyVar: 0.06 },
                eq8: { baseOutput: 1650, baseEnergy: 1980, baseEfficiency: 88.2, outputVar: 0.08, energyVar: 0.06 },
                eq9: { baseOutput: 2550, baseEnergy: 2030, baseEfficiency: 96.5, outputVar: 0.06, energyVar: 0.04 },
                eq10: { baseOutput: 2100, baseEnergy: 2500, baseEfficiency: 86.5, outputVar: 0.08, energyVar: 0.05 },
                eq11: { baseOutput: 1400, baseEnergy: 2100, baseEfficiency: 78.5, outputVar: 0.08, energyVar: 0.06 },
                eq12: { baseOutput: 1950, baseEnergy: 2280, baseEfficiency: 92.8, outputVar: 0.08, energyVar: 0.06 }
            };

            for (let i = 0; i < 30; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                // 确保日期格式正确（YYYY-MM-DD）
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                const dayMetrics = { date: dateStr, metrics: {} };

                // 为每个设备生成数据
                Object.keys(equipmentBase).forEach(eqId => {
                    const base = equipmentBase[eqId];
                    
                    // 生成产量（带波动）
                    const outputVar = (Math.random() * 2 - 1) * base.outputVar;
                    const output = Math.round(base.baseOutput * (1 + outputVar));
                    
                    // 生成能耗（带波动）
                    const energyVar = (Math.random() * 2 - 1) * base.energyVar;
                    const energy = Math.round(base.baseEnergy * (1 + energyVar));
                    
                    // 计算能效比（产量/额定产量 * 100，考虑能耗影响）
                    const ratedOutput = baseEquipmentList.find(eq => eq.id === eqId)?.ratedOutput || 2000;
                    const outputRatio = (output / ratedOutput) * 100;
                    const energyRatio = (base.baseEnergy / energy) * 100;
                    const efficiencyRatio = Math.min(100, (outputRatio * 0.7 + energyRatio * 0.3) * (base.baseEfficiency / 100));
                    
                    // 随机生成状态（90%运行，8%待机，2%停机）
                    const statusRand = Math.random();
                    let status = 'running';
                    if (statusRand > 0.90) status = 'standby';
                    if (statusRand > 0.98) status = 'stopped';
                    
                    // 如果停机，产量和能耗降低
                    const finalOutput = status === 'stopped' ? 0 : (status === 'standby' ? Math.round(output * 0.3) : output);
                    const finalEnergy = status === 'stopped' ? Math.round(energy * 0.1) : (status === 'standby' ? Math.round(energy * 0.5) : energy);
                    const finalEfficiency = status === 'stopped' ? 0 : (status === 'standby' ? efficiencyRatio * 0.6 : efficiencyRatio);

                    dayMetrics.metrics[eqId] = {
                        output: finalOutput,
                        energy: finalEnergy,
                        efficiencyRatio: parseFloat(finalEfficiency.toFixed(1)),
                        status: status
                    };
                });

                metrics.push(dayMetrics);
            }

            return metrics;
        }

        // 能效等级判断函数（需要在sampleDataset之前定义）
        function getEfficiencyLevel(ratio) {
            if (ratio >= 90) return 'excellent';
            if (ratio >= 75) return 'good';
            if (ratio >= 60) return 'normal';
            return 'poor';
        }

        // 生成样例数据
        let rawDailyMetrics = [];
        let sampleDataset = { equipment: [], dailyData: [] };

        try {
            rawDailyMetrics = generateDailyMetrics();
            
            sampleDataset = {
                equipment: baseEquipmentList,
                dailyData: rawDailyMetrics.map(record => ({
                    date: record.date,
                    equipmentData: Object.entries(record.metrics).map(([equipmentId, metrics]) => ({
                        equipmentId,
                        output: metrics.output,
                        energy: metrics.energy,
                        unitEnergy: metrics.output > 0 ? Number((metrics.energy / metrics.output).toFixed(2)) : 0,
                        efficiencyRatio: metrics.efficiencyRatio,
                        efficiencyLevel: getEfficiencyLevel(metrics.efficiencyRatio),
                        status: metrics.status || 'running'
                    }))
                }))
            };
        } catch (error) {
            console.error('生成样例数据时出错:', error);
        }

        const timeRangeMap = {
            today: 1,
            week: 7,
            month: 30,
            quarter: 90,
            year: 365
        };

        function bindProductionEfficiencyEvents() {
            const queryBtn = document.getElementById('efficiency-query-btn');
            if (queryBtn && !queryBtn.dataset.bound) {
                queryBtn.dataset.bound = 'true';
                queryBtn.addEventListener('click', () => {
                    queryData();
                });
            }

            ['time-range', 'equipment-type', 'efficiency-level'].forEach(id => {
                const element = document.getElementById(id);
                if (element && !element.dataset.bound) {
                    element.dataset.bound = 'true';
                    element.addEventListener('change', () => {
                        queryData();
                    });
                }
            });

            const exportBtn = document.getElementById('efficiency-export-btn');
            if (exportBtn && !exportBtn.dataset.bound) {
                exportBtn.dataset.bound = 'true';
                exportBtn.addEventListener('click', () => {
                    exportData();
                });
            }
        }

        // 初始化
        function initProductionEquipmentEfficiency() {
            bindProductionEfficiencyEvents();
            queryData();
        }

        // 查询数据
        function queryData() {
            const timeRangeEl = document.getElementById('time-range');
            const equipmentTypeEl = document.getElementById('equipment-type');
            const efficiencyLevelEl = document.getElementById('efficiency-level');
            
            if (!timeRangeEl || !equipmentTypeEl || !efficiencyLevelEl) {
                console.error('筛选元素未找到');
                return;
            }
            
            const timeRange = timeRangeEl.value || 'month';
            const equipmentType = equipmentTypeEl.value || 'all';
            const efficiencyLevel = efficiencyLevelEl.value || 'all';
            
            // 确保sampleDataset已初始化
            if (!sampleDataset || !sampleDataset.equipment || sampleDataset.equipment.length === 0) {
                console.error('样例数据未初始化');
                return;
            }
            
            // 模拟数据生成
            const data = generateMockData(timeRange, equipmentType, efficiencyLevel);
            currentData = data;
            
            if (!data || !data.equipment || data.equipment.length === 0) {
                console.warn('生成的数据为空');
            }
            
            updateOverview(data);
            renderEquipmentList(data);
            renderEfficiencyTrendChart(data);
            renderEfficiencyComparisonChart(data);
            updateDetailTable(data);
        }

        // 生成样例数据（基于静态样例过滤）
        function generateMockData(timeRange, equipmentType, efficiencyLevel) {
            const daysRequested = timeRangeMap[timeRange] || 7;
            const availableDays = sampleDataset.dailyData.length;
            const sliceDays = Math.min(daysRequested, availableDays);

            let equipmentList = sampleDataset.equipment.filter(eq => equipmentType === 'all' || eq.type === equipmentType);

            if (!equipmentList.length) {
                return { equipment: [], dailyData: [] };
            }

            let dailyData = sampleDataset.dailyData.slice(-sliceDays);

            if (efficiencyLevel !== 'all' && dailyData.length) {
                const lastDay = dailyData[dailyData.length - 1];
                const allowedIds = new Set(
                    lastDay.equipmentData
                        .filter(item => item.efficiencyLevel === efficiencyLevel)
                        .map(item => item.equipmentId)
                );
                equipmentList = equipmentList.filter(eq => allowedIds.has(eq.id));
            }

            if (!equipmentList.length) {
                return { equipment: [], dailyData: [] };
            }

            const selectedIds = new Set(equipmentList.map(eq => eq.id));
            dailyData = dailyData
                .map(day => ({
                    date: day.date,
                    equipmentData: day.equipmentData.filter(item => selectedIds.has(item.equipmentId))
                }))
                .filter(day => day.equipmentData.length > 0);

            if (!dailyData.length) {
                return { equipment: [], dailyData: [] };
            }

            return {
                equipment: equipmentList,
                dailyData
            };
        }

        // 更新概览卡片
        function updateOverview(data) {
            const container = document.getElementById('overview-cards');

            if (!data.dailyData.length || !data.equipment.length) {
                container.innerHTML = `
                    <div class="overview-card">
                        <div class="overview-card-label">暂无数据</div>
                        <div class="overview-card-value">--</div>
                        <div class="overview-card-unit">总产量</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-label">暂无数据</div>
                        <div class="overview-card-value">--</div>
                        <div class="overview-card-unit">总能耗</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-label">暂无数据</div>
                        <div class="overview-card-value">--</div>
                        <div class="overview-card-unit">单位能耗</div>
                    </div>
                    <div class="overview-card">
                        <div class="overview-card-label">暂无数据</div>
                        <div class="overview-card-value">--</div>
                        <div class="overview-card-unit">能效比</div>
                    </div>
                `;
                return;
            }
            
            // 计算统计数据
            const lastDayData = data.dailyData[data.dailyData.length - 1];
            const totalOutput = lastDayData.equipmentData.reduce((sum, d) => sum + d.output, 0);
            const totalEnergy = lastDayData.equipmentData.reduce((sum, d) => sum + d.energy, 0);
            const avgUnitEnergy = totalEnergy / totalOutput;
            const avgEfficiency = lastDayData.equipmentData.reduce((sum, d) => sum + d.efficiencyRatio, 0) / lastDayData.equipmentData.length;
            
            // 计算环比（与前一天对比）
            let outputTrend = 0;
            let energyTrend = 0;
            let efficiencyTrend = 0;
            if (data.dailyData.length > 1) {
                const prevDayData = data.dailyData[data.dailyData.length - 2];
                const prevTotalOutput = prevDayData.equipmentData.reduce((sum, d) => sum + d.output, 0);
                const prevTotalEnergy = prevDayData.equipmentData.reduce((sum, d) => sum + d.energy, 0);
                const prevAvgEfficiency = prevDayData.equipmentData.reduce((sum, d) => sum + d.efficiencyRatio, 0) / prevDayData.equipmentData.length;
                
                outputTrend = ((totalOutput - prevTotalOutput) / prevTotalOutput) * 100;
                energyTrend = ((totalEnergy - prevTotalEnergy) / prevTotalEnergy) * 100;
                efficiencyTrend = avgEfficiency - prevAvgEfficiency;
            }
            
            container.innerHTML = `
                <div class="overview-card">
                    <div class="overview-card-label">总产量</div>
                    <div class="overview-card-value">${totalOutput.toLocaleString()}</div>
                    <div class="overview-card-unit">单位</div>
                    ${outputTrend !== 0 ? `
                        <div class="overview-card-trend ${outputTrend > 0 ? 'positive' : 'negative'}">
                            <i class="fas fa-arrow-${outputTrend > 0 ? 'up' : 'down'}"></i>
                            ${Math.abs(outputTrend).toFixed(1)}%
                        </div>
                    ` : ''}
                </div>
                <div class="overview-card">
                    <div class="overview-card-label">总能耗</div>
                    <div class="overview-card-value">${totalEnergy.toFixed(1)}</div>
                    <div class="overview-card-unit">kWh</div>
                    ${energyTrend !== 0 ? `
                        <div class="overview-card-trend ${energyTrend < 0 ? 'positive' : 'negative'}">
                            <i class="fas fa-arrow-${energyTrend < 0 ? 'down' : 'up'}"></i>
                            ${Math.abs(energyTrend).toFixed(1)}%
                        </div>
                    ` : ''}
                </div>
                <div class="overview-card">
                    <div class="overview-card-label">平均单位产品能耗</div>
                    <div class="overview-card-value">${avgUnitEnergy.toFixed(2)}</div>
                    <div class="overview-card-unit">kWh/单位</div>
                </div>
                <div class="overview-card">
                    <div class="overview-card-label">平均能效比</div>
                    <div class="overview-card-value">${avgEfficiency.toFixed(1)}</div>
                    <div class="overview-card-unit">%</div>
                    ${efficiencyTrend !== 0 ? `
                        <div class="overview-card-trend ${efficiencyTrend > 0 ? 'positive' : 'negative'}">
                            <i class="fas fa-arrow-${efficiencyTrend > 0 ? 'up' : 'down'}"></i>
                            ${Math.abs(efficiencyTrend).toFixed(1)}%
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // 渲染设备列表
        function renderEquipmentList(data) {
            const container = document.getElementById('equipment-grid');

            if (!data.equipment.length || !data.dailyData.length) {
                container.innerHTML = '<div class="empty-state">暂无符合条件的设备</div>';
                return;
            }

            const lastDayData = data.dailyData[data.dailyData.length - 1];
            
            container.innerHTML = data.equipment.map(eq => {
                const eqData = lastDayData.equipmentData.find(d => d.equipmentId === eq.id);
                if (!eqData) return '';
                
                const efficiencyClass = eqData.efficiencyRatio >= 90 ? '' : 
                                       eqData.efficiencyRatio >= 75 ? 'warning' : 'danger';
                const efficiencyLevelText = eqData.efficiencyLevel === 'excellent' ? '优秀' :
                                           eqData.efficiencyLevel === 'good' ? '良好' :
                                           eqData.efficiencyLevel === 'normal' ? '一般' : '较差';
                const isSelected = selectedEquipment === eq.id;
                
                return `
                    <div class="equipment-card ${isSelected ? 'selected' : ''}" onclick="selectEquipment('${eq.id}')">
                        <div class="equipment-card-header">
                            <div class="equipment-name">${eq.name}</div>
                            <div class="equipment-status ${eqData.status}">
                                ${eqData.status === 'running' ? '运行' : eqData.status === 'standby' ? '待机' : '停机'}
                            </div>
                        </div>
                        <div class="equipment-info">
                            <div class="equipment-info-item">
                                <div class="equipment-info-label">设备类型</div>
                                <div class="equipment-info-value">${eq.type === 'production' ? '生产设备' : eq.type === 'processing' ? '加工设备' : '包装设备'}</div>
                            </div>
                            <div class="equipment-info-item">
                                <div class="equipment-info-label">额定功率</div>
                                <div class="equipment-info-value">${eq.ratedPower} kW</div>
                            </div>
                            <div class="equipment-info-item">
                                <div class="equipment-info-label">产量</div>
                                <div class="equipment-info-value">${eqData.output} 单位</div>
                            </div>
                            <div class="equipment-info-item">
                                <div class="equipment-info-label">能耗</div>
                                <div class="equipment-info-value">${eqData.energy} kWh</div>
                            </div>
                        </div>
                        <div class="equipment-efficiency">
                            <div class="efficiency-label">
                                <span>能效比</span>
                                <span class="efficiency-value">${eqData.efficiencyRatio}% (${efficiencyLevelText})</span>
                            </div>
                            <div class="efficiency-bar">
                                <div class="efficiency-fill ${efficiencyClass}" style="width: ${Math.min(eqData.efficiencyRatio, 100)}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 选择设备
        function selectEquipment(equipmentId) {
            selectedEquipment = equipmentId;
            if (currentData) {
                renderEquipmentList(currentData);
            }
        }

        // 渲染能效趋势图
        function renderEfficiencyTrendChart(data) {
            const container = document.getElementById('efficiency-trend-chart');

            if (!data.dailyData.length) {
                container.innerHTML = '<div class="empty-state">暂无趋势数据</div>';
                return;
            }

            const containerWidth = container.offsetWidth || container.clientWidth || 800;
            const containerHeight = 400;
            const padding = 70;
            const width = Math.max(containerWidth - 20, 600);
            const height = containerHeight - 20;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2 - 30;
            
            // 计算平均能效比
            const avgEfficiency = data.dailyData.map(day => {
                const avg = day.equipmentData.reduce((sum, d) => sum + d.efficiencyRatio, 0) / day.equipmentData.length;
                return { date: day.date, efficiency: avg };
            });
            
            const maxEfficiency = Math.max(...avgEfficiency.map(d => d.efficiency)) * 1.1;
            const minEfficiency = Math.min(...avgEfficiency.map(d => d.efficiency)) * 0.9;
            const svgWidth = width;
            const svgHeight = height;
            
            // 只显示部分数据点
            const displayData = avgEfficiency.length > 30 ? avgEfficiency.filter((d, i) => i % Math.ceil(avgEfficiency.length / 30) === 0) : avgEfficiency;
            
            let svg = `
                <svg width="100%" height="100%" viewBox="0 0 ${svgWidth} ${svgHeight}" preserveAspectRatio="xMidYMid meet" style="max-width: 100%;">
                    <defs>
                        <linearGradient id="efficiencyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#00bcd4;stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:#00bcd4;stop-opacity:0" />
                        </linearGradient>
                    </defs>
                    
                    <!-- 网格线 -->
                    ${Array.from({length: 5}, (_, i) => {
                        const y = padding + (chartHeight / 4) * i;
                        return `<line x1="${padding}" y1="${y}" x2="${svgWidth - padding}" y2="${y}" stroke="#3c5472" stroke-width="0.5" opacity="0.5"/>`;
                    }).join('')}
                    
                    <!-- Y轴标签 -->
                    ${Array.from({length: 5}, (_, i) => {
                        const y = padding + (chartHeight / 4) * i;
                        const value = maxEfficiency - ((maxEfficiency - minEfficiency) / 4) * i;
                        return `<text x="${padding - 15}" y="${y + 5}" fill="#a7bed3" font-size="11" text-anchor="end">${value.toFixed(1)}%</text>`;
                    }).join('')}
                    
                    <!-- 能效区域填充 -->
                    <polygon points="${displayData.map((d, i) => {
                        const x = padding + (chartWidth / (displayData.length - 1 || 1)) * i;
                        const y = padding + chartHeight - ((d.efficiency - minEfficiency) / (maxEfficiency - minEfficiency)) * chartHeight;
                        return `${x},${y}`;
                    }).join(' ')} ${svgWidth - padding},${padding + chartHeight} ${padding},${padding + chartHeight}" 
                        fill="url(#efficiencyGradient)"/>
                    
                    <!-- 能效趋势线 -->
                    <polyline points="${displayData.map((d, i) => {
                        const x = padding + (chartWidth / (displayData.length - 1 || 1)) * i;
                        const y = padding + chartHeight - ((d.efficiency - minEfficiency) / (maxEfficiency - minEfficiency)) * chartHeight;
                        return `${x},${y}`;
                    }).join(' ')}" 
                        fill="none" stroke="#00bcd4" stroke-width="2"/>
                    
                    <!-- 数据点 -->
                    ${displayData.filter((d, i) => i % Math.max(1, Math.floor(displayData.length / 10)) === 0).map((d, i) => {
                        const index = displayData.findIndex(item => item === d);
                        const x = padding + (chartWidth / (displayData.length - 1 || 1)) * index;
                        const y = padding + chartHeight - ((d.efficiency - minEfficiency) / (maxEfficiency - minEfficiency)) * chartHeight;
                        return `<circle cx="${x}" cy="${y}" r="4" fill="#00bcd4" opacity="0.8">
                            <title>能效比: ${d.efficiency.toFixed(1)}%</title>
                        </circle>`;
                    }).join('')}
                    
                    <!-- X轴标签 -->
                    ${displayData.filter((d, i) => i % Math.max(1, Math.floor(displayData.length / 5)) === 0 || i === displayData.length - 1).map((d, i) => {
                        const index = displayData.findIndex(item => item === d);
                        const x = padding + (chartWidth / (displayData.length - 1 || 1)) * index;
                        const date = new Date(d.date);
                        return `<text x="${x}" y="${padding + chartHeight + 25}" fill="#a7bed3" font-size="11" text-anchor="middle">${(date.getMonth() + 1)}/${date.getDate()}</text>`;
                    }).join('')}
                </svg>
            `;
            
            container.innerHTML = svg;
        }

        // 渲染能效对比图
        function renderEfficiencyComparisonChart(data) {
            const container = document.getElementById('efficiency-comparison-chart');

            if (!data.equipment.length || !data.dailyData.length) {
                container.innerHTML = '<div class="empty-state">暂无对比数据</div>';
                return;
            }

            const containerWidth = container.offsetWidth || container.clientWidth || 800;
            const containerHeight = 400;
            const padding = 70;
            const width = Math.max(containerWidth - 20, 600);
            const height = containerHeight - 20;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2 - 30;
            
            const lastDayData = data.dailyData[data.dailyData.length - 1];
            const equipmentData = data.equipment.map(eq => {
                const eqData = lastDayData.equipmentData.find(d => d.equipmentId === eq.id);
                return { ...eq, efficiency: eqData ? eqData.efficiencyRatio : 0 };
            }).sort((a, b) => b.efficiency - a.efficiency);
            
            const maxEfficiency = Math.max(...equipmentData.map(d => d.efficiency)) * 1.1;
            const svgWidth = width;
            const svgHeight = height;
            const barWidth = chartWidth / (equipmentData.length * 1.5);
            
            let svg = `
                <svg width="100%" height="100%" viewBox="0 0 ${svgWidth} ${svgHeight}" preserveAspectRatio="xMidYMid meet" style="max-width: 100%;">
                    <!-- 网格线 -->
                    ${Array.from({length: 5}, (_, i) => {
                        const y = padding + (chartHeight / 4) * i;
                        return `<line x1="${padding}" y1="${y}" x2="${svgWidth - padding}" y2="${y}" stroke="#3c5472" stroke-width="0.5" opacity="0.5"/>`;
                    }).join('')}
                    
                    <!-- Y轴标签 -->
                    ${Array.from({length: 5}, (_, i) => {
                        const y = padding + (chartHeight / 4) * i;
                        const value = maxEfficiency - (maxEfficiency / 4) * i;
                        return `<text x="${padding - 15}" y="${y + 5}" fill="#a7bed3" font-size="11" text-anchor="end">${value.toFixed(0)}%</text>`;
                    }).join('')}
                    
                    <!-- 柱状图 -->
                    ${equipmentData.map((eq, i) => {
                        const x = padding + (chartWidth / equipmentData.length) * i + (chartWidth / equipmentData.length) * 0.25;
                        const barHeight = (eq.efficiency / maxEfficiency) * chartHeight;
                        const y = padding + chartHeight - barHeight;
                        const color = eq.efficiency >= 90 ? '#4caf50' : eq.efficiency >= 75 ? '#ff9800' : '#f44336';
                        
                        return `
                            <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${color}" opacity="0.8">
                                <title>${eq.name}: ${eq.efficiency.toFixed(1)}%</title>
                            </rect>
                            <text x="${x + barWidth / 2}" y="${y - 5}" fill="#a7bed3" font-size="10" text-anchor="middle">${eq.efficiency.toFixed(1)}%</text>
                        `;
                    }).join('')}
                    
                    <!-- X轴标签 -->
                    ${equipmentData.map((eq, i) => {
                        const x = padding + (chartWidth / equipmentData.length) * i + (chartWidth / equipmentData.length) * 0.5;
                        return `<text x="${x}" y="${padding + chartHeight + 25}" fill="#a7bed3" font-size="11" text-anchor="middle" transform="rotate(-45 ${x} ${padding + chartHeight + 25})">${eq.name}</text>`;
                    }).join('')}
                </svg>
            `;
            
            container.innerHTML = svg;
        }

        // 更新详细数据表格
        function updateDetailTable(data) {
            const tbody = document.getElementById('detail-table-body');

            if (!data.equipment.length || !data.dailyData.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">暂无数据</td></tr>';
                return;
            }

            const lastDayData = data.dailyData[data.dailyData.length - 1];
            
            const rows = data.equipment.map(eq => {
                const eqData = lastDayData.equipmentData.find(d => d.equipmentId === eq.id);
                if (!eqData) return '';
                
                const efficiencyLevelText = eqData.efficiencyLevel === 'excellent' ? '优秀' :
                                           eqData.efficiencyLevel === 'good' ? '良好' :
                                           eqData.efficiencyLevel === 'normal' ? '一般' : '较差';
                const efficiencyColor = eqData.efficiencyLevel === 'excellent' ? '#4caf50' :
                                       eqData.efficiencyLevel === 'good' ? '#00bcd4' :
                                       eqData.efficiencyLevel === 'normal' ? '#ff9800' : '#f44336';
                const statusText = eqData.status === 'running' ? '运行' : eqData.status === 'standby' ? '待机' : '停机';
                const statusColor = eqData.status === 'running' ? '#4caf50' : eqData.status === 'standby' ? '#ff9800' : '#9e9e9e';
                
                return `
                    <tr>
                        <td>${eq.name}</td>
                        <td>${eq.type === 'production' ? '生产设备' : eq.type === 'processing' ? '加工设备' : '包装设备'}</td>
                        <td>${eqData.output}</td>
                        <td>${eqData.energy}</td>
                        <td>${eqData.unitEnergy}</td>
                        <td>${eqData.efficiencyRatio}%</td>
                        <td><span style="color: ${efficiencyColor}">${efficiencyLevelText}</span></td>
                        <td><span style="color: ${statusColor}">${statusText}</span></td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows || '<tr><td colspan="8" class="empty-state">暂无数据</td></tr>';
        }

        // 导出数据
        function exportData() {
            alert('导出功能开发中...');
        }

        window.initProductionEquipmentEfficiency = initProductionEquipmentEfficiency;
        window.selectEquipment = selectEquipment;
        window.exportProductionEquipmentEfficiencyData = exportData;

        // 确保初始化
        function ensureInit() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(initProductionEquipmentEfficiency, 200);
                });
            } else {
                // 延迟一点确保DOM完全加载，特别是在iframe中
                setTimeout(initProductionEquipmentEfficiency, 300);
            }
        }

        ensureInit();
        })();
    </script>
</div>
