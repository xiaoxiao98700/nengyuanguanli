<div class="sub-menu-content-container">
    <style>
        /* 统一滚动条样式 */
        * {
            scrollbar-width: thin;
            scrollbar-color: #3c5472 #1a2a3a;
        }
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1a2a3a;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3c5472;
            border-radius: 5px;
            border: 2px solid #1a2a3a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a6a8a;
        }
        ::-webkit-scrollbar-thumb:active {
            background: #00bcd4;
        }
        ::-webkit-scrollbar-corner {
            background: #1a2a3a;
        }
        
        .alarm-analysis-container {
            padding: 20px;
            background-color: #0f1e2d;
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Source Han Sans', Arial, sans-serif;
        }

        .page-header {
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 24px;
            color: #00bcd4;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .page-description {
            color: #a7bed3;
            margin-top: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        /* 筛选区域 */
        .filter-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-item label {
            color: #a7bed3;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-select, .filter-input {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            color: #e0e6ed;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .filter-input {
            cursor: text;
        }

        .filter-select:hover, .filter-input:focus {
            border-color: #00bcd4;
            outline: none;
        }

        .action-button {
            background-color: #00bcd4;
            border: none;
            color: #1a2a3a;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            background-color: #00acc1;
            transform: translateY(-1px);
        }

        .action-button.secondary {
            background-color: #3c5472;
            color: #e0e6ed;
        }

        .action-button.secondary:hover {
            background-color: #4a6a8a;
        }

        /* 统计卡片 */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-label {
            color: #a7bed3;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            color: #e0e6ed;
            font-size: 24px;
            font-weight: bold;
        }

        .stat-card.critical .stat-value {
            color: #f44336;
        }

        .stat-card.warning .stat-value {
            color: #ff9800;
        }

        .stat-card.info .stat-value {
            color: #00bcd4;
        }

        /* 图表区域 */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-panel {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            font-size: 16px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            position: relative;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        /* 统计表格 */
        .stats-table-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .stats-table th {
            background-color: #1a2a3a;
            color: #e0e6ed;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #3c5472;
            white-space: nowrap;
        }

        .stats-table td {
            padding: 12px;
            color: #a7bed3;
            border-bottom: 1px solid #3c5472;
        }

        .stats-table tbody tr:hover {
            background-color: #1e2d3f;
        }

        .stats-table tbody tr:last-child td {
            border-bottom: none;
        }

        .level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .level-badge.critical {
            background-color: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.4);
        }

        .level-badge.warning {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: 1px solid rgba(255, 152, 0, 0.4);
        }

        .level-badge.info {
            background-color: rgba(0, 188, 212, 0.2);
            color: #00bcd4;
            border: 1px solid rgba(0, 188, 212, 0.4);
        }

        /* 历史告警列表 */
        .alarm-list-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .alarm-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .alarm-item {
            background-color: #1a2a3a;
            border-left: 4px solid #3c5472;
            border-radius: 4px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .alarm-item:hover {
            background-color: #1e2d3f;
            border-left-color: #00bcd4;
        }

        .alarm-item.critical {
            border-left-color: #f44336;
        }

        .alarm-item.warning {
            border-left-color: #ff9800;
        }

        .alarm-item.info {
            border-left-color: #00bcd4;
        }

        .alarm-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .alarm-name {
            font-size: 16px;
            color: #e0e6ed;
            font-weight: 600;
        }

        .alarm-time {
            color: #a7bed3;
            font-size: 13px;
        }

        .alarm-content {
            color: #a7bed3;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .alarm-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 13px;
            color: #7a8fa3;
        }

        .alarm-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a7bed3;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* 分页 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            padding: 15px;
            flex-wrap: wrap;
        }

        .pagination-button {
            background: #1a2a3a;
            border: 1px solid #3c5472;
            color: #e0e6ed;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-button:hover:not(:disabled) {
            background: #2a3d54;
            border-color: #00bcd4;
            color: #00bcd4;
            transform: translateY(-1px);
        }

        .pagination-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-button.active {
            background: linear-gradient(135deg, #00bcd4 0%, #00acc1 100%);
            color: #1a2a3a;
            border-color: #00bcd4;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 188, 212, 0.3);
        }

        .pagination-info {
            color: #a7bed3;
            font-size: 14px;
            margin: 0 12px;
            white-space: nowrap;
        }

        .pagination-jump {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 12px;
        }

        .pagination-jump input {
            background: #1a2a3a;
            border: 1px solid #3c5472;
            color: #e0e6ed;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
            width: 60px;
            text-align: center;
        }

        .pagination-jump input:focus {
            outline: none;
            border-color: #00bcd4;
        }

        .pagination-jump button {
            background: #00bcd4;
            border: none;
            color: #1a2a3a;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination-jump button:hover {
            background: #00acc1;
            transform: translateY(-1px);
        }
    </style>

    <div class="alarm-analysis-container">
        <div class="page-header">
            <h2 class="page-title">
                <i class="fas fa-chart-bar"></i> 告警分析
            </h2>
            <p class="page-description">
                支持查询历史告警内容，可针对同设备的告警类型、次数进行统计分析，帮助识别设备故障模式和趋势。
            </p>
        </div>

        <!-- 筛选区域 -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-item">
                    <label>时间范围：</label>
                    <select class="filter-select" id="filter-time-range">
                        <option value="today">今天</option>
                        <option value="week">近一周</option>
                        <option value="month" selected>近一月</option>
                        <option value="quarter">近一季度</option>
                        <option value="year">近一年</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
                <div class="filter-item" id="custom-date-range" style="display: none;">
                    <label>开始日期：</label>
                    <input type="date" class="filter-input" id="start-date" value="2024-12-01">
                </div>
                <div class="filter-item" id="custom-date-range-end" style="display: none;">
                    <label>结束日期：</label>
                    <input type="date" class="filter-input" id="end-date" value="2024-12-31">
                </div>
                <div class="filter-item">
                    <label>设备：</label>
                    <select class="filter-select" id="filter-equipment">
                        <option value="all">全部设备</option>
                        <option value="主电机">主电机</option>
                        <option value="压缩机">压缩机</option>
                        <option value="水泵">水泵</option>
                        <option value="变压器">变压器</option>
                        <option value="风机">风机</option>
                        <option value="冷却系统">冷却系统</option>
                        <option value="压缩空气系统">压缩空气系统</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>告警类型：</label>
                    <select class="filter-select" id="filter-type">
                        <option value="all">全部类型</option>
                        <option value="temperature">温度</option>
                        <option value="pressure">压力</option>
                        <option value="current">电流</option>
                        <option value="voltage">电压</option>
                        <option value="power">功率</option>
                        <option value="flow">流量</option>
                        <option value="vibration">振动</option>
                        <option value="energy">能耗</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>告警级别：</label>
                    <select class="filter-select" id="filter-level">
                        <option value="all">全部级别</option>
                        <option value="critical">严重</option>
                        <option value="warning">警告</option>
                        <option value="info">提示</option>
                    </select>
                </div>
                <button class="action-button" onclick="queryAlarms()">
                    <i class="fas fa-search"></i> 查询
                </button>
                <button class="action-button secondary" onclick="resetFilter()">
                    <i class="fas fa-redo"></i> 重置
                </button>
                <button class="action-button secondary" onclick="exportData()">
                    <i class="fas fa-download"></i> 导出
                </button>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="stats-section" id="stats-section">
            <!-- 统计卡片将通过JavaScript动态生成 -->
        </div>

        <!-- 图表区域 -->
        <div class="charts-section">
            <div class="chart-panel">
                <div class="chart-title">
                    <i class="fas fa-chart-bar"></i> 按设备统计告警次数
                </div>
                <div class="chart-container" id="equipment-chart">
                    <!-- 图表将通过JavaScript动态生成 -->
                </div>
            </div>
            <div class="chart-panel">
                <div class="chart-title">
                    <i class="fas fa-chart-pie"></i> 按告警类型统计
                </div>
                <div class="chart-container" id="type-chart">
                    <!-- 图表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 统计表格 -->
        <div class="stats-table-section">
            <div class="section-title">
                <i class="fas fa-table"></i> 设备告警统计分析
            </div>
            <table class="stats-table" id="stats-table">
                <thead>
                    <tr>
                        <th>设备名称</th>
                        <th>告警类型</th>
                        <th>告警次数</th>
                        <th>严重告警</th>
                        <th>警告告警</th>
                        <th>提示告警</th>
                        <th>最后告警时间</th>
                    </tr>
                </thead>
                <tbody id="stats-table-body">
                    <!-- 表格数据将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>

        <!-- 历史告警列表 -->
        <div class="alarm-list-section">
            <div class="section-title">
                <i class="fas fa-list"></i> 历史告警列表
            </div>
            <div class="alarm-list" id="alarm-list">
                <!-- 告警列表将通过JavaScript动态生成 -->
            </div>
            <!-- 分页控件 -->
            <div class="pagination" id="alarm-list-pagination" style="display: none;">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // 历史告警数据（示例数据）
    let alarmHistory = [
        { id: 1, name: '主电机电流过载', content: '主电机电流达到125A，超过设定上限120A', equipment: '主电机', type: 'current', level: 'critical', time: '2024-12-15 08:30:25', station: '生产车间1' },
        { id: 2, name: '压缩机温度异常', content: '压缩机运行温度达到88℃，超过设定上限85℃', equipment: '压缩机', type: 'temperature', level: 'warning', time: '2024-12-15 09:15:42', station: '生产车间1' },
        { id: 3, name: '水泵流量不足', content: '水泵流量降至45L/min，低于设定下限50L/min', equipment: '水泵', type: 'flow', level: 'warning', time: '2024-12-15 10:22:18', station: '生产车间1' },
        { id: 4, name: '变压器温度过高', content: '变压器温度达到78℃，超过设定上限75℃', equipment: '变压器', type: 'temperature', level: 'warning', time: '2024-12-15 11:05:33', station: '生产车间1' },
        { id: 5, name: '电压波动异常', content: '电压达到410V，超出正常范围360-400V', equipment: '生产车间1', type: 'voltage', level: 'warning', time: '2024-12-15 12:18:56', station: '生产车间1' },
        { id: 6, name: '风机振动异常', content: '风机振动幅度达到8.5mm/s，超过设定上限8.0mm/s', equipment: '风机', type: 'vibration', level: 'info', time: '2024-12-15 13:45:12', station: '生产车间1' },
        { id: 7, name: '能耗超标', content: '能耗达到历史平均值的135%，超过设定上限130%', equipment: '生产车间1', type: 'energy', level: 'warning', time: '2024-12-15 14:30:47', station: '生产车间1' },
        { id: 8, name: '功率超限', content: '主电机功率达到105kW，超过设定上限100kW', equipment: '主电机', type: 'power', level: 'critical', time: '2024-12-15 15:12:28', station: '生产车间1' },
        { id: 9, name: '压缩空气压力不足', content: '压缩空气压力降至0.55MPa，低于设定下限0.6MPa', equipment: '压缩空气系统', type: 'pressure', level: 'info', time: '2024-12-15 16:25:14', station: '生产车间1' },
        { id: 10, name: '主电机电流过载', content: '主电机电流达到122A，超过设定上限120A', equipment: '主电机', type: 'current', level: 'critical', time: '2024-12-15 17:40:33', station: '生产车间1' },
        { id: 11, name: '压缩机温度异常', content: '压缩机运行温度达到87℃，超过设定上限85℃', equipment: '压缩机', type: 'temperature', level: 'warning', time: '2024-12-15 18:55:21', station: '生产车间1' },
        { id: 12, name: '冷却水温度过高', content: '冷却水温度达到42℃，超过设定上限40℃', equipment: '冷却系统', type: 'temperature', level: 'warning', time: '2024-12-15 19:20:15', station: '生产车间1' },
        { id: 13, name: '电压波动异常', content: '电压降至355V，低于正常范围下限360V', equipment: '生产车间1', type: 'voltage', level: 'critical', time: '2024-12-16 08:15:42', station: '生产车间1' },
        { id: 14, name: '水泵流量不足', content: '水泵流量降至48L/min，低于设定下限50L/min', equipment: '水泵', type: 'flow', level: 'warning', time: '2024-12-16 09:30:28', station: '生产车间1' },
        { id: 15, name: '主电机电流过载', content: '主电机电流达到118A，接近设定上限120A', equipment: '主电机', type: 'current', level: 'warning', time: '2024-12-16 10:45:56', station: '生产车间1' },
        { id: 16, name: '变压器温度过高', content: '变压器温度达到76℃，超过设定上限75℃', equipment: '变压器', type: 'temperature', level: 'warning', time: '2024-12-16 11:20:13', station: '生产车间1' },
        { id: 17, name: '风机振动异常', content: '风机振动幅度达到8.2mm/s，超过设定上限8.0mm/s', equipment: '风机', type: 'vibration', level: 'info', time: '2024-12-16 12:35:47', station: '生产车间1' },
        { id: 18, name: '功率超限', content: '主电机功率达到98kW，接近设定上限100kW', equipment: '主电机', type: 'power', level: 'warning', time: '2024-12-16 13:50:22', station: '生产车间1' },
        { id: 19, name: '压缩空气压力不足', content: '压缩空气压力降至0.58MPa，低于设定下限0.6MPa', equipment: '压缩空气系统', type: 'pressure', level: 'info', time: '2024-12-16 14:15:38', station: '生产车间1' },
        { id: 20, name: '能耗超标', content: '能耗达到历史平均值的128%，超过设定上限130%', equipment: '生产车间1', type: 'energy', level: 'warning', time: '2024-12-16 15:30:54', station: '生产车间1' },
        { id: 21, name: '压缩机温度异常', content: '压缩机运行温度达到86℃，超过设定上限85℃', equipment: '压缩机', type: 'temperature', level: 'warning', time: '2024-12-16 16:45:19', station: '生产车间1' },
        { id: 22, name: '主电机电流过载', content: '主电机电流达到123A，超过设定上限120A', equipment: '主电机', type: 'current', level: 'critical', time: '2024-12-16 17:20:33', station: '生产车间1' },
        { id: 23, name: '电压波动异常', content: '电压达到405V，超出正常范围上限400V', equipment: '生产车间1', type: 'voltage', level: 'warning', time: '2024-12-16 18:35:47', station: '生产车间1' },
        { id: 24, name: '冷却水温度过高', content: '冷却水温度达到41℃，超过设定上限40℃', equipment: '冷却系统', type: 'temperature', level: 'warning', time: '2024-12-16 19:50:12', station: '生产车间1' },
        { id: 25, name: '水泵流量不足', content: '水泵流量降至47L/min，低于设定下限50L/min', equipment: '水泵', type: 'flow', level: 'warning', time: '2024-12-17 08:25:28', station: '生产车间1' },
        { id: 26, name: '变压器温度过高', content: '变压器温度达到77℃，超过设定上限75℃', equipment: '变压器', type: 'temperature', level: 'warning', time: '2024-12-17 09:40:15', station: '生产车间1' },
        { id: 27, name: '主电机电流过载', content: '主电机电流达到121A，超过设定上限120A', equipment: '主电机', type: 'current', level: 'critical', time: '2024-12-17 10:55:42', station: '生产车间1' },
        { id: 28, name: '功率超限', content: '主电机功率达到102kW，超过设定上限100kW', equipment: '主电机', type: 'power', level: 'critical', time: '2024-12-17 11:30:56', station: '生产车间1' },
        { id: 29, name: '压缩空气压力不足', content: '压缩空气压力降至0.57MPa，低于设定下限0.6MPa', equipment: '压缩空气系统', type: 'pressure', level: 'info', time: '2024-12-17 12:45:23', station: '生产车间1' },
        { id: 30, name: '风机振动异常', content: '风机振动幅度达到8.3mm/s，超过设定上限8.0mm/s', equipment: '风机', type: 'vibration', level: 'info', time: '2024-12-17 13:20:37', station: '生产车间1' }
    ];

    // 类型映射
    const typeMap = {
        'temperature': '温度',
        'pressure': '压力',
        'current': '电流',
        'voltage': '电压',
        'power': '功率',
        'flow': '流量',
        'vibration': '振动',
        'energy': '能耗'
    };

    // 级别映射
    const levelMap = {
        'critical': '严重',
        'warning': '警告',
        'info': '提示'
    };

    // 筛选数据
    function getFilteredData() {
        const timeRange = document.getElementById('filter-time-range').value;
        const equipment = document.getElementById('filter-equipment').value;
        const type = document.getElementById('filter-type').value;
        const level = document.getElementById('filter-level').value;

        let filtered = [...alarmHistory];

        // 时间筛选
        if (timeRange === 'custom') {
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);
            endDate.setHours(23, 59, 59, 999);
            filtered = filtered.filter(item => {
                const itemDate = new Date(item.time);
                return itemDate >= startDate && itemDate <= endDate;
            });
        } else {
            const now = new Date();
            let cutoffDate = new Date();
            if (timeRange === 'today') {
                cutoffDate.setHours(0, 0, 0, 0);
            } else if (timeRange === 'week') {
                cutoffDate.setDate(now.getDate() - 7);
            } else if (timeRange === 'month') {
                cutoffDate.setMonth(now.getMonth() - 1);
            } else if (timeRange === 'quarter') {
                cutoffDate.setMonth(now.getMonth() - 3);
            } else if (timeRange === 'year') {
                cutoffDate.setFullYear(now.getFullYear() - 1);
            }
            filtered = filtered.filter(item => {
                const itemDate = new Date(item.time);
                return itemDate >= cutoffDate;
            });
        }

        // 设备筛选
        if (equipment !== 'all') {
            filtered = filtered.filter(item => item.equipment === equipment);
        }

        // 类型筛选
        if (type !== 'all') {
            filtered = filtered.filter(item => item.type === type);
        }

        // 级别筛选
        if (level !== 'all') {
            filtered = filtered.filter(item => item.level === level);
        }

        return filtered;
    }

    // 计算统计数据
    function calculateStats(data) {
        const stats = {
            total: data.length,
            critical: data.filter(item => item.level === 'critical').length,
            warning: data.filter(item => item.level === 'warning').length,
            info: data.filter(item => item.level === 'info').length
        };

        // 按设备统计
        const equipmentStats = {};
        data.forEach(item => {
            if (!equipmentStats[item.equipment]) {
                equipmentStats[item.equipment] = {
                    total: 0,
                    critical: 0,
                    warning: 0,
                    info: 0,
                    types: {},
                    lastTime: item.time
                };
            }
            equipmentStats[item.equipment].total++;
            equipmentStats[item.equipment][item.level]++;
            if (!equipmentStats[item.equipment].types[item.type]) {
                equipmentStats[item.equipment].types[item.type] = 0;
            }
            equipmentStats[item.equipment].types[item.type]++;
            if (new Date(item.time) > new Date(equipmentStats[item.equipment].lastTime)) {
                equipmentStats[item.equipment].lastTime = item.time;
            }
        });

        // 按类型统计
        const typeStats = {};
        data.forEach(item => {
            if (!typeStats[item.type]) {
                typeStats[item.type] = 0;
            }
            typeStats[item.type]++;
        });

        return { stats, equipmentStats, typeStats };
    }

    // 渲染统计卡片
    function renderStats(stats) {
        const container = document.getElementById('stats-section');
        container.innerHTML = `
            <div class="stat-card">
                <div class="stat-label">
                    <i class="fas fa-exclamation-triangle"></i> 总告警数
                </div>
                <div class="stat-value">${stats.total}</div>
            </div>
            <div class="stat-card critical">
                <div class="stat-label">
                    <i class="fas fa-exclamation-circle"></i> 严重告警
                </div>
                <div class="stat-value">${stats.critical}</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-label">
                    <i class="fas fa-exclamation-triangle"></i> 警告告警
                </div>
                <div class="stat-value">${stats.warning}</div>
            </div>
            <div class="stat-card info">
                <div class="stat-label">
                    <i class="fas fa-info-circle"></i> 提示告警
                </div>
                <div class="stat-value">${stats.info}</div>
            </div>
        `;
    }

    // 渲染设备统计图表
    function renderEquipmentChart(equipmentStats) {
        const container = document.getElementById('equipment-chart');
        const equipmentNames = Object.keys(equipmentStats);
        const counts = equipmentNames.map(name => equipmentStats[name].total);
        
        if (equipmentNames.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-chart-bar"></i><p>暂无数据</p></div>';
            return;
        }

        const maxCount = Math.max(...counts, 1);
        const chartWidth = 600;
        const chartHeight = 280;
        const barWidth = Math.max(30, (chartWidth - 100) / equipmentNames.length - 10);
        const maxBarHeight = chartHeight - 60;

        let svg = `<svg class="chart-svg" viewBox="0 0 ${chartWidth} ${chartHeight}">`;
        
        // 绘制坐标轴
        svg += `<line x1="40" y1="${chartHeight - 30}" x2="${chartWidth - 20}" y2="${chartHeight - 30}" stroke="#3c5472" stroke-width="2"/>`;
        svg += `<line x1="40" y1="20" x2="40" y2="${chartHeight - 30}" stroke="#3c5472" stroke-width="2"/>`;

        // 绘制柱状图
        equipmentNames.forEach((name, index) => {
            const x = 50 + index * (barWidth + 10);
            const barHeight = (counts[index] / maxCount) * maxBarHeight;
            const y = chartHeight - 30 - barHeight;
            const color = counts[index] >= 5 ? '#f44336' : counts[index] >= 3 ? '#ff9800' : '#00bcd4';
            
            svg += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${color}" rx="2"/>`;
            svg += `<text x="${x + barWidth / 2}" y="${chartHeight - 10}" fill="#a7bed3" font-size="11" text-anchor="middle">${name.length > 4 ? name.substring(0, 4) : name}</text>`;
            svg += `<text x="${x + barWidth / 2}" y="${y - 5}" fill="#e0e6ed" font-size="12" text-anchor="middle" font-weight="bold">${counts[index]}</text>`;
        });

        // Y轴刻度
        for (let i = 0; i <= 5; i++) {
            const value = Math.round((maxCount / 5) * i);
            const y = chartHeight - 30 - (maxBarHeight / 5) * i;
            svg += `<line x1="35" y1="${y}" x2="40" y2="${y}" stroke="#3c5472" stroke-width="1"/>`;
            svg += `<text x="30" y="${y + 4}" fill="#a7bed3" font-size="11" text-anchor="end">${value}</text>`;
        }

        svg += `</svg>`;
        container.innerHTML = svg;
    }

    // 渲染类型统计图表
    function renderTypeChart(typeStats) {
        const container = document.getElementById('type-chart');
        const types = Object.keys(typeStats);
        const counts = types.map(type => typeStats[type]);
        
        if (types.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-chart-pie"></i><p>暂无数据</p></div>';
            return;
        }

        const total = counts.reduce((sum, count) => sum + count, 0);
        const colors = ['#f44336', '#ff9800', '#00bcd4', '#4caf50', '#9c27b0', '#2196f3', '#ff5722', '#795548'];
        const chartSize = 250;
        const centerX = chartSize / 2;
        const centerY = chartSize / 2;
        const radius = 80;

        let svg = `<svg class="chart-svg" viewBox="0 0 ${chartSize} ${chartSize + 100}">`;
        
        let currentAngle = -Math.PI / 2;
        types.forEach((type, index) => {
            const angle = (counts[index] / total) * 2 * Math.PI;
            const startAngle = currentAngle;
            const endAngle = currentAngle + angle;
            
            const x1 = centerX + radius * Math.cos(startAngle);
            const y1 = centerY + radius * Math.sin(startAngle);
            const x2 = centerX + radius * Math.cos(endAngle);
            const y2 = centerY + radius * Math.sin(endAngle);
            
            const largeArc = angle > Math.PI ? 1 : 0;
            const path = `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;
            
            svg += `<path d="${path}" fill="${colors[index % colors.length]}" stroke="#1a2a3a" stroke-width="2"/>`;
            
            // 标签
            const labelAngle = startAngle + angle / 2;
            const labelX = centerX + (radius + 30) * Math.cos(labelAngle);
            const labelY = centerY + (radius + 30) * Math.sin(labelAngle);
            svg += `<text x="${labelX}" y="${labelY}" fill="#e0e6ed" font-size="12" text-anchor="middle">${typeMap[type]}</text>`;
            svg += `<text x="${labelX}" y="${labelY + 15}" fill="#a7bed3" font-size="11" text-anchor="middle">${counts[index]}次</text>`;
            
            currentAngle = endAngle;
        });

        // 图例
        let legendY = chartSize + 20;
        types.forEach((type, index) => {
            const x = index % 2 === 0 ? 30 : chartSize / 2 + 20;
            if (index % 2 === 0 && index > 0) legendY += 25;
            svg += `<rect x="${x}" y="${legendY}" width="12" height="12" fill="${colors[index % colors.length]}"/>`;
            svg += `<text x="${x + 18}" y="${legendY + 9}" fill="#a7bed3" font-size="12">${typeMap[type]} (${counts[index]})</text>`;
        });

        svg += `</svg>`;
        container.innerHTML = svg;
    }

    // 渲染统计表格
    function renderStatsTable(equipmentStats) {
        const tbody = document.getElementById('stats-table-body');
        const equipmentNames = Object.keys(equipmentStats).sort((a, b) => 
            equipmentStats[b].total - equipmentStats[a].total
        );

        if (equipmentNames.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无统计数据</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = equipmentNames.map(name => {
            const stat = equipmentStats[name];
            const typeList = Object.keys(stat.types).map(type => 
                `${typeMap[type]}(${stat.types[type]})`
            ).join('、');
            
            return `
                <tr>
                    <td>${name}</td>
                    <td>${typeList || '-'}</td>
                    <td><strong>${stat.total}</strong></td>
                    <td><span class="level-badge critical">${stat.critical}</span></td>
                    <td><span class="level-badge warning">${stat.warning}</span></td>
                    <td><span class="level-badge info">${stat.info}</span></td>
                    <td>${stat.lastTime}</td>
                </tr>
            `;
        }).join('');
    }

    // 分页配置
    let currentPage = 1;
    const pageSize = 10; // 每页显示10条数据

    // 渲染历史告警列表（带分页）
    function renderAlarmList(data) {
        const container = document.getElementById('alarm-list');
        const pagination = document.getElementById('alarm-list-pagination');
        
        if (data.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>暂无告警数据</p>
                </div>
            `;
            if (pagination) pagination.style.display = 'none';
            return;
        }

        // 计算分页
        const totalRecords = data.length;
        const totalPages = Math.ceil(totalRecords / pageSize);
        
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = 1;
        }

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalRecords);
        const currentPageData = data.slice(startIndex, endIndex);

        container.innerHTML = currentPageData.map((item, index) => {
            const globalIndex = startIndex + index;
            return `
            <div class="alarm-item ${item.level}">
                <div class="alarm-header">
                    <div class="alarm-name">${item.name}</div>
                    <div class="alarm-time">${item.time}</div>
                </div>
                <div class="alarm-content">${item.content}</div>
                <div class="alarm-meta">
                    <div class="alarm-meta-item">
                        <i class="fas fa-cog"></i> 设备：${item.equipment}
                    </div>
                    <div class="alarm-meta-item">
                        <i class="fas fa-tag"></i> 类型：${typeMap[item.type]}
                    </div>
                    <div class="alarm-meta-item">
                        <i class="fas fa-signal"></i> 级别：<span class="level-badge ${item.level}">${levelMap[item.level]}</span>
                    </div>
                    <div class="alarm-meta-item">
                        <i class="fas fa-building"></i> 厂站：${item.station}
                    </div>
                </div>
            </div>
        `;
        }).join('');

        renderPagination(totalPages, totalRecords, startIndex + 1, endIndex);
    }

    // 渲染分页控件
    function renderPagination(totalPages, totalRecords, startRecord, endRecord) {
        const pagination = document.getElementById('alarm-list-pagination');
        if (!pagination) return;

        if (totalPages <= 1) {
            pagination.style.display = 'none';
            return;
        }

        pagination.style.display = 'flex';
        let html = '';

        // 上一页按钮
        html += `<button class="pagination-button" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i> 上一页
        </button>`;

        // 页码按钮
        const maxVisiblePages = 7;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        // 第一页
        if (startPage > 1) {
            html += `<button class="pagination-button" onclick="goToPage(1)">1</button>`;
            if (startPage > 2) {
                html += `<span class="pagination-info">...</span>`;
            }
        }

        // 中间页码
        for (let i = startPage; i <= endPage; i++) {
            html += `<button class="pagination-button ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        }

        // 最后一页
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += `<span class="pagination-info">...</span>`;
            }
            html += `<button class="pagination-button" onclick="goToPage(${totalPages})">${totalPages}</button>`;
        }

        // 下一页按钮
        html += `<button class="pagination-button" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
            下一页 <i class="fas fa-chevron-right"></i>
        </button>`;

        // 分页信息
        html += `<span class="pagination-info">共 ${totalRecords} 条，第 ${startRecord}-${endRecord} 条</span>`;

        // 跳转输入
        html += `<div class="pagination-jump">
            <span style="color: #a7bed3; font-size: 13px;">跳至</span>
            <input type="number" id="page-jump-input" min="1" max="${totalPages}" value="${currentPage}" onkeypress="handlePageJump(event)">
            <span style="color: #a7bed3; font-size: 13px;">页</span>
            <button onclick="jumpToPage()">确定</button>
        </div>`;

        pagination.innerHTML = html;
    }

    // 跳转到指定页
    window.goToPage = function(page) {
        const data = getFilteredData();
        const totalPages = Math.ceil(data.length / pageSize);
        
        if (page < 1 || page > totalPages) return;
        
        currentPage = page;
        renderAlarmList(data);
        
        // 滚动到列表顶部
        const listSection = document.querySelector('.alarm-list-section');
        if (listSection) {
            listSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    };

    // 处理跳转输入框的Enter键
    window.handlePageJump = function(event) {
        if (event.key === 'Enter') {
            jumpToPage();
        }
    };

    // 跳转到指定页（通过输入框）
    window.jumpToPage = function() {
        const input = document.getElementById('page-jump-input');
        if (!input) return;
        
        const targetPage = parseInt(input.value);
        if (isNaN(targetPage) || targetPage < 1) {
            alert('请输入有效的页码');
            return;
        }

        const data = getFilteredData();
        const totalPages = Math.ceil(data.length / pageSize);
        
        if (targetPage > totalPages) {
            alert(`页码不能超过 ${totalPages}`);
            input.value = currentPage;
            return;
        }

        goToPage(targetPage);
    };

    // 查询告警
    window.queryAlarms = function() {
        currentPage = 1; // 重置到第一页
        const data = getFilteredData();
        const { stats, equipmentStats, typeStats } = calculateStats(data);
        
        renderStats(stats);
        renderEquipmentChart(equipmentStats);
        renderTypeChart(typeStats);
        renderStatsTable(equipmentStats);
        renderAlarmList(data);
    };

    // 重置筛选
    window.resetFilter = function() {
        document.getElementById('filter-time-range').value = 'month';
        document.getElementById('filter-equipment').value = 'all';
        document.getElementById('filter-type').value = 'all';
        document.getElementById('filter-level').value = 'all';
        document.getElementById('custom-date-range').style.display = 'none';
        document.getElementById('custom-date-range-end').style.display = 'none';
        queryAlarms();
    };

    // 导出数据
    window.exportData = function() {
        const data = getFilteredData();
        const { stats, equipmentStats, typeStats } = calculateStats(data);
        
        const exportData = {
            queryTime: new Date().toISOString(),
            stats: stats,
            equipmentStats: equipmentStats,
            typeStats: typeStats,
            alarmList: data
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'alarm-analysis-' + new Date().toISOString().split('T')[0] + '.json';
        link.click();
        URL.revokeObjectURL(url);
        alert('数据导出成功！');
    };

    // 自定义时间范围显示/隐藏
    document.getElementById('filter-time-range').addEventListener('change', function() {
        const isCustom = this.value === 'custom';
        document.getElementById('custom-date-range').style.display = isCustom ? 'flex' : 'none';
        document.getElementById('custom-date-range-end').style.display = isCustom ? 'flex' : 'none';
    });

    // 初始化
    function init() {
        // 调整默认日期范围以包含样例数据
        const now = new Date();
        const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const startDate = new Date(endDate);
        startDate.setMonth(startDate.getMonth() - 1);
        
        document.getElementById('start-date').value = '2024-12-01';
        document.getElementById('end-date').value = '2024-12-31';
        
        queryAlarms();
    }

    // 确保在iframe中也能正确初始化
    function ensureInit() {
        const statsSection = document.getElementById('stats-section');
        if (!statsSection) {
            setTimeout(ensureInit, 100);
            return;
        }
        init();
    }

    // 页面加载时初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ensureInit);
    } else {
        ensureInit();
    }
})();
</script>
