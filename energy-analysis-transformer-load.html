<div class="transformer-load-container">
    <style>
        /* 统一滚动条样式 */
        * {
            scrollbar-width: thin;
            scrollbar-color: #3c5472 #1a2a3a;
        }
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1a2a3a;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3c5472;
            border-radius: 5px;
            border: 2px solid #1a2a3a;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4a6a8a;
        }
        ::-webkit-scrollbar-thumb:active {
            background: #00bcd4;
        }
        ::-webkit-scrollbar-corner {
            background: #1a2a3a;
        }
        
        .transformer-load-container {
            padding: 20px;
            background-color: #0f1e2d;
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 25px;
        }

        .page-title {
            font-size: 24px;
            color: #00bcd4;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .page-description {
            color: #a7bed3;
            font-size: 14px;
            margin-top: 8px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* 筛选区域 */
        .filter-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-item label {
            color: #a7bed3;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-select {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            color: #e0e6ed;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
            cursor: pointer;
        }

        .filter-select:hover {
            border-color: #00bcd4;
        }

        .query-button, .export-button {
            background-color: #00bcd4;
            border: none;
            color: #1a2a3a;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .query-button:hover, .export-button:hover {
            background-color: #00acc1;
            transform: translateY(-1px);
        }

        .export-button {
            background-color: #3c5472;
            color: #e0e6ed;
        }

        .export-button:hover {
            background-color: #4a6a8a;
        }

        /* 变压器概览卡片 */
        .transformer-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .transformer-card {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .transformer-card:hover {
            border-color: #00bcd4;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 188, 212, 0.2);
        }

        .transformer-card.active {
            border-color: #00bcd4;
            background-color: #1e2d3f;
            box-shadow: 0 0 0 2px rgba(0, 188, 212, 0.3);
        }

        .transformer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-color, #00bcd4);
            border-radius: 8px 0 0 8px;
        }

        .transformer-name {
            font-size: 16px;
            color: #e0e6ed;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .transformer-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-label {
            font-size: 12px;
            color: #a7bed3;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 18px;
            color: #e0e6ed;
            font-weight: bold;
        }

        .load-rate-indicator {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #3c5472;
        }

        .load-rate-bar {
            width: 100%;
            height: 8px;
            background-color: #1a2a3a;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .load-rate-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .load-rate-fill.low {
            background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%);
        }

        .load-rate-fill.optimal {
            background: linear-gradient(90deg, #00bcd4 0%, #26c6da 100%);
        }

        .load-rate-fill.high {
            background: linear-gradient(90deg, #ff9800 0%, #ffb74d 100%);
        }

        .load-rate-fill.overload {
            background: linear-gradient(90deg, #f44336 0%, #e57373 100%);
        }

        .load-rate-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .load-rate-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--load-rate-color, #00bcd4);
        }

        .load-rate-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: rgba(0, 188, 212, 0.1);
            color: #00bcd4;
        }

        /* 图表区域 */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-panel {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
        }

        .chart-title {
            font-size: 16px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            padding: 10px;
        }

        .chart-container svg {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            display: block;
            box-sizing: border-box;
        }

        /* 经济性分析 */
        .economic-analysis {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .analysis-item {
            background-color: #1a2a3a;
            border: 1px solid #3c5472;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }

        .analysis-label {
            font-size: 13px;
            color: #a7bed3;
            margin-bottom: 8px;
        }

        .analysis-value {
            font-size: 24px;
            font-weight: bold;
            color: #e0e6ed;
            margin-bottom: 4px;
        }

        .analysis-unit {
            font-size: 12px;
            color: #5d7d9a;
        }

        .analysis-trend {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .analysis-trend.positive {
            color: #4caf50;
        }

        .analysis-trend.negative {
            color: #f44336;
        }

        /* 下端设备列表 */
        .device-list-section {
            background-color: #2a3d54;
            border: 1px solid #3c5472;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            color: #e0e6ed;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
        }

        .device-table th {
            background-color: #1a2a3a;
            color: #a7bed3;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: normal;
            border-bottom: 2px solid #3c5472;
        }

        .device-table td {
            padding: 12px;
            color: #e0e6ed;
            font-size: 13px;
            border-bottom: 1px solid #3c5472;
        }

        .device-table tr:hover {
            background-color: #1e2d3f;
        }

        .power-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .power-badge.normal {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .power-badge.high {
            background-color: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5d7d9a;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>

    <div class="page-header">
        <h2 class="page-title"><i class="fas fa-bolt"></i> 变压器负载率分析</h2>
    </div>

    <!-- 筛选区域 -->
    <div class="filter-section">
        <div class="filter-row">
            <div class="filter-item">
                <label>时间范围:</label>
                <select id="time-range" class="filter-select">
                    <option value="today" selected>今日</option>
                    <option value="yesterday">昨日</option>
                    <option value="week">本周</option>
                    <option value="month">本月</option>
                    <option value="custom">自定义</option>
                </select>
            </div>
            <div class="filter-item" id="custom-date-range" style="display: none;">
                <label>开始日期:</label>
                <input type="date" id="start-date" class="filter-select">
                <label>结束日期:</label>
                <input type="date" id="end-date" class="filter-select">
            </div>
            <div class="filter-item">
                <label>站点:</label>
                <select id="site-select" class="filter-select">
                    <option value="all">全部站点</option>
                    <option value="site1">生产车间1</option>
                    <option value="site2">生产车间2</option>
                    <option value="site3">办公楼</option>
                    <option value="site4">辅助设施</option>
                    <option value="site5">生产车间3</option>
                    <option value="site6">仓储物流</option>
                    <option value="site7">研发中心</option>
                    <option value="site8">生活配套区</option>
                </select>
            </div>
            <div class="filter-item">
                <button class="query-button" id="query-btn">
                    <i class="fas fa-search"></i> 查询
                </button>
                <button class="export-button" id="export-btn">
                    <i class="fas fa-download"></i> 导出
                </button>
            </div>
        </div>
    </div>

    <!-- 变压器概览卡片 -->
    <div class="transformer-overview" id="transformer-overview">
        <!-- 变压器卡片将通过JavaScript动态生成 -->
    </div>

    <!-- 图表区域 -->
    <div class="charts-section">
        <!-- 负载率趋势图 -->
        <div class="chart-panel">
            <h3 class="chart-title">
                <i class="fas fa-chart-line"></i> 负载率趋势
            </h3>
            <div class="chart-container" id="load-trend-chart">
                <div class="empty-state">
                    <i class="fas fa-chart-line"></i>
                    <p>请选择变压器查看负载率趋势</p>
                </div>
            </div>
        </div>

        <!-- 负载率分布图 -->
        <div class="chart-panel">
            <h3 class="chart-title">
                <i class="fas fa-chart-pie"></i> 负载率分布
            </h3>
            <div class="chart-container" id="load-distribution-chart">
                <div class="empty-state">
                    <i class="fas fa-chart-pie"></i>
                    <p>请选择变压器查看负载率分布</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 经济性分析 -->
    <div class="economic-analysis">
        <h3 class="section-title">
            <i class="fas fa-calculator"></i> 经济性分析
        </h3>
        <div class="analysis-grid" id="economic-analysis-grid">
            <!-- 经济性分析数据将通过JavaScript动态生成 -->
        </div>
    </div>

    <!-- 下端设备列表 -->
    <div class="device-list-section">
        <h3 class="section-title">
            <i class="fas fa-plug"></i> 下端设备列表
        </h3>
        <table class="device-table" id="device-table">
            <thead>
                <tr>
                    <th>设备名称</th>
                    <th>设备类型</th>
                    <th>视在功率(kVA)</th>
                    <th>有功功率(kW)</th>
                    <th>功率因数</th>
                    <th>运行状态</th>
                    <th>占比(%)</th>
                </tr>
            </thead>
            <tbody id="device-table-body">
                <!-- 表格数据将通过JavaScript动态生成 -->
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
// 每次页面加载时都重新初始化，确保数据不会被其他页面影响
// 清除可能存在的旧数据
if (window.__transformerLoadModuleLoaded) {
    // 如果已加载，清除旧状态并重新初始化
    window.__transformerLoadModuleLoaded = false;
    if (window.selectedTransformer !== undefined) {
        window.selectedTransformer = null;
    }
    if (window.transformerCurrentData !== undefined) {
        window.transformerCurrentData = null;
    }
}
window.__transformerLoadModuleLoaded = true;

// 每次页面加载时都重新初始化数据，确保数据不会被其他页面影响
const transformerLoadProfiles = {
    1: [68, 66, 64, 62, 60, 58, 60, 70, 78, 84, 88, 92, 94, 92, 88, 85, 82, 80, 78, 76, 73, 70, 68, 66],
    2: [55, 54, 53, 52, 51, 50, 52, 60, 70, 76, 80, 84, 86, 84, 80, 76, 72, 68, 64, 62, 60, 58, 56, 55],
    3: [38, 36, 35, 34, 33, 32, 34, 40, 50, 58, 62, 64, 66, 64, 60, 56, 52, 48, 44, 42, 40, 38, 36, 35],
    4: [75, 73, 72, 70, 68, 66, 70, 78, 85, 90, 94, 96, 98, 96, 92, 90, 88, 85, 82, 80, 78, 76, 74, 72],
    5: [52, 50, 48, 47, 46, 45, 50, 60, 72, 78, 81, 84, 85, 83, 80, 78, 75, 70, 68, 66, 64, 60, 58, 55],
    6: [72, 70, 68, 66, 64, 62, 65, 75, 82, 88, 91, 93, 95, 93, 90, 87, 84, 81, 78, 76, 74, 71, 69, 67],
    7: [45, 43, 41, 40, 39, 38, 40, 48, 58, 65, 69, 72, 74, 72, 68, 64, 60, 56, 52, 50, 48, 46, 44, 42],
    8: [82, 80, 78, 76, 74, 72, 75, 82, 88, 92, 95, 97, 98, 96, 94, 92, 90, 88, 86, 84, 82, 80, 78, 76],
    9: [58, 56, 54, 53, 52, 51, 54, 63, 73, 79, 83, 86, 87, 85, 81, 77, 73, 69, 65, 63, 61, 59, 57, 55],
    10: [35, 33, 32, 31, 30, 29, 31, 37, 45, 52, 56, 59, 61, 59, 55, 51, 47, 43, 39, 37, 35, 33, 32, 31]
};

// 变压器数据（示例）
let transformerData = [
    {
        id: 1,
        name: '1#变压器',
        site: '生产车间1',
        ratedCapacity: 1000, // kVA
        currentLoad: 750, // kVA
        loadRate: 75,
        status: 'optimal',
        hourlyLoadRates: transformerLoadProfiles[1],
        devices: [
            { name: '主电机1', type: '电机', apparentPower: 200, activePower: 180, powerFactor: 0.9, status: '运行', proportion: 26.7 },
            { name: '主电机2', type: '电机', apparentPower: 180, activePower: 162, powerFactor: 0.9, status: '运行', proportion: 24.0 },
            { name: '辅助设备', type: '其他', apparentPower: 150, activePower: 135, powerFactor: 0.9, status: '运行', proportion: 20.0 },
            { name: '照明系统', type: '照明', apparentPower: 100, activePower: 95, powerFactor: 0.95, status: '运行', proportion: 13.3 },
            { name: '空压机', type: '压缩机', apparentPower: 120, activePower: 108, powerFactor: 0.9, status: '运行', proportion: 16.0 }
        ]
    },
    {
        id: 2,
        name: '2#变压器',
        site: '生产车间2',
        ratedCapacity: 800,
        currentLoad: 640,
        loadRate: 80,
        status: 'optimal',
        hourlyLoadRates: transformerLoadProfiles[2],
        devices: [
            { name: '生产线电机', type: '电机', apparentPower: 300, activePower: 270, powerFactor: 0.9, status: '运行', proportion: 46.9 },
            { name: '冷却系统', type: '风机', apparentPower: 150, activePower: 135, powerFactor: 0.9, status: '运行', proportion: 23.4 },
            { name: '控制系统', type: '其他', apparentPower: 100, activePower: 95, powerFactor: 0.95, status: '运行', proportion: 15.6 },
            { name: '照明系统', type: '照明', apparentPower: 90, activePower: 85, powerFactor: 0.95, status: '运行', proportion: 14.1 }
        ]
    },
    {
        id: 3,
        name: '3#变压器',
        site: '办公楼',
        ratedCapacity: 500,
        currentLoad: 300,
        loadRate: 60,
        status: 'low',
        hourlyLoadRates: transformerLoadProfiles[3],
        devices: [
            { name: '空调系统', type: '空调', apparentPower: 150, activePower: 135, powerFactor: 0.9, status: '运行', proportion: 50.0 },
            { name: '照明系统', type: '照明', apparentPower: 80, activePower: 76, powerFactor: 0.95, status: '运行', proportion: 26.7 },
            { name: '办公设备', type: '其他', apparentPower: 70, activePower: 66, powerFactor: 0.95, status: '运行', proportion: 23.3 }
        ]
    },
    {
        id: 4,
        name: '4#变压器',
        site: '辅助设施',
        ratedCapacity: 630,
        currentLoad: 567,
        loadRate: 90,
        status: 'high',
        hourlyLoadRates: transformerLoadProfiles[4],
        devices: [
            { name: '水泵系统', type: '水泵', apparentPower: 200, activePower: 180, powerFactor: 0.9, status: '运行', proportion: 35.3 },
            { name: '风机系统', type: '风机', apparentPower: 180, activePower: 162, powerFactor: 0.9, status: '运行', proportion: 31.7 },
            { name: '其他设备', type: '其他', apparentPower: 187, activePower: 168, powerFactor: 0.9, status: '运行', proportion: 33.0 }
        ]
    },
    {
        id: 5,
        name: '5#变压器',
        site: '仓储物流',
        ratedCapacity: 750,
        currentLoad: 525,
        loadRate: 70,
        status: 'optimal',
        hourlyLoadRates: transformerLoadProfiles[5],
        devices: [
            { name: '堆垛机组', type: '物流设备', apparentPower: 180, activePower: 165, powerFactor: 0.92, status: '运行', proportion: 34.3 },
            { name: '立体仓储系统', type: '控制设备', apparentPower: 150, activePower: 138, powerFactor: 0.92, status: '运行', proportion: 28.6 },
            { name: '冷链空调', type: '空调', apparentPower: 110, activePower: 99, powerFactor: 0.9, status: '运行', proportion: 21.0 },
            { name: '照明与叉车充电', type: '其他', apparentPower: 85, activePower: 78, powerFactor: 0.92, status: '运行', proportion: 16.1 }
        ]
    },
    {
        id: 6,
        name: '6#变压器',
        site: '生产车间3',
        ratedCapacity: 1250,
        currentLoad: 900,
        loadRate: 72,
        status: 'optimal',
        hourlyLoadRates: transformerLoadProfiles[6],
        devices: [
            { name: '注塑机主电机', type: '电机', apparentPower: 350, activePower: 315, powerFactor: 0.9, status: '运行', proportion: 38.9 },
            { name: '冷却循环泵', type: '水泵', apparentPower: 220, activePower: 198, powerFactor: 0.9, status: '运行', proportion: 24.4 },
            { name: '机械手系统', type: '控制设备', apparentPower: 180, activePower: 162, powerFactor: 0.9, status: '运行', proportion: 20.0 },
            { name: '辅助设备组', type: '其他', apparentPower: 150, activePower: 135, powerFactor: 0.9, status: '运行', proportion: 16.7 }
        ]
    },
    {
        id: 7,
        name: '7#变压器',
        site: '研发中心',
        ratedCapacity: 400,
        currentLoad: 180,
        loadRate: 45,
        status: 'low',
        hourlyLoadRates: transformerLoadProfiles[7],
        devices: [
            { name: '实验设备', type: '其他', apparentPower: 80, activePower: 72, powerFactor: 0.9, status: '运行', proportion: 44.4 },
            { name: '精密空调', type: '空调', apparentPower: 60, activePower: 54, powerFactor: 0.9, status: '运行', proportion: 33.3 },
            { name: '照明系统', type: '照明', apparentPower: 40, activePower: 38, powerFactor: 0.95, status: '运行', proportion: 22.2 }
        ]
    },
    {
        id: 8,
        name: '8#变压器',
        site: '辅助设施',
        ratedCapacity: 1000,
        currentLoad: 820,
        loadRate: 82,
        status: 'high',
        hourlyLoadRates: transformerLoadProfiles[8],
        devices: [
            { name: '空压站主空压机', type: '压缩机', apparentPower: 320, activePower: 288, powerFactor: 0.9, status: '运行', proportion: 39.0 },
            { name: '冷却塔风机', type: '风机', apparentPower: 250, activePower: 225, powerFactor: 0.9, status: '运行', proportion: 30.5 },
            { name: '锅炉给水泵', type: '水泵', apparentPower: 150, activePower: 135, powerFactor: 0.9, status: '运行', proportion: 18.3 },
            { name: '其他辅助设备', type: '其他', apparentPower: 100, activePower: 90, powerFactor: 0.9, status: '运行', proportion: 12.2 }
        ]
    },
    {
        id: 9,
        name: '9#变压器',
        site: '生产车间2',
        ratedCapacity: 900,
        currentLoad: 522,
        loadRate: 58,
        status: 'optimal',
        hourlyLoadRates: transformerLoadProfiles[9],
        devices: [
            { name: '包装线电机', type: '电机', apparentPower: 200, activePower: 180, powerFactor: 0.9, status: '运行', proportion: 38.3 },
            { name: '输送带系统', type: '其他', apparentPower: 150, activePower: 135, powerFactor: 0.9, status: '运行', proportion: 28.7 },
            { name: '分拣设备', type: '控制设备', apparentPower: 100, activePower: 90, powerFactor: 0.9, status: '运行', proportion: 19.2 },
            { name: '照明与通风', type: '照明', apparentPower: 72, activePower: 68, powerFactor: 0.95, status: '运行', proportion: 13.8 }
        ]
    },
    {
        id: 10,
        name: '10#变压器',
        site: '生活配套区',
        ratedCapacity: 315,
        currentLoad: 110,
        loadRate: 35,
        status: 'low',
        hourlyLoadRates: transformerLoadProfiles[10],
        devices: [
            { name: '宿舍空调', type: '空调', apparentPower: 50, activePower: 45, powerFactor: 0.9, status: '运行', proportion: 45.5 },
            { name: '食堂设备', type: '其他', apparentPower: 35, activePower: 32, powerFactor: 0.92, status: '运行', proportion: 31.8 },
            { name: '公共照明', type: '照明', apparentPower: 25, activePower: 24, powerFactor: 0.95, status: '运行', proportion: 22.7 }
        ]
    }
];

let selectedTransformer = null;
let transformerCurrentData = null;

// 初始化
function initTransformerLoad() {
    // 重置状态
    selectedTransformer = null;
    transformerCurrentData = null;
    
    // 重新渲染
    renderTransformerCards();
    updateDeviceTable();
    
    // 默认选择第一个变压器
    if (transformerData.length > 0) {
        selectTransformer(transformerData[0].id);
    }
}

// 渲染变压器卡片
function renderTransformerCards() {
    const container = document.getElementById('transformer-overview');
    if (!container) return;
    
    const siteSelect = document.getElementById('site-select');
    const siteFilter = siteSelect ? siteSelect.value : 'all';
    
    let filteredData = transformerData;
    if (siteFilter !== 'all') {
        const siteMap = {
            'site1': '生产车间1',
            'site2': '生产车间2',
            'site3': '办公楼',
            'site4': '辅助设施',
            'site5': '生产车间3',
            'site6': '仓储物流',
            'site7': '研发中心',
            'site8': '生活配套区'
        };
        const targetSite = siteMap[siteFilter];
        if (targetSite) {
            filteredData = transformerData.filter(t => t.site === targetSite);
        }
    }
    
    if (filteredData.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>暂无变压器数据</p></div>';
        return;
    }
    
    container.innerHTML = filteredData.map(t => {
        const loadRateClass = getLoadRateClass(t.loadRate);
        const statusText = getStatusText(t.loadRate);
        const statusColor = getStatusColor(t.loadRate);
        
        return `
            <div class="transformer-card ${selectedTransformer === t.id ? 'active' : ''}" 
                 onclick="selectTransformer(${t.id})"
                 style="--accent-color: ${statusColor}; --load-rate-color: ${statusColor};">
                <div class="transformer-name">
                    <i class="fas fa-bolt"></i>
                    ${t.name}
                </div>
                <div class="transformer-stats">
                    <div class="stat-item">
                        <div class="stat-label">额定容量</div>
                        <div class="stat-value">${t.ratedCapacity} kVA</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">当前负载</div>
                        <div class="stat-value">${t.currentLoad} kVA</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">站点</div>
                        <div class="stat-value" style="font-size: 14px;">${t.site}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">设备数量</div>
                        <div class="stat-value">${t.devices.length} 台</div>
                    </div>
                </div>
                <div class="load-rate-indicator">
                    <div class="load-rate-bar">
                        <div class="load-rate-fill ${loadRateClass}" style="width: ${Math.min(t.loadRate, 100)}%;"></div>
                    </div>
                    <div class="load-rate-text">
                        <span class="load-rate-value">${t.loadRate.toFixed(1)}%</span>
                        <span class="load-rate-status">${statusText}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// 获取负载率等级
function getLoadRateClass(loadRate) {
    if (loadRate < 30) return 'low';
    if (loadRate < 70) return 'optimal';
    if (loadRate < 90) return 'high';
    return 'overload';
}

// 获取状态文本
function getStatusText(loadRate) {
    if (loadRate < 30) return '低负载';
    if (loadRate < 70) return '经济运行';
    if (loadRate < 90) return '高负载';
    return '过载风险';
}

// 获取状态颜色
function getStatusColor(loadRate) {
    if (loadRate < 30) return '#4caf50';
    if (loadRate < 70) return '#00bcd4';
    if (loadRate < 90) return '#ff9800';
    return '#f44336';
}

// 选择变压器
function selectTransformer(transformerId) {
    selectedTransformer = transformerId;
    const transformer = transformerData.find(t => t.id === transformerId);
    if (!transformer) return;
    
    // 更新卡片显示
    renderTransformerCards();
    
    // 生成并显示图表数据
    generateChartData(transformer);
    
    // 更新设备表格
    updateDeviceTable(transformer);
    
    // 更新经济性分析
    updateEconomicAnalysis(transformer);
}

// 生成图表数据
function generateChartData(transformer) {
    let hourlyLoadRate;
    if (transformer.hourlyLoadRates && transformer.hourlyLoadRates.length === 24) {
        hourlyLoadRate = transformer.hourlyLoadRates.map((value, hour) => ({
            hour,
            loadRate: value,
            load: (value / 100) * transformer.ratedCapacity
        }));
    } else {
        hourlyLoadRate = Array.from({length: 24}, (_, hour) => {
            const baseLoad = transformer.loadRate;
            const variation = Math.sin((hour - 6) * Math.PI / 12) * 12;
            const loadRate = Math.max(0, Math.min(100, baseLoad + variation));
            return {
                hour,
                loadRate,
                load: (loadRate / 100) * transformer.ratedCapacity
            };
        });
    }
    
    const distributionData = generateDistributionData(hourlyLoadRate);
    
    transformerCurrentData = {
        transformer: transformer,
        hourlyLoadRate: hourlyLoadRate,
        distributionData: distributionData
    };
    
    // 渲染图表
    renderLoadTrendChart(hourlyLoadRate, transformer);
    renderLoadDistributionChart(distributionData, transformer);
}

// 生成负载率分布数据
function generateDistributionData(hourlyData) {
    const intervals = [
        { label: '0-30%', min: 0, max: 30, count: 0 },
        { label: '30-50%', min: 30, max: 50, count: 0 },
        { label: '50-70%', min: 50, max: 70, count: 0 },
        { label: '70-90%', min: 70, max: 90, count: 0 },
        { label: '90-100%', min: 90, max: 100, count: 0 }
    ];
    
    hourlyData.forEach(data => {
        const interval = intervals.find(i => data.loadRate >= i.min && data.loadRate < i.max);
        if (interval) {
            interval.count++;
        } else if (data.loadRate === 100) {
            intervals[4].count++;
        }
    });
    
    return intervals;
}

// 渲染负载率趋势图
function renderLoadTrendChart(data, transformer) {
    const container = document.getElementById('load-trend-chart');
    if (!container) return;
    const containerWidth = container.offsetWidth || container.clientWidth || 800;
    const containerHeight = 400;
    const padding = 70;
    const width = Math.max(containerWidth - 20, 600);
    const height = containerHeight - 20;
    const chartWidth = width - padding * 2;
    const chartHeight = height - padding * 2 - 30;
    
    const maxLoadRate = 100;
    const svgWidth = width;
    const svgHeight = height;
    
    let svg = `
        <svg width="100%" height="100%" viewBox="0 0 ${svgWidth} ${svgHeight}" preserveAspectRatio="xMidYMid meet" style="max-width: 100%;">
            <defs>
                <linearGradient id="loadTrendGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#00bcd4;stop-opacity:0.8" />
                    <stop offset="100%" style="stop-color:#00bcd4;stop-opacity:0.1" />
                </linearGradient>
            </defs>
            
            <!-- 网格线 -->
            ${Array.from({length: 5}, (_, i) => {
                const y = padding + (chartHeight / 4) * i;
                return `<line x1="${padding}" y1="${y}" x2="${svgWidth - padding}" y2="${y}" stroke="#3c5472" stroke-width="0.5" opacity="0.5"/>`;
            }).join('')}
            
            <!-- Y轴标签 -->
            ${Array.from({length: 5}, (_, i) => {
                const y = padding + (chartHeight / 4) * i;
                const value = maxLoadRate - (maxLoadRate / 4) * i;
                return `<text x="${padding - 15}" y="${y + 5}" fill="#a7bed3" font-size="11" text-anchor="end">${value}%</text>`;
            }).join('')}
            
            <!-- 数据区域填充 -->
            <polygon points="${data.map((d, i) => {
                const x = padding + (chartWidth / (data.length - 1 || 1)) * i;
                const y = padding + chartHeight - (d.loadRate / maxLoadRate) * chartHeight;
                return `${x},${y}`;
            }).join(' ')} ${svgWidth - padding},${padding + chartHeight} ${padding},${padding + chartHeight}" 
                fill="url(#loadTrendGradient)"/>
            
            <!-- 趋势线 -->
            <polyline points="${data.map((d, i) => {
                const x = padding + (chartWidth / (data.length - 1 || 1)) * i;
                const y = padding + chartHeight - (d.loadRate / maxLoadRate) * chartHeight;
                return `${x},${y}`;
            }).join(' ')}" 
                fill="none" stroke="#00bcd4" stroke-width="3"/>
            
            <!-- 数据点 -->
            ${data.map((d, i) => {
                const x = padding + (chartWidth / (data.length - 1 || 1)) * i;
                const y = padding + chartHeight - (d.loadRate / maxLoadRate) * chartHeight;
                return `<circle cx="${x}" cy="${y}" r="4" fill="#00bcd4" stroke="#1a2a3a" stroke-width="2">
                    <title>${String(d.hour).padStart(2, '0')}:00 - 负载率: ${d.loadRate.toFixed(1)}% (${d.load.toFixed(0)} kVA)</title>
                </circle>`;
            }).join('')}
            
            <!-- X轴标签 -->
            ${data.filter((d, i) => i % 3 === 0 || i === data.length - 1).map((d, i) => {
                const index = data.findIndex(item => item === d);
                const x = padding + (chartWidth / (data.length - 1 || 1)) * index;
                return `<text x="${x}" y="${padding + chartHeight + 25}" fill="#a7bed3" font-size="11" text-anchor="middle">${String(d.hour).padStart(2, '0')}:00</text>`;
            }).join('')}
            
            <!-- 标题 -->
            <text x="${svgWidth / 2}" y="25" fill="#e0e6ed" font-size="14" font-weight="bold" text-anchor="middle">${transformer.name}</text>
        </svg>
    `;
    
    container.innerHTML = svg;
}

// 渲染负载率分布图
function renderLoadDistributionChart(data, transformer) {
    const container = document.getElementById('load-distribution-chart');
    if (!container) return;
    const containerWidth = container.offsetWidth || container.clientWidth || 800;
    const containerHeight = 400;
    const padding = 70;
    const width = Math.max(containerWidth - 20, 600);
    const height = containerHeight - 20;
    const chartWidth = width - padding * 2;
    const chartHeight = height - padding * 2 - 30;
    
    const maxCount = Math.max(...data.map(d => d.count), 1);
    const svgWidth = width;
    const svgHeight = height;
    
    const colors = ['#4caf50', '#00bcd4', '#ff9800', '#f44336', '#9c27b0'];
    
    let svg = `
        <svg width="100%" height="100%" viewBox="0 0 ${svgWidth} ${svgHeight}" preserveAspectRatio="xMidYMid meet" style="max-width: 100%;">
            <!-- 网格线 -->
            ${Array.from({length: 5}, (_, i) => {
                const y = padding + (chartHeight / 4) * i;
                return `<line x1="${padding}" y1="${y}" x2="${svgWidth - padding}" y2="${y}" stroke="#3c5472" stroke-width="0.5" opacity="0.5"/>`;
            }).join('')}
            
            <!-- Y轴标签 -->
            ${Array.from({length: 5}, (_, i) => {
                const y = padding + (chartHeight / 4) * i;
                const value = maxCount - (maxCount / 4) * i;
                return `<text x="${padding - 15}" y="${y + 5}" fill="#a7bed3" font-size="11" text-anchor="end">${value.toFixed(0)}h</text>`;
            }).join('')}
            
            <!-- 柱状图 -->
            ${data.map((d, i) => {
                const barWidth = chartWidth / data.length * 0.8;
                const x = padding + (chartWidth / data.length) * i + (chartWidth / data.length) * 0.1;
                const barHeight = (d.count / maxCount) * chartHeight;
                const y = padding + chartHeight - barHeight;
                
                return `
                    <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                        fill="${colors[i % colors.length]}" opacity="0.8">
                        <title>${d.label}: ${d.count}小时</title>
                    </rect>
                `;
            }).join('')}
            
            <!-- X轴标签 -->
            ${data.map((d, i) => {
                const x = padding + (chartWidth / data.length) * i + (chartWidth / data.length) / 2;
                return `<text x="${x}" y="${padding + chartHeight + 25}" fill="#a7bed3" font-size="10" text-anchor="middle">${d.label}</text>`;
            }).join('')}
            
            <!-- 标题 -->
            <text x="${svgWidth / 2}" y="25" fill="#e0e6ed" font-size="14" font-weight="bold" text-anchor="middle">${transformer.name}</text>
        </svg>
    `;
    
    container.innerHTML = svg;
}

// 更新设备表格
function updateDeviceTable(transformer = null) {
    const tbody = document.getElementById('device-table-body');
    
    if (!transformer) {
        transformer = transformerData.find(t => t.id === selectedTransformer);
    }
    
    if (!transformer) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #a7bed3; padding: 40px;">
                    请选择变压器查看下端设备
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = transformer.devices.map(device => {
        const powerClass = device.apparentPower > transformer.ratedCapacity * 0.2 ? 'high' : 'normal';
        return `
            <tr>
                <td>${device.name}</td>
                <td>${device.type}</td>
                <td>${device.apparentPower.toFixed(2)}</td>
                <td>${device.activePower.toFixed(2)}</td>
                <td>${device.powerFactor.toFixed(2)}</td>
                <td><span class="power-badge ${powerClass}">${device.status}</span></td>
                <td>${device.proportion.toFixed(1)}%</td>
            </tr>
        `;
    }).join('');
}

// 更新经济性分析
function updateEconomicAnalysis(transformer) {
    const container = document.getElementById('economic-analysis-grid');
    
    // 计算经济性指标
    const avgLoadRate = transformer.loadRate;
    const utilizationRate = avgLoadRate / 100;
    const economicScore = calculateEconomicScore(avgLoadRate);
    const recommendedCapacity = calculateRecommendedCapacity(transformer);
    
    container.innerHTML = `
        <div class="analysis-item">
            <div class="analysis-label">平均负载率</div>
            <div class="analysis-value">${avgLoadRate.toFixed(1)}%</div>
            <div class="analysis-unit">当前负载 / 额定容量</div>
            <div class="analysis-trend ${avgLoadRate >= 70 && avgLoadRate <= 85 ? 'positive' : 'negative'}">
                <i class="fas fa-${avgLoadRate >= 70 && avgLoadRate <= 85 ? 'check' : 'exclamation-triangle'}"></i>
                <span>${avgLoadRate >= 70 && avgLoadRate <= 85 ? '经济运行' : avgLoadRate < 70 ? '负载偏低' : '负载偏高'}</span>
            </div>
        </div>
        <div class="analysis-item">
            <div class="analysis-label">利用率</div>
            <div class="analysis-value">${(utilizationRate * 100).toFixed(1)}%</div>
            <div class="analysis-unit">设备利用效率</div>
            <div class="analysis-trend ${utilizationRate >= 0.7 && utilizationRate <= 0.85 ? 'positive' : 'negative'}">
                <i class="fas fa-${utilizationRate >= 0.7 && utilizationRate <= 0.85 ? 'arrow-up' : 'arrow-down'}"></i>
                <span>${utilizationRate >= 0.7 && utilizationRate <= 0.85 ? '良好' : '需优化'}</span>
            </div>
        </div>
        <div class="analysis-item">
            <div class="analysis-label">经济性评分</div>
            <div class="analysis-value">${economicScore.toFixed(1)}</div>
            <div class="analysis-unit">满分100分</div>
            <div class="analysis-trend ${economicScore >= 80 ? 'positive' : 'negative'}">
                <i class="fas fa-${economicScore >= 80 ? 'star' : 'star-half'}"></i>
                <span>${economicScore >= 80 ? '优秀' : economicScore >= 60 ? '良好' : '一般'}</span>
            </div>
        </div>
        <div class="analysis-item">
            <div class="analysis-label">建议容量</div>
            <div class="analysis-value">${recommendedCapacity}</div>
            <div class="analysis-unit">kVA</div>
            <div class="analysis-trend ${recommendedCapacity === transformer.ratedCapacity ? 'positive' : 'negative'}">
                <i class="fas fa-${recommendedCapacity === transformer.ratedCapacity ? 'check-circle' : 'info-circle'}"></i>
                <span>${recommendedCapacity === transformer.ratedCapacity ? '容量合适' : '建议调整'}</span>
            </div>
        </div>
    `;
}

// 计算经济性评分
function calculateEconomicScore(loadRate) {
    // 经济运行区间：70-85%
    if (loadRate >= 70 && loadRate <= 85) {
        return 100 - Math.abs(loadRate - 77.5) * 2; // 77.5%为最佳点
    } else if (loadRate >= 50 && loadRate < 70) {
        return 60 + (loadRate - 50) * 2; // 50-70%区间评分
    } else if (loadRate > 85 && loadRate <= 95) {
        return 100 - (loadRate - 85) * 4; // 85-95%区间评分
    } else {
        return Math.max(0, 100 - Math.abs(loadRate - 77.5) * 3); // 其他区间
    }
}

// 计算建议容量
function calculateRecommendedCapacity(transformer) {
    const avgLoad = transformer.currentLoad;
    // 建议容量为平均负载的1.2-1.4倍（经济运行区间）
    const recommended = Math.ceil(avgLoad * 1.3 / 50) * 50; // 向上取整到50的倍数
    return recommended;
}

// 事件监听
function bindTransformerLoadEvents() {
    // 查询按钮
    const queryBtn = document.getElementById('query-btn');
    if (queryBtn && !queryBtn.dataset.bound) {
        queryBtn.dataset.bound = 'true';
        queryBtn.addEventListener('click', function() {
            renderTransformerCards();
            if (selectedTransformer) {
                const transformer = transformerData.find(t => t.id === selectedTransformer);
                if (transformer) {
                    generateChartData(transformer);
                    updateDeviceTable(transformer);
                    updateEconomicAnalysis(transformer);
                }
            } else if (transformerData.length > 0) {
                // 如果没有选中，选择第一个
                selectTransformer(transformerData[0].id);
            }
        });
    }
    
    // 时间范围选择
    const timeRangeSelect = document.getElementById('time-range');
    if (timeRangeSelect && !timeRangeSelect.dataset.bound) {
        timeRangeSelect.dataset.bound = 'true';
        timeRangeSelect.addEventListener('change', function() {
            const customRange = document.getElementById('custom-date-range');
            if (customRange) {
                customRange.style.display = this.value === 'custom' ? 'flex' : 'none';
            }
        });
    }
    
    // 站点筛选
    const siteSelect = document.getElementById('site-select');
    if (siteSelect && !siteSelect.dataset.bound) {
        siteSelect.dataset.bound = 'true';
        siteSelect.addEventListener('change', function() {
            renderTransformerCards();
            // 如果当前选中的变压器被过滤掉了，选择第一个可见的
            if (selectedTransformer) {
                const filteredData = getFilteredTransformerData();
                const currentSelected = filteredData.find(t => t.id === selectedTransformer);
                if (!currentSelected && filteredData.length > 0) {
                    selectTransformer(filteredData[0].id);
                } else if (currentSelected) {
                    // 重新生成图表数据
                    generateChartData(currentSelected);
                    updateDeviceTable(currentSelected);
                    updateEconomicAnalysis(currentSelected);
                }
            } else if (filteredData.length > 0) {
                selectTransformer(filteredData[0].id);
            }
        });
    }
    
    // 导出按钮
    const exportBtn = document.getElementById('export-btn');
    if (exportBtn && !exportBtn.dataset.bound) {
        exportBtn.dataset.bound = 'true';
        exportBtn.addEventListener('click', function() {
            alert('导出功能待实现');
        });
    }
}

// 获取筛选后的变压器数据
function getFilteredTransformerData() {
    const siteFilter = document.getElementById('site-select')?.value || 'all';
    let filteredData = transformerData;
    if (siteFilter !== 'all') {
        const siteMap = {
            'site1': '生产车间1',
            'site2': '生产车间2',
            'site3': '办公楼',
            'site4': '辅助设施',
            'site5': '生产车间3',
            'site6': '仓储物流',
            'site7': '研发中心',
            'site8': '生活配套区'
        };
        const targetSite = siteMap[siteFilter];
        if (targetSite) {
            filteredData = transformerData.filter(t => t.site === targetSite);
        }
    }
    return filteredData;
}

// 确保在动态加载时也能初始化
function ensureInit() {
    if (document.getElementById('transformer-overview')) {
        initTransformerLoad();
        bindTransformerLoadEvents();
    } else {
        // 如果DOM还没准备好，延迟重试
        setTimeout(ensureInit, 50);
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureInit);
} else {
    ensureInit();
}

window.initTransformerLoad = initTransformerLoad;
window.selectTransformer = selectTransformer;
})();
</script>
